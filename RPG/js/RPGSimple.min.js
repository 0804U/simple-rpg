function saveState(a){window.localStorage.setItem("gameState",JSON.stringify(a))}function restoreState(){var a=window.localStorage.getItem("gameState");return a?JSON.parse(a):null}var BasicGame={},gameInit={init:function(a,b){void 0==b&&(b="gameContainer");var c=new Phaser.Game(900,600,Phaser.AUTO,b);c.state.add("Boot",BasicGame.Boot),c.state.add("Preloader",BasicGame.Preloader),c.state.add("MainMenu",BasicGame.MainMenu),c.state.add("Game",BasicGame.Game),c.state.add("Instructions",BasicGame.Instructions),c.state.add("MapSelect",BasicGame.MapSelect),c.state.add("LoadMap",BasicGame.LoadMap),c.state.start("Boot"),c.global=new Global,void 0!=a&&"en"!=a&&(c.global.language=a)}},EmptyState=function(){};EmptyState.prototype.update=function(){},EmptyState.prototype.render=function(){},EmptyState.prototype.onEnter=function(){},EmptyState.prototype.onExit=function(){};var AIDecide=function(a,b,c,d,e){this.game=a,this.gameref=b,this.combater=c,this.state=e,this.isReady=!0,this.isDone=!0,this.maxActions=2,this.enemyfocus=null};AIDecide.prototype.Update=function(){},AIDecide.prototype.execute=function(){if(this.combater.isAlive()&&this.maxActions>0){this.selectThis();var a=null,b=this.combater.weapons[0],c=!0,d=!0;if(b.range>1&&(c=this.gameref.map.hexHandler.lineOfSite(this.combater.currentTile,this.gameref.map.playerCharacter.currentTile)),c){var e=this.gameref.map.hexHandler.testRange(this.combater.currentTile,this.gameref.map.playerCharacter.currentTile,!1);e>60*b.range&&(d=!1)}var f=Math.random();a=.1>f?this.randomMove():c&&d?this.doAttack():this.moveToPlayer(),this.testEndOfTurn(),this.state.addToActionsFront(a)}else this.state.removeAction(this),this.state.moveOn(),this.gameref.toggleCombat()},AIDecide.prototype.selectPlayerToAttack=function(){},AIDecide.prototype.selectThis=function(){console.log("AI decide select.",this.combater),this.state.placeAtFront(this)},AIDecide.prototype.testEndOfTurn=function(){this.maxActions--,console.log("AI actions: ",this.maxActions),this.maxActions<=0&&this.state.removeAction(this)},AIDecide.prototype.cleanup=function(){},AIDecide.prototype.moveToPlayer=function(){var a;return a=new CombatAction(this.game,this.gameref,this.combater,this.gameref.map.playerCharacter,"move",this.state)},AIDecide.prototype.randomMove=function(){var a,b,c=this.combater.findWalkableFromCurrent();if(null!=c){var d=Math.floor(Math.random()*c.length);b=c[d][Math.floor(Math.random()*c[d].length)]}return a=new CombatAction(this.game,this.gameref,this.combater,b,"move",this.state)},AIDecide.prototype.doAttack=function(){var a,b;return this.combater.weapons.length>0&&(b=this.combater.weapons[0]),null!=b&&(a=new CombatAction(this.game,this.gameref,this.combater,this.gameref.map.playerCharacter,"shoot",this.state,[b])),a};var CombatAction=function(a,b,c,d,e,f,g){console.log("combataction  ",a,b,c,d,e,f,g),this.game=a,this.gameref=b,this.combater=c,this.action=e,this.state=f,this.params=g,this.isReady=!0,this.target=d};CombatAction.prototype.execute=function(){if(this.state.inputHandler.pauseInput=!0,console.log("Combat Action execute ",this.action),"move"==this.action)this.combater.moveToSpotCombat(this.target,[{func:this.doFinish,para:[],removeself:!1,callee:this,con:null,walkto:!1}],this.combater.movementspeed);else if("shoot"==this.action)this.combater.shootGun(this.target,this.params[0],{func:this.doFinish,callee:this},this,this.state);else if("useitem"==this.action)console.log(this.targe,this.params),this.combater.douse();else if("bullet"==this.action){var a=this.params[0],b=this.params[1],c=this.params[2];console.log("fire state",this.state),this.gameref.bulletHandler.fireBullet("combat_actionpoints0001.png",this,this.combater,this.target,{func:this.doFinish,callee:this},{weapon:a,acc:b,hit:c,state:this.state})}else this.doFinish()},CombatAction.prototype.cleanup=function(){},CombatAction.prototype.Update=function(){},CombatAction.prototype.addActionToState=function(a){this.state.placeAtFront(a)},CombatAction.prototype.doFinish=function(a){console.log("combat action: doFinish",a,this.state),null!=this.state&&(null!=a&&this.state.placeAtFront(a),this.state.removeAction(this),this.state.NextTick())};var PlayerDecide=function(a,b,c,d,e){this.game=a,this.gameref=b,this.combater=c,this.state=e,this.isReady=!0,this.isDone=!1,this.maxActions=2};PlayerDecide.prototype.Update=function(){},PlayerDecide.prototype.onEnter=function(){console.log("Playerdecide onEnter")},PlayerDecide.prototype.onExit=function(){console.log("Playerdecide onExit")},PlayerDecide.prototype.execute=function(){return console.log("Player decide execute.",this.maxActions),this.maxActions<1?void this.state.removeAction(this):(this.state.inputHandler.pauseInput=!1,this.state.statemachine.inputHandler.highlightplayer(this.combater),void this.selectThis())},PlayerDecide.prototype.selectThis=function(){console.log("Player decide select.",this.combater),this.state.placeAtFront(this)},PlayerDecide.prototype.cleanup=function(){},PlayerDecide.prototype.domove=function(a){action=new CombatAction(this.game,this.gameref,this.combater,a,"move",this.state),this.testEndOfTurn(),this.state.addToActionsFront(action)},PlayerDecide.prototype.dotouched=function(a){if(a.hostile){var b,c;this.combater.currentSelectedWeapon&&(c=this.combater.currentSelectedWeapon),console.log("weapon ",c),null!=c&&(b=new CombatAction(this.game,this.gameref,this.combater,a,"shoot",this.state,[c]),this.testEndOfTurn(),this.state.addToActionsFront(b))}},PlayerDecide.prototype.testEndOfTurn=function(){this.maxActions--,console.log("actions: ",this.maxActions),this.maxActions<=0&&this.state.removeAction(this)},PlayerDecide.prototype.endTurn=function(){action=new CombatAction(this.game,this.gameref,this.combater,this.combater,"nothing",this.state,[]),this.state.addToActionsFront(action)},PlayerDecide.prototype.usePower=function(){this.combater.currentSelectedWeapon&&(weapon=this.combater.currentSelectedWeapon),null!=weapon&&(action=new CombatAction(this.game,this.gameref,this.combater,this.combater,"useitem",this.state,[weapon]),this.testEndOfTurn(),this.state.addToActionsFront(action))};var Item=function(a){this.inventoryImg=a.movementspeed,this.buttonImg=a.shieldhp},Weapon=function(a){Item.call(this,a),this.weaponname=a.weaponname,this.dmg=a.dmg,this.range=a.range,this.acc=a.acc,this.clipsize=a.clipsize,this.AIPower=a.AIPower,this.attackType=a.attackType,this.powerType=a.powerType,this.type=a.type,this.cost=a.cost,this.cooldown=a.cooldown,this.description=a.description,this.onCooldown=!1,this.cooldownTimer=0};Weapon.prototype=Object.create(Item.prototype),Weapon.constructor=Weapon,Weapon.prototype.step=function(a){this.onCooldown&&(this.cooldownTimer-=a,this.cooldownTimer<=0&&(this.onCooldown=!1))},Weapon.prototype.use=function(){return this.onCooldown?!1:(this.onCooldown=!0,this.cooldownTimer=this.cooldown,!0)};var Condition=function(){this.logic="Any",this.list=[]},EventDispatcher=function(a,b,c){this.game=a,this.maingame=b,this.object=c,null!=c&&GlobalEvents.allEventDispatchers.push(this),this.actionArray=[]};EventDispatcher.prototype.receiveData=function(a){this.init(a)},EventDispatcher.prototype.testAction=function(){this.object&&(this.object.allowInputNow?this.object.allowInputNow(this.shouldBeActive()):this.object.allowInput=this.shouldBeActive())},EventDispatcher.prototype.shouldBeActive=function(){return this.object.IsPlayer?!0:GlobalEvents.currentAction==GlobalEvents.WALK?!1:GlobalEvents.currentAction==GlobalEvents.TOUCH&&this.actionArray.OnTouch?!0:GlobalEvents.currentAction==GlobalEvents.LOOK&&this.actionArray.OnLook?!0:GlobalEvents.currentAction==GlobalEvents.TALK&&this.actionArray.OnTalk?!0:GlobalEvents.currentAction==GlobalEvents.ITEM&&this.actionArray.OnUseItem?!0:GlobalEvents.currentAction==GlobalEvents.COMBATSELECT&&this.object.isCombatCharacter&&this.object.isAlive()?!0:!1},EventDispatcher.prototype.hasAction=function(a){return this.actionArray[a]?!0:!1},EventDispatcher.prototype.init=function(a){for(var b,c,d,e,f,g=0;g<a.length;g++)if(b=a[g],d=b.trigger,f=null,b.conditions&&(f=new Condition,"OnUseItem"==d&&f.list.push({special:!0,func:GlobalEvents.checkSelectItem,para:[b.itemid],callee:this}),b.conditions.conditions&&this.applyConditions(f,b.conditions)),b.actions)for(var h=0;h<b.actions.length;h++)c=b.actions[h],e=this.getEventType(d),this.setActions(e,c,b.once,f,b.walkto||!1)},EventDispatcher.prototype.helpSetActions=function(a,b,c,d){if(null!=b)for(var e=0;e<b.length;e++)null!=b[e]&&this.setActions(a,b[e],c,d,!1)},EventDispatcher.prototype.setActions=function(a,b,c,d,e){"ChangeMap"==b.type?a.push({func:this.maingame.map.userExit,para:[this.object,b],removeself:c,callee:this.maingame.map,con:d,walkto:e}):"CONVERSATION"==b.type?a.push({func:this.maingame.showDialog,para:[b.id],removeself:c,callee:this.maingame,con:d,walkto:e}):"SIMPLE"==b.type?a.push({func:this.maingame.textUIHandler.showJustText,para:[b.text],removeself:c,callee:this.maingame.textUIHandler,con:d,walkto:e}):"BARK"==b.type?a.push({func:this.maingame.textUIHandler.showBark,para:[this.object,b.text],removeself:c,callee:this.maingame.textUIHandler,con:d,walkto:e}):"THIS"==b.type?a.push(void 0!=b.gototype&&b.location?{func:this.object.callFunction,para:["moveToSpotByCoords",b.location.x+","+b.location.y],removeself:!1,callee:this.object,con:d,walkto:e}:{func:this.object.callFunction,para:[b["function"],b.parameters],removeself:!1,callee:this.object,con:d,walkto:e}):"Item"==b.type?a.push({func:this.maingame.globalHandler.updateItem,para:[b.name,b.mode,b.variable,b.value],removeself:!1,callee:this.maingame.globalHandler,con:d,walkto:e}):"Actor"==b.type?a.push({func:this.maingame.globalHandler.updateActor,para:[b.name,b.mode,b.variable,b.value],removeself:!1,callee:this.maingame.globalHandler,con:d,walkto:e}):"Variable"==b.type?a.push({func:this.maingame.globalHandler.updateVariableByID,para:[b.name,b.mode,b.value],removeself:!1,callee:this.maingame.globalHandler,con:d,walkto:e}):"GLOBAL"==b.type?a.push({func:this.maingame.callFunction,para:[b.variable,""],removeself:!1,callee:this.maingame,con:d,walkto:e}):"Activator"==b.type&&a.push({type:"Activator",func:null,para:[b["function"],b.parameters],removeself:!1,callee:null,con:d,walkto:e})},EventDispatcher.prototype.applyConditions=function(a,b){for(var c=b.conditions,d=b.logic,e=a.list,f=0;f<c.length;f++)condition=c[f],"Item"==condition.type?e.push({func:this.maingame.globalHandler.compareItemValue,para:[condition.name,condition.variable,condition.compare,condition.value],callee:this.maingame.globalHandler}):"Actor"==condition.type?e.push({func:this.maingame.globalHandler.compareActorValue,para:[condition.name,condition.variable,condition.compare,condition.value],callee:this.maingame.globalHandler}):"Variable"==condition.type?e.push({func:this.maingame.globalHandler.compareVariableValue,para:[condition.name,condition.compare,condition.value],callee:this.maingame.globalHandler}):"Quest"==condition.type?e.push({func:this.maingame.globalHandler.compareQuestValue,para:[condition.name,condition.compare,condition.value],callee:this.maingame.globalHandler}):"THIS"==condition.type?e.push({func:this.object.testTHISValues,para:[condition.variable,condition.compare,condition.value],callee:this.object}):console("Apply conditions unknown",condition.type,condition);return a.logic=d,a.list=e,a},EventDispatcher.prototype.testConditions=function(a){if(!a.list)return!0;if(a.list.length<=0)return!0;for(var b,c=a.list,d=a.logic,e=!1,f=0;f<c.length;f++){if(b=c[f].func.apply(c[f].callee,c[f].para),c[f].special&&0==b)return!1;if("All"==d){if(0==b)return!1;e=!0}else if(1==b)return!0}return e},EventDispatcher.prototype.doAction=function(a,b){var c=this.getEventType(a);this.completeAction(c,!1,b)},EventDispatcher.prototype.completeAction=function(a,b,c){var d,e=!1,f=[],g=[];if(a.length>0){for(var h=0;h<a.length;h++)if(null!=a[h]){if(a[h].con&&(a[h].con!=d&&(e=this.testConditions(a[h].con),d=a[h].con),!e))continue;if(a[h].walkto&&null!=c){var i=this.maingame.map.hexHandler.areTilesNeighbors(this.object.currentTile,c.currentTile);if(!i||!b){g.push(a[h]);continue}}"Activator"==a[h].type?null!=c&&(a[h].func=c.callFunction,a[h].callee=c,f.push(a[h])):f.push(a[h])}g.length>0&&c.moveToObject(this.object,this.object.currentTile,g),this.dogivenactions(f)}},EventDispatcher.prototype.dogivenactions=function(a){for(var b=0;b<a.length;b++)a[b]&&a[b].func.apply(a[b].callee,a[b].para),a[b].removeself&&(a[b]=null)},EventDispatcher.prototype.getEventType=function(a){return this.actionArray[a]=this.actionArray[a]||[],this.actionArray[a]},EventDispatcher.prototype.destroy=function(){this.actionArray=[]};var GlobalEvents=function(){};GlobalEvents.allEventDispatchers=[],GlobalEvents.SendRefresh=new Phaser.Signal,GlobalEvents.DISABLE=-1,GlobalEvents.WALK=0,GlobalEvents.LOOK=1,GlobalEvents.TOUCH=2,GlobalEvents.TALK=3,GlobalEvents.ITEM=4,GlobalEvents.MAGIC=5,GlobalEvents.COMBATSELECT=6,GlobalEvents.actionMap=[{action:GlobalEvents.WALK,array:"OnTouch",condition:[]},{action:GlobalEvents.LOOK,array:"OnLook",condition:[]},{action:GlobalEvents.TALK,array:"OnTalk",condition:[]},{action:GlobalEvents.ITEM,array:"OnUseItem",condition:[]}],GlobalEvents.lastAction=GlobalEvents.DISABLE,GlobalEvents._currentAction=GlobalEvents.WALK,GlobalEvents.selectedItem=null,Object.defineProperty(GlobalEvents,"currentAction",{get:function(){return GlobalEvents._currentAction},set:function(a){GlobalEvents._currentAction==GlobalEvents.DISABLE&&a!=GlobalEvents.DISABLE?GlobalEvents.lastAction=a:(GlobalEvents.lastAction=GlobalEvents._currentAction,GlobalEvents._currentAction=a,GlobalEvents.refreshEvents())}}),GlobalEvents.gotoLastAction=function(){GlobalEvents.currentAction=GlobalEvents.lastAction},GlobalEvents.tempDisableEvents=function(){GlobalEvents.currentAction=GlobalEvents.DISABLE},GlobalEvents.reEnableEvents=function(){GlobalEvents._currentAction==GlobalEvents.DISABLE&&(GlobalEvents._currentAction=GlobalEvents.lastAction,GlobalEvents.refreshEvents())},GlobalEvents.checkSelectItem=function(a){return null==GlobalEvents.selectedItem?!1:GlobalEvents.selectedItem.id==a},GlobalEvents.flushEvents=function(){GlobalEvents.allEventDispatchers=[]},GlobalEvents.refreshEvents=function(){for(var a=GlobalEvents.allEventDispatchers,b=0;b<a.length;b++)a[b].testAction();GlobalEvents.SendRefresh.dispatch([this])};var InteractiveObject=function(a,b,c){this.gameref=this.maingame=a,this.game=a.game,this.map=c,this.jsondata=b,this.posx,this.posy,this.currentTile=null,this.hasstates=!1,this.isCreated=!1,this.eventDispatcher=new EventDispatcher(this.game,this.maingame,this),this.otherAnimations=[],this.sightRange=4,this.baseImage,this.iso=null,this.notcreated=!1,this.IsPlayer||this.adjustVisible(1),this.lastpointer=null};InteractiveObject.prototype=Object.create(Phaser.Group.prototype),InteractiveObject.constructor=InteractiveObject,InteractiveObject.prototype.allowInputNow=function(a){null!=this.baseImage&&(this.baseImage.inputEnabled=a,null!=this.baseImage.input&&(this.baseImage.input.priorityID=100))},InteractiveObject.prototype.dosetup=function(){this.setupArt(this.jsondata),this.footprint;var a=this.jsondata.triggers;this.applyInteractActions(a),this.changeState(this.actor&&""!=this.actor.getValue("state")?this.actor.getValue("state"):(this.jsondata.state1="")?this.jsondata.state:"idle"),this.allowInputNow(!0),this.setupReactToAction(),this.eventDispatcher&&this.eventDispatcher.doAction("OnActivate",null),this.updateIso(),this.finalSetup()},InteractiveObject.prototype.updateIso=function(){this.currentTile&&(this.iso=this.map.spritegrid.projectGrid(this.currentTile.posx,this.currentTile.posy))},InteractiveObject.prototype.finalSetup=function(){1==this.IsPlayer&&this.changeState("idle")},InteractiveObject.prototype.applyInteractActions=function(a){this.eventDispatcher.init(a);for(var b=0;b<a.length;b++)if("actorset"==a[b].type)this.actor=this.maingame.globalHandler.getActorByID(a[b].id);else if("walkTiles"==a[b].type){this.footprint=[];for(var c=0;c<a[b].tiles.length;c++)this.footprint.push(this.map.hexHandler.getTileByCords(a[b].tiles[c].posx,a[b].tiles[c].posy))}else if("CharacterSpawn"==a[b].type){var d={logic:"Any",list:[]};if(this.eventDispatcher.applyConditions(d,a[b].conditions),this.eventDispatcher.testConditions(d)){var e=this.maingame.getGameData("Enemy",a[b].EnemyType);null!=e&&null!=e.triggers&&this.applyInteractActions(e.triggers)}else this.notcreated=!0}else"animations"==a[b].type&&this.applyAnimations(a[b])},InteractiveObject.prototype.applyAnimations=function(a){var b,c=a.animations;this.hasstates=!0,this.isCreated||(a.spriteSheet=a.spriteSheet||"actors2",this.createTempArt(a.spriteSheet,"body1_human_idle_0001"));for(var d=0;d<c.length;d++)b=0==c[d].start&&0==c[d].stop?this.baseImage.animations.add(c[d].id,[c[d].name+".png"],1,c[d].loop,!1):this.baseImage.animations.add(c[d].id,Phaser.Animation.generateFrameNames(c[d].name+"_",c[d].start,c[d].stop,".png",4),12,c[d].loop,!1),c[d].onComplete&&b.onComplete.add(function(){this.caller.callFunction(c[this.stateNum].onComplete,c[this.stateNum].onCompleteParams)},{stateNum:d,caller:this});if(null!=a.otherName){var e=this.game.make.sprite(0,0,"actors2","head1_human_idle_0000.png");e.anchor.x=.5,e.anchor.y=1,this.addChild(e),this.otherAnimations.push(e),this.addOtherAnimation(c,e,!1,a.otherName)}if(null!=a.weapon){var e=this.game.make.sprite(0,0,"actors2","head1_human_idle_0000.png");e.anchor.x=.5,e.anchor.y=1,this.addChild(e),this.otherAnimations.push(e),this.setChildIndex(e,0),this.addOtherAnimation(c,e,!1,a.weapon)}this.savedAnimations=c},InteractiveObject.prototype.addOtherAnimation=function(a,b,c,d){for(var e,f=0;f<a.length;f++)e=0==a[f].start&&0==a[f].stop?b.animations.add(a[f].id,[d+a[f].justName+".png"],1,a[f].loop,!1):b.animations.add(a[f].id,Phaser.Animation.generateFrameNames(d+a[f].justName+"_",a[f].start,a[f].stop,".png",4),12,a[f].loop,!1),a[f].onComplete&&c&&e.onComplete.add(function(){b.caller.callFunction(a[this.stateNum].onComplete,a[this.stateNum].onCompleteParams)},{stateNum:f,caller:this})},InteractiveObject.prototype.createTempArt=function(a,b){Phaser.Group.call(this,this.game,null),this.baseImage=this.game.make.sprite(0,0,a,b+".png"),this.addChild(this.baseImage),this.map.objectGroup.add(this),this.baseImage.anchor.x=.5,this.baseImage.anchor.y=1,this.isCreated=!0,this.otherAnimations.push(this.baseImage),void 0!=this.posx&&void 0!=this.posy&&this.setLocationByTile(this.map.hexHandler.getTileByCords(this.posx,this.posy))},InteractiveObject.prototype.setupArt=function(a){if(void 0!=a.name&&void 0!=a.tilesetid&&-1!=a.name&&-1!=a.tilesetid){this.isCreated=!0,console.log(a.name,a.tilesetid);var b=this.map.getTile(a.name,a.tilesetid),c=a.x||0,d=a.y||0;this.posx=a.posx||0,this.posy=a.posy||0;{this.map.hexHandler.getTileByCords(c,d)}Phaser.Group.call(this,this.game,null),console.log("setupArt",this,b,b.spritesheet,b.tile),this.baseImage=this.game.make.sprite(c+this.map.objectoffset.x,-1*d+this.map.objectoffset.y,b.spritesheet,b.tile+".png"),this.addChild(this.baseImage),this.baseImage.anchor.x=.5,this.baseImage.anchor.y=1,this.otherAnimations.push(this.baseImage),this.map.objectGroup.add(this)}},InteractiveObject.prototype.changeState=function(a){if(this.hasstates){if(this.baseImage){var b=this.baseImage.animations.getAnimation(a);if(b){this.baseImage.play(a);for(var c=0;c<this.otherAnimations.length;c++)void 0!=this.otherAnimations[c]&&void 0!=this.otherAnimations[c].animations.getAnimation(a)&&this.otherAnimations[c].animations.play(a);this.actor&&this.actor.updateValue("state",a),this.jsondata.state=a}else console.log(this,a,"state doesn't exist.")}}else this.jsondata.state=a},InteractiveObject.prototype.testTHISValues=function(a,b,c){var d=this[a];return(null==d||void 0==d)&&(d=this.jsondata[a]),"Is"==b?d==c:"IsNot"==b?d!=c:"Less"==b?c>d:"Greater"==b?d>c:"LessEqual"==b?c>=d:"GreaterEqual"==b?d>=c:!1},InteractiveObject.prototype.callFunction=function(a,b){var c=this[a];b=b.split(","),"function"==typeof c&&c.apply(this,b)},InteractiveObject.prototype.hideSelf=function(){this.baseImage.visible=!1},InteractiveObject.prototype.showSelf=function(){this.baseImage.visible=!0},InteractiveObject.prototype.deSpawn=function(){this.destroySelf()},InteractiveObject.prototype.moveto=function(a,b){if(null!=a)var c=this.map.hexHandler.getTileByCords(a,b);if(c){var d=this.map.hexHandler.checkHex(this.x,this.y);d.changeWalkable(!0),this.x=c.x,this.y=c.y,c.changeWalkable(!1),this.updateLocation(c)}this.handleOut()},InteractiveObject.prototype.areWeNeighbours=function(a){if(this.footprint)for(var b=0;b<this.footprint.length;b++){if(a==this.footprint[b])return!0;if(this.map.hexHandler.areTilesNeighbors(this.footprint[b],a))return!0}return a==this.currentTile?!0:this.map.hexHandler.areTilesNeighbors(this.currentTile,a)?!0:!1},InteractiveObject.prototype.updateLocation=function(a){this.jsondata.x=a.posx,this.jsondata.y=a.posy,Global.doShadows&&this.IsPlayer&&this.map.doSight(a,this.sightRange)},InteractiveObject.prototype.destroySelf=function(){this.jsondata.destroyed=!0,this.flushAll()},InteractiveObject.prototype.flushAll=function(){null!=this.animations&&(this.animations.stop(),this.animations.destroy()),this.eventDispatcher.destroy(),this.baseImage&&(this.baseImage.events.onInputUp.remove(this.handleClick,this),this.baseImage.events.onInputOver.remove(this.handleOver,this),this.baseImage.events.onInputOut.remove(this.handleOut,this)),this.destroy()},InteractiveObject.prototype.handleOver=function(){this.baseImage.tint=65535;for(var a=0;a<this.otherAnimations.length;a++)void 0!=this.otherAnimations[a]&&(this.otherAnimations[a].tint=65535);""!=this.jsondata.displayName&&this.maingame.textUIHandler.showRollover(this.jsondata.displayName,this.x,this.y)},InteractiveObject.prototype.handleOut=function(){this.baseImage.tint=16777215;for(var a=0;a<this.otherAnimations.length;a++)void 0!=this.otherAnimations[a]&&(this.otherAnimations[a].tint=16777215);this.maingame.textUIHandler&&this.maingame.textUIHandler.hideRollover()},InteractiveObject.prototype.setWalkable=function(a){if(this.footprint)for(var b=0;b<this.footprint.length;b++)this.footprint[b].changeWalkable(a);else this.currentTile.changeWalkable(a)},InteractiveObject.prototype.step=function(){},InteractiveObject.prototype.setupReactToAction=function(){null!=this.baseImage&&(this.baseImage.events.onInputUp.add(this.handleClick,this),this.baseImage.events.onInputOver.add(this.handleOver,this),this.baseImage.events.onInputOut.add(this.handleOut,this))},InteractiveObject.prototype.handleClick=function(a,b){return console.log("handleClick ",this,a,b,GlobalEvents.currentAction),b==this.lastpointer&&null!=b?void console.log("** handleClick ** Ignore this touch."):(this.lastpointer=b,this.eventDispatcher.doAction("Any",this.map.playerCharacter),void(GlobalEvents.currentAction!=GlobalEvents.WALK&&(GlobalEvents.currentAction==GlobalEvents.TOUCH?this.eventDispatcher.doAction("OnTouch",this.map.playerCharacter):GlobalEvents.currentAction==GlobalEvents.LOOK?this.eventDispatcher.doAction("OnLook",this.map.playerCharacter):GlobalEvents.currentAction==GlobalEvents.TALK?this.eventDispatcher.doAction("OnTalk",this.map.playerCharacter):GlobalEvents.currentAction==GlobalEvents.ITEM?this.eventDispatcher.doAction("OnUseItem",this.map.playerCharacter):GlobalEvents.currentAction==GlobalEvents.COMBATSELECT&&this.attackable&&!this.dead&&(console.log(this.maingame.gGameMode.mCurrentState.inputHandler),this.maingame.gGameMode.mCurrentState.inputHandler.clickedObject(this)),null!=b&&(b.active=!1),this.handleOut())))},InteractiveObject.prototype.adjustVisible=function(a){this.tint=16777215*a};var MovingCharacter=function(a,b,c){InteractiveObject.call(this,a,b,c),this.oldTile=null,this.path=null,this.pathlocation=0,this.nextTile,this.moveState="none",this.prevx,this.prevy,this.dir=new Phaser.Point,this.walkspeed=.1875;var d=this.jsondata.triggers;this.actionsaftermove,this.objectmovingto,this.movingtotile=null,this.movementState=new StateMachine,this.movementState.add("idle",new IdleState(this.movementState,a.game,a,this)),this.movementState.add("wander",new WanderState(this.movementState,a.game,a,this)),this.movementState.add("path",new PathState(this.movementState,a.game,a,this)),this.movementState.change("idle"),this.applyMoverActions(d),this.movetoCenterEvery=!0,this.douse=!0,this.limit=-1,this.moveStraight=!1,this.ignoreWalls=!1};MovingCharacter.prototype=Object.create(InteractiveObject.prototype),MovingCharacter.constructor=MovingCharacter,MovingCharacter.prototype.applyMoverActions=function(a){for(var b=0;b<a.length;b++)if("mover"==a[b].type)this.walkspeed=a[b].walkSpeed;else if("CharacterSpawn"==a[b].type){var c={logic:"Any",list:[]};if(this.eventDispatcher.applyConditions(c,a[b].conditions),this.eventDispatcher.testConditions(c)){var d=this.maingame.getGameData("Enemy",a[b].EnemyType);null!=d&&null!=d.triggers&&this.applyMoverActions(d.triggers)}else this.notcreated=!0}else if("AnimatedBody"==a[b].type){var e=this.maingame.getGameData("AnimatedBodies",a[b].body);if(null!=e&&null!=e.triggers&&(this.applyMoverActions(e.triggers),this.applyInteractActions(e.triggers),void 0!=this.savedAnimations&&""!=a[b].playerHead)){var f=this.game.make.sprite(0,0,"actors2","head1_human_idle_0000.png");f.anchor.x=.5,f.anchor.y=1,this.addChild(f),this.otherAnimations.push(f),this.addOtherAnimation(this.savedAnimations,f,!1,a[b].playerHead)}}},MovingCharacter.prototype.isMoving=function(){return 0==this.dir.x&&0==this.dir.y?!1:!0},MovingCharacter.prototype.finalSetup=function(){this.setLocationByTile(this.currentTile),this.currentTile.enterTile(this)},MovingCharacter.prototype.resetMoving=function(){this.path=null,this.nextTile=null,this.dir.x=0,this.dir.y=0},MovingCharacter.prototype.setLocation=function(a,b){this.x=a,this.y=b},MovingCharacter.prototype.setLocationByTile=function(a){null==a&&(a=this.map.hexHandler.getTileByCords(this.posx,this.posy)),this.x=a.x+this.map.hexHandler.halfHex,this.y=a.y+this.map.hexHandler.halfHexHeight,this.oldTile=a,this.currentTile=a,this.updateLocation(a),this.findtile(),this.resetMoving(),this.currentTile.changeWalkable(!1,this),this.updateIso()},MovingCharacter.prototype.gotoAnotherMap=function(){},MovingCharacter.prototype.setDirection=function(){null!=this.nextTile?(this.dir.x=this.nextTile.x+this.map.hexHandler.halfHex-this.x,this.dir.y=this.nextTile.y+this.map.hexHandler.halfHexHeight-this.y,this.dir.normalize()):(this.dir.x=0,this.dir.y=0)},MovingCharacter.prototype.setPath=function(a){a&&(a.length<=0||(null!=this.objectmovingto&&null!=this.objectmovingto.footprint&&(this.movingtotile=this.map.hexHandler.findClosesInPath(this.objectmovingto.currentTile,this.objectmovingto.footprint,a)),this.path=a,this.pathlocation=0,this.nextTile=a[this.pathlocation],this.setDirection(),this.changeState("walk")))},MovingCharacter.prototype.moveToObject=function(a,b,c){this.actionsaftermove=c,this.objectmovingto=a,this.moveto(b),this.actionsaftermove=c,this.objectmovingto=a,this.douse=!0},MovingCharacter.prototype.moveToSpotByCoords=function(a,b,c){var d=this.maingame.map.hexHandler.getTileByCords(a,b);null!=d&&this.moveToSpot(d,c),this.limit=-1},MovingCharacter.prototype.moveToSpot=function(a,b){this.actionsaftermove=b,this.moveto(a),this.actionsaftermove=b,this.douse=!1,this.limit=-1},MovingCharacter.prototype.moveToSpotCombat=function(a,b,c){this.actionsaftermove=b,this.moveto(a),this.actionsaftermove=b,this.douse=!1,this.limit=c},MovingCharacter.prototype.jumpTo=function(a){this.currentTile.changeWalkable(!0),this.setLocationByTile(a),this.finishMove(!0)},MovingCharacter.prototype.moveto=function(a){null!=a&&(null==this.currentTile&&(this.currentTile=this.map.hexHandler.checkHex(this.x,this.y),this.setLocationByTile(this.currentTile),this.updateIso()),null!=this.objectmovingto&&this.objectmovingto.areWeNeighbours(this.currentTile)?this.atTargetTile():this.moveStraight?(this.path=this.map.hexHandler.getlinepath(this.currentTile,a),null!=this.path&&this.path.length>0&&(this.pathlocation=this.path.length-1,this.nextTile=this.path[this.pathlocation],this.movingtotile=a,this.setDirection(),this.changeState("walk")),this.clearTargetTile()):this.currentTile.posx==a.posx&&this.currentTile.posy==a.posy?this.path=this.map.hexHandler.checkHex(a.posx,a.posy):(this.currentTile.changeWalkable(!0),this.maingame.pathfinder.setCallbackFunction(this.movercallback,this),this.maingame.pathfinder.preparePathCalculation([this.currentTile.posx,this.currentTile.posy],[a.posx,a.posy]),this.maingame.pathfinder.calculatePath(),this.clearTargetTile(),this.movingtotile=a))},MovingCharacter.prototype.movercallback=function(a){a=a||[],a=this.map.hexHandler.pathCoordsToTiles(a),this.setPath(a),this.maingame.map.highlightHex.showPathCallback(a)},MovingCharacter.prototype.atTargetTile=function(){this.actionsaftermove&&(null!=this.objectmovingto,this.douse?this.changeState("use"):(this.changeState("idle"),this.eventDispatcher.completeAction(this.actionsaftermove,!0),this.clearTargetTile())),this.movementState.mCurrentState.atTargetTile()},MovingCharacter.prototype.clearTargetTile=function(){this.actionsaftermove=null,this.movingtotile=null,this.objectmovingto=null},MovingCharacter.prototype.findtile=function(){var a=this.map.spritegrid.PosToMap(this.x,this.y);-1!=a.x&&(this.posx=a.x,this.posy=a.y)},MovingCharacter.prototype.changeMoveState=function(a,b,c,d){var e=[];b&&e.push(b),c&&e.push(c),d&&e.push(d),("idle"==a||"wander"==a||"path"==a)&&(this.moveState=a,this.movementState.change(a,e))},MovingCharacter.prototype.doUse=function(){this.changeState("idle"),this.actionsaftermove&&this.eventDispatcher.completeAction(this.actionsaftermove,!0),this.clearTargetTile()},MovingCharacter.prototype.faceTarget=function(a){this.scale.x=this.x<a.x?1:-1},MovingCharacter.prototype.moveToCenter=function(){this.path=[this.currentTile],this.pathlocation=0,this.nextTile=this.currentTile,this.setDirection()},MovingCharacter.prototype.finishMove=function(a){this.path=null,this.dir.x=0,this.dir.y=0,this.currentTile.enterTile(this),this.changeState("idle"),a&&null!=this.objectmovingto&&null!=this.currentTile?this.objectmovingto.areWeNeighbours(this.currentTile)&&this.atTargetTile():this.atTargetTile(),this.updateIso()},MovingCharacter.prototype.step=function(a){if(!this.notcreated){if(null==this.currentTile&&(this.currentTile=this.map.hexHandler.checkHex(this.x,this.y),this.setLocationByTile(this.currentTile)),null==this.oldTile&&this.finalSetup(),null!=this.movementState&&(this.movementState.update(a),this.movementState.render()),null!=this.path&&this.path.length>0){if(this.currentTile=this.map.hexHandler.checkHex(this.x,this.y),this.updateIso(),null==this.currentTile)return;if(this.oldTile!=this.currentTile&&(this.oldTile.changeWalkable(!0),this.oldTile=this.currentTile,this.currentTile.changeWalkable(!1,this)),this.currentTile.posx==this.nextTile.posx&&this.currentTile.posy==this.nextTile.posy){if(this.pathlocation++,this.limit>0&&!this.IsPlayer&&(this.limit--,console.log("step",this.limit)),this.pathlocation>=this.path.length||0==this.limit){this.pathlocation=this.path.length;var b=this.currentTile.x+this.map.hexHandler.halfHex,c=this.currentTile.y+this.map.hexHandler.halfHexHeight,d=3;b-d<this.x&&b+d>this.x&&c-d<this.y&&c+d>this.y&&(this.x=b,this.y=c,this.finishMove(!0)),this.setDirection()}else this.nextTile=this.path[this.pathlocation],this.setDirection();this.updateLocation(this.currentTile)}}var e=this.x+this.dir.x*this.walkspeed*a,f=this.y+this.dir.y*this.walkspeed*a;(this.prevx!=e||this.prevy!=f)&&(this.x=e,this.y=f,this.findtile(),this.prevx=this.x,this.prevy=this.y),this.dir.x<0?this.scale.x=-1:this.dir.x>0&&(this.scale.x=1)}},IdleState=function(){},IdleState.prototype=Object.create(EmptyState.prototype),IdleState.constructor=IdleState,IdleState.prototype.atTargetTile=function(){},WanderState=function(a,b,c,d){this.mover=d,this.statemachine=a,this.game=b,this.gameref=c,this.goalTile=null;

},WanderState.prototype=Object.create(EmptyState.prototype),WanderState.constructor=WanderState,WanderState.prototype.init=function(){console.log("init")},WanderState.prototype.update=function(){null==this.goalTile&&this.atTargetTile()},WanderState.prototype.render=function(){},WanderState.prototype.onEnter=function(){console.log("onEnter"),this.goalTile=null},WanderState.prototype.onExit=function(){this.goalTile=null,this.mover.moveToCenter()},WanderState.prototype.atTargetTile=function(){var a=this.gameref.map.hexHandler.doFloodFill(this.mover.currentTile,5,!0),b=Phaser.ArrayUtils.getRandomItem(a);this.goalTile=Phaser.ArrayUtils.getRandomItem(b),this.mover.moveToSpot(this.goalTile)},PathState=function(a,b,c,d){this.mover=d,this.statemachine=a,this.game=b,this.gameref=c,this.path=null,this.startOfPath=null,this.currentPoint=null,this.onEnterDo=null,this.delay=0},PathState.prototype=Object.create(EmptyState.prototype),PathState.constructor=WanderState,PathState.prototype.init=function(){},PathState.prototype.update=function(a){this.delay>0&&(this.delay-=a,this.delay<=0&&(this.delay=0,this.doTileState()))},PathState.prototype.render=function(){},PathState.prototype.onEnter=function(a){if(!(a.length<2)&&(this.path=a[0],this.pathData=this.gameref.map.getPath(this.path),null!=this.pathData)){this.startOfPath=this.pathData.getPointByName(a[1]),this.currentPoint=this.startOfPath;var b=this.gameref.map.hexHandler.getTileByCords(this.currentPoint.posx,this.currentPoint.posy);a[2]?this.mover.jumpTo(b):this.mover.moveToSpot(b)}},PathState.prototype.onExit=function(){this.path=null,this.startOfPath=null,this.currentPoint=null,this.mover.moveToCenter()},PathState.prototype.setPath=function(){},PathState.prototype.atTargetTile=function(){this.onEnterDo=this.currentPoint,null!=this.pathData&&(this.currentPoint.delay>0?this.delay=this.currentPoint.delay:this.doTileState())},PathState.prototype.doTileState=function(){if(this.currentPoint=this.pathData.getNextPoint(this.currentPoint),null==this.currentPoint)this.mover.changeMoveState("idle");else{var a=this.gameref.map.hexHandler.getTileByCords(this.currentPoint.posx,this.currentPoint.posy);this.mover.moveToSpot(a)}this.onEnterDo.eventDispatcher&&this.onEnterDo.eventDispatcher.doAction("OnEnter",this.mover),this.onEnterDo=null};var CombatCharacter=function(a,b,c){MovingCharacter.call(this,a,b,c);var d=this.jsondata.triggers;this.weapons=[],this.weaponCatagories=[],this.numberOfActions=2,this.isCombatCharacter=!0,this.currentSelectedWeapon=null,this.hostile=!1,this.displayNameText="",this.dead=!1,this.faction=[],this.applyCombatActions(d)};CombatCharacter.prototype=Object.create(MovingCharacter.prototype),CombatCharacter.constructor=CombatCharacter,CombatCharacter.prototype.applyCombatActions=function(a){for(var b=0;b<a.length;b++){var c=a[b];if("combatAttributes"==c.type)this.movementspeed=c.movementspeed,this.shieldhpmax=this.shieldhp=c.shieldhp,this.selfhpmax=this.selfhp=c.selfhp,this.attackable=c.attackable,this.hostile=c.hostile;else if("weaponsInventory"==c.type){var d=null;null!=c.name&&(null==this.weaponCatagories[c.name]&&(this.weaponCatagories[c.name]=[]),d=this.weaponCatagories[c.name]);for(var e=0;e<c.weapons.length;e++){var f=this.maingame.getGameData("Weapons",c.weapons[e]);if(null!=f&&null!=f.triggers){var g=new Weapon(f.triggers[0]);this.weapons.push(g),null!=d&&d.push(g)}}}else if("weapon"==c.type){var g=new Weapon(c);this.weapons.push(g)}else if("CharacterSpawn"==a[b].type){this.displayNameText=a[b].EnemyType,this.name=a[b].EnemyType;var h={logic:"Any",list:[]};if(this.eventDispatcher.applyConditions(h,a[b].conditions),this.eventDispatcher.testConditions(h)){var i=this.maingame.getGameData("Enemy",a[b].EnemyType);null!=i&&null!=i.triggers&&this.applyCombatActions(i.triggers)}else this.notcreated=!0}else"powerBoosts"==c.type}},CombatCharacter.prototype.finalSetup=function(){null!=this.currentTile&&this.setLocationByTile(this.currentTile),this.notcreated||this.setupHealthBar()},CombatCharacter.prototype.setupHealthBar=function(){this.healthuigroup=this.game.add.group(),this.shieldbar=[],this.healthbar=[],this.addChild(this.healthuigroup);var a,b=0,c=0;this.shieldhp=0;for(var d=0;d<this.shieldhp;d++)a=this.game.make.image(0,0,"gameplayinterface","combat_actionpoints0001.png"),d%8==0&&(b++,c=0),a.x=15*c,a.y=15*b,c++,a.tint=16777215,this.shieldbar.push(a),this.healthuigroup.add(a);for(var d=0;d<this.selfhp;d++)a=this.game.make.image(0,0,"gameplayinterface","combat_actionpoints0001.png"),a.tint=255,d%8==0&&(b++,c=0),a.x=15*c,a.y=15*b,c++,a.tint=16777215,this.healthbar.push(a),this.healthuigroup.add(a);this.healthuigroup.x=-this.width/2,this.healthuigroup.y=-this.height,this.healthuigroup.visible=!1,this.startCombat()},CombatCharacter.prototype.boostShield=function(a){this.shieldhp+=a,this.shieldhp>this.shieldhpmax&&(this.shieldhp=this.shieldhpmax),this.updateBars()},CombatCharacter.prototype.takeDmg=function(a){this.dead||(this.shieldhp-=a,this.shieldhp<0&&(this.selfhp+=this.shieldhp,this.shieldhp=0),this.selfhp<=0?(this.changeState("die"),this.eventDispatcher.testAction(),this.dead=!0,this.jsondata.destroyed=!0,this.jsondata.dead=!0,this.attackable=!1,this.currentTile.changeWalkable(!0)):this.changeState("hurt"),this.updateBars())},CombatCharacter.prototype.doDead=function(){this.currentTile.changeWalkable(!0),this.eventDispatcher.doAction("OnDeath",this)},CombatCharacter.prototype.isAlive=function(){return this.selfhp<=0?!1:!0},CombatCharacter.prototype.updateBars=function(){for(var a=0;a<this.shieldbar.length;a++)this.shieldbar[a].tint=a>=this.shieldhp?240:16777215;for(var a=0;a<this.healthbar.length;a++)this.healthbar[a].tint=a>=this.selfhp?240:16777215},CombatCharacter.prototype.startCombat=function(){this.moveToCenter(),this.healthuigroup.visible=!0,this.dead||this.changeMoveState("idle")},CombatCharacter.prototype.endCombat=function(){this.healthuigroup.visible=!1},CombatCharacter.prototype.tintRed=function(){this.doTint(16711680)},CombatCharacter.prototype.tintYellow=function(){this.doTint(16711680)},CombatCharacter.prototype.tintGreen=function(){this.doTint(65280)},CombatCharacter.prototype.doRemoveTint=function(){this.doTint(16777215)},CombatCharacter.prototype.doTint=function(a){this.baseImage.tint=a;for(var b=0;b<this.otherAnimations.length;b++)void 0!=this.otherAnimations[b]&&(this.otherAnimations[b].tint=a)},CombatCharacter.prototype.handleOver=function(){this.hostile?this.tintRed():this.tintGreen(),"combat"!=this.maingame.gGameMode.currentState||this.dead||this.maingame.gGameMode.mCurrentState.handleOver(this),this.jsondata.displayName&&""!=this.jsondata.displayName&&this.maingame.textUIHandler.showRollover(this.jsondata.displayName,this.x,this.y),""!=this.displayNameText&&this.maingame.textUIHandler.showRollover(this.displayNameText,this.x,this.y)},CombatCharacter.prototype.handleOut=function(){this.doRemoveTint(),this.maingame.textUIHandler&&this.maingame.textUIHandler.hideRollover(),"combat"==this.maingame.gGameMode.currentState&&this.maingame.gGameMode.mCurrentState.handleOut()},CombatCharacter.prototype.findWalkable=function(a){return this.map.hexHandler.doFloodFill(a,this.movementspeed,!0)},CombatCharacter.prototype.findWalkableFromCurrent=function(){return this.map.hexHandler.doFloodFill(this.currentTile,this.movementspeed,!0)},CombatCharacter.prototype.removeCurrentTile=function(a){for(var b=0;b<a.length;b++)for(var c=0;c<a[b].length;c++)a[b][c]==this.currentTile},CombatCharacter.prototype.Speed=function(){return 1},CombatCharacter.prototype.shootGun=function(a,b,c,d,e){this.faceTarget(a),this.changeState("shoot"),this.actionsaftermove=[{func:this.afterShoot,para:[{weapon:b,target:a,afterAction:c,action:d,state:e}],removeself:!1,callee:this,con:null,walkto:!1}]},CombatCharacter.prototype.doShoot=function(){this.changeState("idle"),this.actionsaftermove&&this.eventDispatcher.completeAction(this.actionsaftermove,!0),this.clearTargetTile(),this.actionsaftermove=null},CombatCharacter.prototype.afterShoot=function(a){var b=a.target,c=a.weapon,d=a.afterAction,e=a.action,f=a.state,g=this.maingame.map.hexHandler.testRange(b.currentTile,this.currentTile,!1),h=c.range,i=c.acc-g/(60*h)/5;g>60*h&&(i=0);var j=!0;Math.random()<i&&(j=!0);var e=new CombatAction(this.game,this.gameref,this,b,"bullet",f,[c,i,j]);d.func.apply(d.callee,[e])};var MonsterCharacter=function(a,b,c){CombatCharacter.call(this,a,b,c),this.jsondata.state="idle",this.IsPlayer=!1};MonsterCharacter.prototype=Object.create(CombatCharacter.prototype),MonsterCharacter.constructor=MonsterCharacter,MonsterCharacter.prototype.doDead=function(){};var PlayerCharacter=function(a,b,c){CombatCharacter.call(this,a,b,c),this.jsondata.state="idle",this.IsPlayer=!0,this.movementState.change("idle"),this.moveStraight=!1,this.baseImage.events.onInputUp.add(this.handleSelect,this)};PlayerCharacter.prototype=Object.create(CombatCharacter.prototype),PlayerCharacter.constructor=PlayerCharacter,PlayerCharacter.prototype.doDead=function(){this.currentTile.changeWalkable(!0,this),this.eventDispatcher.doAction("OnDeath",this),this.jsondata.destroyed=!1,this.jsondata.dead=!1,this.jsondata.state="idle"},PlayerCharacter.prototype.handleSelect=function(){console.log("****** select player"),this.maingame.map.playerCharacter!=this&&(this.maingame.map.playerCharacter=this)},BulletHandler=function(a,b,c,d,e){Phaser.Group.call(this,a),this.pool=new BasicObjectPool(this),this.game=a,this.gameref=b,this.bulletGroup=c,this.spritesheet=d,this.defaultImageName=e},BulletHandler.prototype=Object.create(Phaser.Group.prototype),BulletHandler.constructor=BulletHandler,BulletHandler.prototype.createItem=function(){var a=new Bullet(this.game,this.gameref,-1e3,0,this.spritesheet,this.defaultImageName,this);return console.log(a),this.bulletGroup.add(a),a},BulletHandler.prototype.returnBullet=function(a){this.pool.returnObject(a)},BulletHandler.prototype.cleanupAllBullets=function(){for(var a=this.pool.allObjectsArray,b=0;b<a.length;b++)a[b].killSelf()},BulletHandler.prototype.fireBullet=function(a,b,c,d,e,f){if(null==a);else{var g=this.pool.getObject();g.getReady(a,b,c,d,f,e)}},BulletHandler.prototype.step=function(a){for(var b=this.pool.allObjectsArray,c=0;c<b.length;c++)b[c].inUse&&b[c].step(a)};var Bullet=function(a,b,c,d,e,f,g){Phaser.Image.call(this,a,c,d,e,f),this.game=a,this.gameref=b,this.anchor.x=.5,this.anchor.y=.5,this.target=null,this.time,this.inUse=!1,this.handler=g,this.dir=new Phaser.Point,this.weaponParams,this.iso=null,this.speed=.375,this.tint=16711765};Bullet.prototype=Object.create(Phaser.Image.prototype),Bullet.constructor=Bullet,Bullet.prototype.step=function(a){var b=this.x+this.dir.x*this.speed*a,c=this.y+this.dir.y*this.speed*a;(this.prevx!=b||this.prevy!=c)&&(this.x=b,this.y=c,this.findtile(),this.prevx=this.x,this.prevy=this.y,this.updateIso()),this.iso.x==this.target.iso.x&&this.iso.z==this.target.iso.z&&(this.killSelf(),this.afterAction.func.apply(this.afterAction.callee,[]),this.target.takeDmg(this.weaponParams.weapon.dmg))},Bullet.prototype.killSelf=function(){this.handler.returnBullet(this),this.visible=!1,this.inUse=!1},Bullet.prototype.getReady=function(a,b,c,d,e,f){this.inUse=!0,this.visible=!0,this.start=c,this.target=d,this.afterAction=f,this.weaponParams=e,this.x=c.x,this.y=c.y,this.target=d,console.log(this.target),this.setDirection(),this.posx=-1,this.posy=-1,this.prevx=-1,this.prevy=-1,this.findtile(),this.updateIso()},Bullet.prototype.reset=function(){this.time=-1,this.over=null,this.inUse=!1,this.visible=!1},Bullet.prototype.setDirection=function(){null!=this.target?(this.dir.x=this.target.x-this.x,this.dir.y=this.target.y-this.y,this.dir.normalize()):(this.dir.x=0,this.dir.y=0)},Bullet.prototype.findtile=function(){var a=this.gameref.map.spritegrid.PosToMap(this.x,this.y);-1!=a.x&&(this.posx=a.x,this.posy=a.y)},Bullet.prototype.updateIso=function(){this.currentTile&&(this.iso=this.gameref.map.spritegrid.projectGrid(this.currentTile.posx,this.currentTile.posy))},Bullet.prototype.updateIso=function(){this.iso=this.gameref.map.spritegrid.projectGrid(this.posx,this.posy)};var DialogHandler=function(a,b,c,d){this.game=a,this.maingame=b,this.conversations=c,this.actors=d,this.currentConvo,this.playerActor=this.maingame.globalHandler.getPlayerActor(),this.eventDispatcher=new EventDispatcher(a,b,null),this.displayPlayerText=!1};DialogHandler.prototype.startConvo=function(a){if(this.currentConvo=this.getConversationsByID(a),null!=this.currentConvo){var b=this.buildDialogByID(0);if(null!=b)return b}return null},DialogHandler.prototype.doActions=function(a){if(a.actions&&a.actions.length>0){var b=[];this.eventDispatcher.helpSetActions(b,a.actions,!1,null),b.length>0&&this.eventDispatcher.completeAction(b)}},DialogHandler.prototype.getNextDialog=function(a){return null==a?null:(this.doActions(a),a.Actor!=this.playerActor.id||this.displayPlayerText?this.buildDialogWithDiag(a):a.links.length>0?this.getNextDialog(this.getDialogByID(a.links[0].DestID)):null)},DialogHandler.prototype.buildDialogWithDiag=function(a){if(null==a)return null;for(var b,c=[],d=a.links.length,e=0;d>e;e++){var b=this.getDialogByID(a.links[e].DestID);if(null!=b){var f={logic:"Any",list:[]};this.eventDispatcher.applyConditions(f,b.conditions),this.eventDispatcher.testConditions(f)&&c.push(b)}}var g=this.maingame.globalHandler.getActorByID(a.Actor),h={current:a,links:c,actor:g};return h},DialogHandler.prototype.buildDialogByID=function(a){var b=this.getDialogByID(a);return null==b?null:this.buildDialogWithDiag(b)},DialogHandler.prototype.getDialogByID=function(a){for(var b=this.currentConvo.DialogueEntries.length,c=0;b>c;c++)if(this.currentConvo.DialogueEntries[c].ID==a)return this.currentConvo.DialogueEntries[c];return null},DialogHandler.prototype.getConversationsByID=function(a){for(var b=this.conversations.length,c=0;b>c;c++)if(this.conversations[c].id==a)return this.conversations[c];return null};var GlobalHandler=function(a,b,c,d,e,f){this.game=a,this.maingame=b,this.actors=[],this.playerActor;for(var g=0;g<c.length;g++)this.actors[c[g].id.toString()]=new ActorObject(c[g]),"Player"==c[g].Name&&(this.playerActor=this.actors[c[g].id.toString()]);this.variables=[];for(var g=0;g<d.length;g++)this.variables[d[g].id.toString()]=new VariableObject(d[g]);this.items=[],this.quests=[];for(var g=0;g<f.length;g++)f[g]["Is Item"]?this.items[f[g].id.toString()]=new ItemObject(f[g]):this.quests[f[g].id.toString()]=new QuestObject(f[g]);this.maps=[]};GlobalHandler.prototype.SaveGame=function(){},GlobalHandler.prototype.compareQuestValue=function(a,b,c){return this.quests[a]?this.doCompare(b,this.quests[a].State,c):!1},GlobalHandler.prototype.updateQuestByID=function(a,b,c){return this.quests[a]?("Add"==b?this.quests[a].value+=parseFloat(c):this.quests[a].value=c,!0):!1},GlobalHandler.prototype.compareVariableValue=function(a,b,c){return this.variables[a]?this.doCompare(b,this.variables[a].getValue(),c):!1},GlobalHandler.prototype.getVariableValue=function(a){return this.variables[a]?this.variables[a].getValue():null},GlobalHandler.prototype.updateVariableByID=function(a,b,c){return console.log(this.variables[a],b,c),this.variables[a]?("Add"==b?this.variables[a].updateValue(null,this.variables[a].getValue()+parseFloat(c)):this.variables[a].updateValue(null,c),!0):!1},GlobalHandler.prototype.doCompare=function(a,b,c){return"Is"==a?b==c:"IsNot"==a?b!=c:"Less"==a?c>b:"Greater"==a?b>c:"LessEqual"==a?c>=b:"GreaterEqual"==a?b>=c:void 0},GlobalHandler.prototype.compareItemValue=function(a,b,c,d){return this.items[a]?null==this.items[a].json[b]?!1:this.doCompare(c,this.items[a].json[b],d):!1},GlobalHandler.prototype.getItemValue=function(a,b){return this.items[a]?this.items[a].json[b]:null},GlobalHandler.prototype.getItemByID=function(a){return this.items[a]?this.items[a]:null},GlobalHandler.prototype.updateItem=function(a,b,c,d){var e=this.getItemByID(a);e?"Add"==b?e.addValue(c,d):e.updateValue(c,d):console.log(a,"not found")},GlobalHandler.prototype.compareActorValue=function(a,b,c,d){return this.actors[a]&&this.actors[a].json[b]?this.doCompare(c,this.actors[a].json[b],d):!1},GlobalHandler.prototype.getActorValue=function(a,b){return this.actors[a]?this.actors[a].json[b]:null},GlobalHandler.prototype.getPlayerActor=function(){return this.playerActor},GlobalHandler.prototype.getActorByID=function(a){return this.actors[a]?this.actors[a]:null},GlobalHandler.prototype.updateActor=function(a,b,c,d){var e=this.getActorByID(a);e?"Add"==b?e.addValue(c,d):e.updateValue(c,d):console.log(a,"not found")},GlobalHandler.prototype.setActor=function(a,b){this.actors[a]&&this.actors[i].bind.push(b)};var BaseObject=function(a){this.OnChangeSignal=new Phaser.Signal,this.json=a,this.id=a.id};BaseObject.prototype.updateValue=function(a,b){this.json[a]=b,this.OnChangeSignal.dispatch([this])},BaseObject.prototype.addValue=function(a,b){null!=this.json[a]&&(this.json[a]+=b),this.OnChangeSignal.dispatch([this])},BaseObject.prototype.getValue=function(a){return null!=this.json&&null!=this.json[a]?this.json[a]:null};var ItemObject=function(a){BaseObject.call(this,a),this.id=a.id};ItemObject.prototype=Object.create(BaseObject.prototype),ItemObject.constructor=ItemObject;var ActorObject=function(a){BaseObject.call(this,a),this.bind=[]};ActorObject.prototype=Object.create(BaseObject.prototype),ActorObject.constructor=ActorObject;var QuestObject=function(a){BaseObject.call(this,a)};QuestObject.prototype=Object.create(BaseObject.prototype),QuestObject.constructor=QuestObject,Object.defineProperty(QuestObject,"value",{get:function(){return this._value},set:function(a){this._value=a,this.OnChangeSignal.dispatch([this])}});var VariableObject=function(a){BaseObject.call(this,a),this.id=a.id,this.name=a.Name,this._value=a["Initial Value"],this.description=a.Description};VariableObject.prototype=Object.create(BaseObject.prototype),VariableObject.constructor=VariableObject,VariableObject.prototype.updateValue=function(a,b){this._value=b,this.json["Initial Value"]=b,this.OnChangeSignal.dispatch([this])},VariableObject.prototype.getValue=function(){return this._value};var HexHandler=function(a,b,c,d,e){this.maingame=a,this.game=b,this.debug=!0,this.tiletype=e,this.visited=[],this.fringes=[],this.hexagonArray=[],this.waterTilesArray=[],this.hexagonWidth=c||32,this.hexagonHeight=d||16,this.sectorWidth=this.hexagonWidth,this.sectorHeight=this.hexagonHeight/4*3,this.halfHex=this.hexagonWidth/2,this.halfHexHeight=this.hexagonHeight/2,this.bottomOffset=0,this.halfWithOffset=this.halfHexHeight+this.bottomOffset,this.gradient=this.hexagonHeight/4/(this.hexagonWidth/2),this.sprite="HexIso"==this.tiletype?new Phaser.Image(b,0,0,"standardimages","hexmousemap1"):new Phaser.Image(b,0,0,"standardimages","mousemapiso"),this.touchmap=new Phaser.BitmapData(b,"touchmap",100,50),this.touchmap.draw(this.sprite,0,0),this.touchmap.update(),console.log("tester size: ",this.sprite.width,this.sprite.height),this.tempcolour={r:0,g:0,b:0}};HexHandler.prototype.update=function(a){if(this.waterTilesArray)for(var b=this.waterTilesArray.length,c=0;b>c;c++)this.waterTilesArray[c].step(a)},HexHandler.prototype.checkHex=function(a,b){if(this.hexagonArray){var c=a%this.sectorWidth,d=b%this.sectorHeight,e=Math.floor(a/this.sectorWidth),f=Math.floor(b/this.sectorHeight);if(f%2==0?(d<this.hexagonHeight/4-c*this.gradient&&(e--,f--),d<-this.hexagonHeight/4+c*this.gradient&&f--):c>=this.hexagonWidth/2?d<this.hexagonHeight/2-c*this.gradient&&f--:d<c*this.gradient?f--:e--,this.maingame.gridSizeY%2==0&&f%2==1&&0>e&&(e=0),!(0>e||0>f||f>=this.maingame.gridSizeY||e>=this.maingame.gridSizeX))return this.hexagonArray[e][f]}},HexHandler.prototype.getTileByCords=function(a,b){return this.hexagonArray[a]&&this.hexagonArray[a][b]?this.hexagonArray[a][b]:null},HexHandler.prototype.lineTest=function(a,b){var c=new Point(a.x+this.halfHex,a.y+this.halfHexHeight),d=new Point(b.x+this.halfHex,b.y+this.halfHexHeight),e=this.game.math.distance(c.x,c.y,d.x,d.y),f=this.hexagonWidth;this.hexagonWidth>this.hexagonHeight&&(f=this.hexagonHeight),e=Math.ceil(e/this.cut,0)+1;for(var g=[],h=0;e>=h;h++){var i=0==e?0:h/e;g.push(this.lerp_point(c,d,i))}for(var j=0;j<g.length;j++){var k=this.checkHex(g[j].x,g[j].y);if(null==k)return null;if(!k.walkable)return k}return b},HexHandler.prototype.testRange=function(a,b){var c=new Point(a.x+this.halfHex,a.y+this.halfHexHeight),d=new Point(b.x+this.halfHex,b.y+this.halfHexHeight),e=this.game.math.distance(c.x,c.y,d.x,d.y);return e},HexHandler.prototype.lineOfSite=function(a,b){if(null!=a&&null!=b){var c=new Point(a.x+this.halfHex,a.y+this.halfHexHeight),d=new Point(b.x+this.halfHex,b.y+this.halfHexHeight),e=this.game.math.distance(c.x,c.y,d.x,d.y),f=this.hexagonWidth;this.hexagonWidth>this.hexagonHeight&&(f=this.hexagonHeight),e=Math.ceil(e/f)+1;for(var g=[],h=0;e>=h;h++){var i=0==e?0:h/e;g.push(this.lerp_point(c,d,i))}for(var j=0;j<g.length;j++){var k=this.checkHex(g[j].x,g[j].y);if(null!=k){if(k==b)return!0;if(!k.walkable&&k!=a)return!1}}return!0}},HexHandler.prototype.dolines=function(a,b,c,d){if(null!=a&&null!=b){var e=new Point(a.x+this.halfHex,a.y+this.halfHexHeight),f=new Point(b.x+this.halfHex,b.y+this.halfHexHeight);this.debug&&(this.maingame.graphics.clear(),this.maingame.graphics.lineStyle(10,16767232,1),this.maingame.graphics.moveTo(e.x*this.maingame.map.mapGroup.scale.x+this.maingame.map.mapGroup.x,e.y*this.maingame.map.mapGroup.scale.y+this.maingame.map.mapGroup.y),this.maingame.graphics.lineTo(f.x*this.maingame.map.mapGroup.scale.x+this.maingame.map.mapGroup.x,f.y*this.maingame.map.mapGroup.scale.y+this.maingame.map.mapGroup.y));var g=this.game.math.distance(e.x,e.y,f.x,f.y),h=this.hexagonWidth;this.hexagonWidth>this.hexagonHeight&&(h=this.hexagonHeight),g=Math.ceil(g/h)+1;for(var i=[],j=0;g>=j;j++){var k=0==g?0:j/g;i.push(this.lerp_point(e,f,k))}var l=[];this.debug&&(this.maingame.graphics.lineStyle(0),this.maingame.graphics.beginFill(65291,.5));d&&d.cleanuptiles();for(var m=0;m<i.length;m++){var n=this.checkHex(i[m].x,i[m].y);if(this.debug&&this.maingame.graphics.drawCircle(i[m].x*this.maingame.map.mapGroup.scale.x+this.maingame.map.mapGroup.x,i[m].y*this.maingame.map.mapGroup.scale.y+this.maingame.map.mapGroup.y,10),null!=n){if(!n.walkable&&!c&&n!=a&&n!=b)break;l.push(n),d&&d.highlighttilebytile(m,n)}}return this.debug&&this.maingame.graphics.endFill(),l}},HexHandler.prototype.getlinepath=function(a,b,c){if(null!=a&&null!=b){var d=new Point(a.x+this.halfHex,a.y+this.halfHexHeight),e=new Point(b.x+this.halfHex,b.y+this.halfHexHeight),f=this.game.math.distance(d.x,d.y,e.x,e.y),g=this.hexagonWidth;this.hexagonWidth>this.hexagonHeight&&(g=this.hexagonHeight),f=Math.ceil(f/g)+1;for(var h=[],i=0;f>=i;i++){var j=0==f?0:i/f;h.push(this.lerp_point(d,e,j))}for(var k=[],l=1;l<h.length;l++){var m=this.checkHex(h[l].x,h[l].y);if(null!=m){if(!m.walkable&&!c)break;k.push(m)}}return k}},HexHandler.prototype.round_point=function(a){return new Point(Math.round(a.x),Math.round(a.y))},HexHandler.prototype.lerp=function(a,b,c){return a+c*(b-a)},HexHandler.prototype.lerp_point=function(a,b,c){return new Point(this.lerp(a.x,b.x,c),this.lerp(a.y,b.y,c))},HexHandler.prototype.doFloodFill=function(a,b){if(null!=a){this.visited=[],this.visited.push(a),this.fringes=[],this.fringes.push([a]);for(var c=1;b>=c;c++){this.fringes.push([]);for(var d=0;d<this.fringes[c-1].length;d++){var e=this.fringes[c-1][d];e.posx%2==1?(this.addNeighbor(e,0,-1,c),this.addNeighbor(e,-1,0,c),this.addNeighbor(e,0,1,c),this.addNeighbor(e,1,1,c),this.addNeighbor(e,1,0,c),this.addNeighbor(e,-1,1,c)):(this.addNeighbor(e,-1,-1,c),this.addNeighbor(e,-1,0,c),this.addNeighbor(e,0,1,c),this.addNeighbor(e,1,0,c),this.addNeighbor(e,0,-1,c),this.addNeighbor(e,1,-1,c))}}return this.fringes}},HexHandler.prototype.addNeighbor=function(a,b,c,d){b=a.posx+b,c=a.posy+c;var e=this.getTileByCords(b,c);null!=e&&e.walkable&&-1==this.visited.indexOf(e)&&(this.visited.push(e),this.fringes[d].push(e))},HexHandler.prototype.getFrigesAsArray=function(){for(var a=[],b=0;b<fridges.length;b++)for(var c=0;c<fridges[b].length;c++)a.push(fridges[b][c]);return a},HexHandler.prototype.areTilesNeighbors=function(a,b){var c=a.x-b.x,d=a.y-b.y;if(a.x%2==1){if(0==c&&-1==d)return!0;if(-1==c&&0==d)return!0;if(0==c&&1==d)return!0;if(1==c&&1==d)return!0;if(1==c&&0==d)return!0;if(-1==c&&1==d)return!0}else{if(-1==c&&-1==d)return!0;if(-1==c&&0==d)return!0;if(0==c&&1==d)return!0;if(1==c&&0==d)return!0;if(0==c&&-1==d)return!0;if(1==c&&-1==d)return!0}return!1},HexHandler.prototype.findClosesInPath=function(a,b,c){for(var d=-1,e=-1,f=c.length;f>0;f--)for(var g=0;g<b.length;g++)c[f]===b[g]&&(e=f,d=g);return-1!=e?(c=c.splice(e,c.length-e),b[g]):a},HexHandler.prototype.pathCoordsToTiles=function(a){newpath=[];for(var b=0;b<a.length;b++){var c=this.getTileByCords(a[b].x,a[b].y);null!=c&&c.walkable&&newpath.push(c)}return newpath},HexHandler.prototype.flush=function(){this.hexagonArray=[],this.waterTilesArray=[]};var InputHandler=function(a,b){this.game=a,this.gameref=b,this.dragScreen=!1,this.didDrag=!1,this.dragPoint=new Point(0,0),this.overGuy=null};InputHandler.prototype.turnOn=function(){this.gameref.input.addMoveCallback(this.onMove,this),this.gameref.input.onDown.add(this.doDragScreen,this),this.gameref.input.onUp.add(this.clickedHex,this),this.gameref.input.priorityID=0,this.dragScreen=!1,this.didDrag=!1},InputHandler.prototype.turnOff=function(){console.log("inputhandler turnoff"),this.gameref.input.deleteMoveCallback(this.onMove,this),this.gameref.input.onDown.remove(this.doDragScreen,this),this.gameref.input.onUp.remove(this.clickedHex,this)},InputHandler.prototype.onMove=function(a,b,c){if(this.doDragScreenMove(b,c),GlobalEvents.currentAction!=GlobalEvents.WALK,!this.game.global.pause){var d=(this.gameref.input.worldX-this.gameref.map.mapGroup.x)/this.gameref.map.scaledto,e=(this.gameref.input.worldY-this.gameref.map.mapGroup.y)/this.gameref.map.scaledto,f=this.gameref.map.hexHandler.checkHex(d,e);GlobalEvents.currentAction==GlobalEvents.WALK?this.gameref.map.highlightHex.moveCursor(f):this.gameref.map.highlightHex.cleanuptiles()}},InputHandler.prototype.doDragScreen=function(a){a.active&&(this.dragScreen=!0,this.dragPoint.x=a.x,this.dragPoint.y=a.y)},InputHandler.prototype.doDragScreenMove=function(a,b){if(this.dragScreen){var c=this.dragPoint.x-a,d=this.dragPoint.y-b;return this.dragPoint.x=a,this.dragPoint.y=b,(0!=c||0!=d)&&(this.didDrag=!0),void this.gameref.camera.adjustPosition(-c,-d)}},InputHandler.prototype.clickedObject=function(){},InputHandler.prototype.clickedHex=function(a){return a.withinGame?(this.dragScreen=!1,this.didDrag?void(this.didDrag=!1):void(a.active&&GlobalEvents.currentAction==GlobalEvents.WALK&&(this.game.global.pause||this.handleCharMove()))):void 0},InputHandler.prototype.handleCharMove=function(){var a=(this.gameref.input.worldX-this.gameref.map.mapGroup.x)/this.gameref.map.scaledto,b=(this.gameref.input.worldY-this.gameref.map.mapGroup.y)/this.gameref.map.scaledto,c=this.gameref.map.hexHandler.checkHex(a,b);null!=c?(void 0!=c&&null!=c.moverontile&&(c.moverontile.handleOver(),this.overGuy=c.moverontile),this.game.currentAction!=this.game.WALK||null!=this.overGuy&&!this.overGuy.IsPlayer||this.gameref.map.playerCharacter.moveto(c,{x:a,y:b})):this.overGuy=null};var InputHandlerBattle=function(a,b){InputHandler.call(this,a,b),this.playerDecide=null,this.frindges=null,this.overEnemy=null,this.battleState=null,this.pauseInput=!1};InputHandlerBattle.prototype=Object.create(InputHandler.prototype),InputHandlerBattle.constructor=InputHandlerBattle,InputHandlerBattle.prototype.onMove=function(a,b,c){if(this.doDragScreenMove(b,c),null!=this.overEnemy&&(this.overEnemy.handleOut(),this.overEnemy=null),null!=this.playerDecide&&(GlobalEvents.currentAction==GlobalEvents.WALK||GlobalEvents.currentAction==GlobalEvents.COMBATSELECT||a.active)&&!this.game.global.pause){var d=(this.gameref.input.worldX-this.gameref.map.mapGroup.x)/this.gameref.map.scaledto,e=(this.gameref.input.worldY-this.gameref.map.mapGroup.y)/this.gameref.map.scaledto,f=this.gameref.map.hexHandler.checkHex(d,e);this.withinFringes(f)?this.gameref.map.highlightHex.moveCursor(f):this.gameref.map.highlightHex.hideCursor(),void 0!=f&&null!=f.moverontile&&(this.gameref.map.highlightHex.moveCursor(f),f.moverontile.handleOver(),this.overEnemy=f.moverontile)}},InputHandlerBattle.prototype.withinFringes=function(a){for(var b=0;b<this.frindges.length;b++)for(var c=0;c<this.frindges[b].length;c++)if(a==this.frindges[b][c])return!0;return!1},InputHandlerBattle.prototype.hideInputAreas=function(){this.gameref.map.highlightHex.cleanuptiles()},InputHandlerBattle.prototype.showAreaForMove=function(a){console.log("showareaformove **"),this.frindges=a.findWalkableFromCurrent(),this.gameref.map.highlightHex.drawFringes(this.frindges)},InputHandlerBattle.prototype.clickedHex=function(a){if(this.dragScreen=!1,this.didDrag)return void(this.didDrag=!1);if(!this.pauseInput&&a.active&&null!=this.playerDecide&&(this.overEnemy&&(this.overEnemy.handleClick(a),this.overEnemy.IsPlayer&&this.clickedPlayer(this.overEnemy,a)),(GlobalEvents.currentAction==GlobalEvents.WALK||GlobalEvents.currentAction==GlobalEvents.COMBATSELECT)&&!this.game.global.pause)){var b=(this.gameref.input.worldX-this.gameref.map.mapGroup.x)/this.gameref.map.scaledto,c=(this.gameref.input.worldY-this.gameref.map.mapGroup.y)/this.gameref.map.scaledto,d=this.gameref.map.hexHandler.checkHex(b,c);null!=d&&this.game.currentAction==this.game.WALK&&this.withinFringes(d)&&(this.playerDecide.domove(d),this.gameref.map.highlightHex.cleanuptiles())}},InputHandlerBattle.prototype.clickedObject=function(a){this.pauseInput||(console.log("**** clickedObject ",a,this.playerDecide),null!=this.playerDecide&&this.playerDecide.dotouched&&this.playerDecide.dotouched(a))},InputHandlerBattle.prototype.clickedPlayer=function(a){if(!this.pauseInput){this.cleanUpPlayer();var b=this.battleState.mBattleStates.mCurrentState.findDecideByActor(a);b?b.execute():console.log("no player")}},InputHandlerBattle.prototype.highlightplayer=function(a){this.playerDecide=this.battleState.mBattleStates.mCurrentState.findDecideByActor(a),this.showAreaForMove(a)},InputHandlerBattle.prototype.cleanUpPlayer=function(){this.playerDecide=null,this.hideInputAreas()};var InputHandlerRealTimeBattle=function(a,b){InputHandler.call(this,a,b),this.playerDecide=null,this.frindges=null,this.overEnemy=null,this.battleState=null};InputHandlerRealTimeBattle.prototype=Object.create(InputHandler.prototype),InputHandlerRealTimeBattle.constructor=InputHandlerRealTimeBattle,InputHandlerRealTimeBattle.prototype.onMove=function(a,b,c){if(this.doDragScreenMove(b,c),null!=this.overEnemy&&(this.overEnemy.handleOut(),this.overEnemy=null),a.active&&!this.game.global.pause){var d=(this.gameref.input.worldX-this.gameref.map.mapGroup.x)/this.gameref.map.scaledto,e=(this.gameref.input.worldY-this.gameref.map.mapGroup.y)/this.gameref.map.scaledto,f=this.gameref.map.hexHandler.checkHex(d,e);void 0!=f&&null!=f.moverontile&&(f.moverontile.handleOver(),this.overEnemy=f.moverontile),this.gameref.map.highlightHex.moveCursor(f)}},InputHandlerRealTimeBattle.prototype.clickedHex=function(a){return a.withinGame?(this.dragScreen=!1,this.didDrag?void(this.didDrag=!1):void(a.active&&(this.overEnemy&&(this.overEnemy.handleClick(a),this.overEnemy.IsPlayer),(GlobalEvents.currentAction==GlobalEvents.WALK||GlobalEvents.currentAction==GlobalEvents.COMBATSELECT)&&(this.game.global.pause||this.handleCharMove())))):void 0},InputHandlerRealTimeBattle.prototype.clickedObject=function(a){console.log("**** clickedObject ",a,this.playerDecide),null!=this.playerDecide&&this.playerDecide.dotouched&&this.playerDecide.dotouched(a)};var DiamondHexHandler=function(a,b,c,d,e){HexHandler.call(this,a,b,c,d,e)};DiamondHexHandler.prototype=Object.create(HexHandler.prototype),DiamondHexHandler.constructor=DiamondHexHandler,DiamondHexHandler.prototype.isInsideTriangle=function(a,b,c,d){
var e=(a.x-d.x)*(b.y-d.y)-(b.x-d.x)*(a.y-d.y),f=(b.x-d.x)*(c.y-d.y)-(c.x-d.x)*(b.y-d.y),g=(c.x-d.x)*(a.y-d.y)-(a.x-d.x)*(c.y-d.y);return this.sign(e)==this.sign(f)&&this.sign(f)==this.sign(g)},DiamondHexHandler.prototype.sign=function(a){return Math.abs(a)/a},DiamondHexHandler.prototype.checkHex=function(a,b){if(this.hexagonArray){var c=this.hexagonWidth,d=this.hexagonHeight/4*3,e=a/c-b/(2*d),f=b/d+Math.floor(e/2);if(e=Math.floor(e),f=Math.floor(f),!(0>e||0>f||f>=this.maingame.map.movementgrid.gridSizeY||e>=this.maingame.map.movementgrid.gridSizeX)){var g=this.hexagonArray[e][f];if(null!=g){this.touchmap.update();var h=this.touchmap.getPixel32(a-g.x,b-g.y),i=255&h,j=h>>8&255,k=h>>16&255;if(i>0&&j>0&&k>0||0==i&&0==j&&0==k)return g;if(0==i&&j>0&&k>0?e%2==0?e++:(e++,f++):i>0&&0==j&&0==k?f--:i>0&&j>0&&0==k?e%2==0?(e++,f--):e++:0==i&&j>0&&0==k?e%2==0?e--:(e--,f--):0==i&&0==j&&k>0&&f++,!(0>e||0>f||f>=this.maingame.movementgrid.gridSizeY||e>=this.maingame.movementgrid.gridSizeX))return g=this.hexagonArray[e][f]}}}},DiamondHexHandler.prototype.areTilesNeighbors=function(a,b){if(null==a||null==b)return!1;var c=a.posx-b.posx,d=a.posy-b.posy;if(a==b)return!0;if(a.x%2==1){if(0==c&&-1==d)return!0;if(-1==c&&0==d)return!0;if(0==c&&1==d)return!0;if(1==c&&1==d)return!0;if(1==c&&0==d)return!0;if(-1==c&&1==d)return!0}else{if(-1==c&&-1==d)return!0;if(-1==c&&0==d)return!0;if(0==c&&1==d)return!0;if(1==c&&0==d)return!0;if(0==c&&-1==d)return!0;if(1==c&&-1==d)return!0}return!1},DiamondHexHandler.prototype.doFloodFill=function(a,b){if(null!=a){this.visited=[],this.visited.push(a),this.fringes=[],this.fringes.push([a]);for(var c=1;b>=c;c++){this.fringes.push([]);for(var d=0;d<this.fringes[c-1].length;d++){var e=this.fringes[c-1][d];e.posx%2==1?(this.addNeighbor(e,0,-1,c),this.addNeighbor(e,-1,0,c),this.addNeighbor(e,0,1,c),this.addNeighbor(e,1,1,c),this.addNeighbor(e,1,0,c),this.addNeighbor(e,-1,1,c)):(this.addNeighbor(e,-1,-1,c),this.addNeighbor(e,-1,0,c),this.addNeighbor(e,0,1,c),this.addNeighbor(e,1,0,c),this.addNeighbor(e,0,-1,c),this.addNeighbor(e,1,-1,c))}}return this.fringes}};var IsoHandler=function(a,b,c,d,e){HexHandler.call(this,a,b,c,d,e)};IsoHandler.prototype=Object.create(HexHandler.prototype),IsoHandler.constructor=IsoHandler,IsoHandler.prototype.checkHex=function(a,b){if(this.hexagonArray){var c=this.hexagonWidth,d=this.hexagonHeight,e=c,f=d,g=Math.floor(a/e),h=2*Math.floor(b/f),i=Math.floor(a%e),j=Math.floor(b%f);if(this.touchmap.update(),this.touchmap.getPixelRGB(i,j,this.tempcolour),255==this.tempcolour.r&&0==this.tempcolour.g&&0==this.tempcolour.b&&(g--,h--),0==this.tempcolour.r&&255==this.tempcolour.g&&0==this.tempcolour.b&&h--,0==this.tempcolour.r&&0==this.tempcolour.g&&0==this.tempcolour.b&&(g--,h++),0==this.tempcolour.r&&0==this.tempcolour.g&&255==this.tempcolour.b&&h++,-1==g&&(g=0,h++),-1==h&&(h=0,g++),g==this.maingame.map.movementgrid.gridSizeX&&(g=this.maingame.map.movementgrid.gridSizeX-1,h--),h==this.maingame.map.movementgrid.gridSizeY&&(h=this.maingame.map.movementgrid.gridSizeY-1,g--),!(0>g||0>h||h>=this.maingame.map.movementgrid.gridSizeY||g>=this.maingame.map.movementgrid.gridSizeX))return tile=this.hexagonArray[g][h],tile}},IsoHandler.prototype.areTilesNeighbors=function(a,b){if(null==a||null==b)return!1;var c=a.posx-b.posx,d=a.posy-b.posy;if(a==b)return!0;if(a.y%2==1){if(1==c&&-1==d)return!0;if(1==c&&1==d)return!0;if(0==c&&1==d)return!0;if(0==c&&-1==d)return!0}else{if(0==c&&-1==d)return!0;if(0==c&&1==d)return!0;if(-1==c&&1==d)return!0;if(-1==c&&-1==d)return!0}return!1},IsoHandler.prototype.doFloodFill=function(a,b,c,d){if(null!=a){this.visited=[],this.visited.push(a),this.fringes=[],c?(this.fringes.push([]),this.findNieghbors(a,0,d)):this.fringes.push([a]);for(var e=1;b>=e;e++){this.fringes.push([]);for(var f=0;f<this.fringes[e-1].length;f++){var g=this.fringes[e-1][f];this.findNieghbors(g,e,d)}}return this.fringes}},IsoHandler.prototype.findNieghbors=function(a,b,c){return c?void this.findNieghborsIfWalkable(a,b):void(a.posy%2==1?(this.addNeighbor(a,1,-1,b),this.addNeighbor(a,1,1,b),this.addNeighbor(a,0,1,b),this.addNeighbor(a,0,-1,b)):(this.addNeighbor(a,0,-1,b),this.addNeighbor(a,0,1,b),this.addNeighbor(a,-1,1,b),this.addNeighbor(a,-1,-1,b)))},IsoHandler.prototype.findNieghborsIfWalkable=function(a,b){a.posy%2==1?(this.addNeighborTestWalkable(a,1,-1,b),this.addNeighborTestWalkable(a,1,1,b),this.addNeighborTestWalkable(a,0,1,b),this.addNeighborTestWalkable(a,0,-1,b)):(this.addNeighborTestWalkable(a,0,-1,b),this.addNeighborTestWalkable(a,0,1,b),this.addNeighborTestWalkable(a,-1,1,b),this.addNeighborTestWalkable(a,-1,-1,b))},IsoHandler.prototype.addNeighborTestWalkable=function(a,b,c,d){var e=a.posx+b,f=a.posy+c,g=this.getTileByCords(e,f);null!=g&&(g.walkHandler.isWalkable(a.posx,a.posy,b,c)&&-1==this.visited.indexOf(g)&&this.fringes[d].push(g),this.visited.push(g))};var HighlightHex=function(a,b,c){Phaser.Group.call(this,a,null),this.game=a,this.maingame=b,this.hexhandler=c,this.showNumbers=!1,this.neighborLights=[],this.showPath=!0,this.type="Iso",this.cursor};HighlightHex.prototype=Object.create(Phaser.Group.prototype),HighlightHex.constructor=HighlightHex,HighlightHex.prototype.setup=function(){this.neighborLights=[];for(var a=0;210>a;a++){var b,c=this.add(new Phaser.Group(this.game,null));if(b=this.add("HexIso"==this.hexhandler.tiletype?new Phaser.Sprite(this.game,0,0,"standardimages","tile_highlight0002"):new Phaser.Sprite(this.game,0,0,"standardimages","halfiso_highlight")),this.neighborLights.push(c),c.add(b),this.add(c),this.showNumbers){var d=new Phaser.Text(this.game,0,-this.hexhandler.halfHexHeight,a+"",{});d.font="arial",d.fontSize=12,c.add(d),c.x=-1e3}c.x=-1e3,c.visible=!1}var b;this.cursor=this.add(new Phaser.Group(this.game,null)),b=this.add("HexIso"==this.hexhandler.tiletype?new Phaser.Sprite(this.game,0,0,"standardimages","tile_highlight0002"):new Phaser.Sprite(this.game,0,0,"standardimages","halfiso_highlight")),this.cursor.add(b),this.cursor.x=-1e3,this.add(this.cursor)},HighlightHex.prototype.drawFringes=function(a){if(null!=a){this.cleanuptiles();for(var b=[],c=0;c<a.length;c++)for(var d=0;d<a[c].length;d++)b.push(a[c][d]);for(var c=0;c<b.length;c++)this.highlighttilebytile(c,b[c])}},HighlightHex.prototype.doShowPath=function(a,b,c){null!=c&&b&&(this.showPath=!0,a.setCallbackFunction(this.showPathCallback,this),a.preparePathCalculation([b.posx,b.posy],[c.posx,c.posy]),a.calculatePath())},HighlightHex.prototype.showPathCallback=function(a){if(this.showPath&&(this.cleanuptiles(),null!=a&&0!=a.length))for(var b=0;b<a.length;b++){var c=this.hexhandler.getTileByCords(a[b].x,a[b].y);null!=c&&this.highlighttilebytile(b,c)}},HighlightHex.prototype.hidePath=function(){this.showPath=!1},HighlightHex.prototype.drawDebugLine=function(a,b){moveIndex&&b&&this.hexHandler.dolines(a,b,!1,this)},HighlightHex.prototype.highilightneighbors=function(a){null!=a&&("Iso"==this.type&&(a.posy%2==1?(this.highlighttileoffset(0,1,-1,a),this.highlighttileoffset(1,1,1,a),this.highlighttileoffset(2,0,1,a),this.highlighttileoffset(3,0,-1,a)):(this.highlighttileoffset(0,0,-1,a),this.highlighttileoffset(1,0,1,a),this.highlighttileoffset(2,-1,1,a),this.highlighttileoffset(3,-1,-1,a))),"HexIsoFallout"==this.type&&(a.posx%2==1?(this.highlighttileoffset(0,0,-1,a),this.highlighttileoffset(1,-1,0,a),this.highlighttileoffset(2,0,1,a),this.highlighttileoffset(3,1,1,a),this.highlighttileoffset(4,1,0,a),this.highlighttileoffset(5,-1,1,a)):(this.highlighttileoffset(0,-1,-1,a),this.highlighttileoffset(1,-1,0,a),this.highlighttileoffset(2,0,1,a),this.highlighttileoffset(3,1,0,a),this.highlighttileoffset(4,0,-1,a),this.highlighttileoffset(5,1,-1,a))))},HighlightHex.prototype.highlighttileoffset=function(a,b,c,d){var e=this.hexhandler.getTileByCords(d.posx+b,d.posy+c);null!=e&&(this.neighborLights[a].visible=!0,this.neighborLights[a].x=e.x,this.neighborLights[a].y=e.y-this.hexhandler.bottomOffset)},HighlightHex.prototype.cleanuptiles=function(){for(var a=0;a<this.neighborLights.length;a++)this.neighborLights[a].x=-1e3,this.neighborLights[a].visible=!1},HighlightHex.prototype.moveCursor=function(a){null!=this.cursor&&(null!=a?(this.cursor.visible=!0,this.cursor.x=a.x,this.cursor.y=a.y-this.hexhandler.bottomOffset):(this.cursor.x=-1e3,this.cursor.y=0))},HighlightHex.prototype.hideCursor=function(){this.cursor.visible=!1},HighlightHex.prototype.highlighttilebytile=function(a,b){null!=this.neighborLights[a]&&(null!=b?(this.neighborLights[a].visible=!0,this.neighborLights[a].x=b.x,this.neighborLights[a].y=b.y-this.hexhandler.bottomOffset):(this.neighborLights[a].x=-1e3,this.neighborLights[a].y=0))};var Map=function(a,b){this.gameRef=b,this.game=a,this.playerCharacter,this.playerCharacters=[],this.highlightHex,this.hexHandler,this.startpos,this.interactiveObjects=[],this.staticObjects=[],this.paths=[],this.maskableobjects,this.spritegrid,this.movementgrid,this.objectoffset=new Point(0,0),this.highlightArray,this.mapGroup,this.scaledto=1,this.redoMap=!1};Map.prototype.initialMap=function(a,b,c){this.mapData=a,this.gameData=b,this.playerData=c,this.startpos=this.mapData.startPos;var d=this.mapData.maps[this.startpos.map];this.objectGroup=this.gameRef.add.group(),this.highlightGroup=this.gameRef.add.group(),this.hexagonGroup=this.gameRef.add.group(),this.mapGroup=this.gameRef.add.group(),this.mapGroup.add(this.hexagonGroup),this.mapGroup.add(this.highlightGroup),this.mapGroup.add(this.objectGroup),this.clonedCurrent=JSON.parse(JSON.stringify(d)),this.createMapTiles(d)},Map.prototype.createMapTiles=function(a){var b=[];this.interactiveObjects=[],this.staticObjects=[],this.maskableobjects=[],this.walkableArray=[];var c;for(c=0;c<a.length;c++){var d=a[c];if(d.handleMovement){var e=d.hexWidth,f=d.hexHeight;this.objectoffset.x=e/2,this.objectoffset.y=f,console.log("height width ",e,f)}}for(c=0;c<a.length;c++){var d=a[c];d.handleMovement&&(this.hexHandler="Iso"==d.tiletype?new IsoHandler(this.gameRef,this.game,d.hexWidth,d.hexHeight,d.tiletype):"HexIso"==d.tiletype?new DiamondHexHandler(this.gameRef,this.game,d.hexWidth,d.hexHeight,d.tiletype):new HexHandler(this.gameRef,this.game,d.hexWidth,d.hexHeight,d.tiletype));var e=d.hexWidth,f=d.hexHeight;this.gridSizeY=d.height,this.gridSizeX=d.width;{var g=d.data,h=d.tilesetid;d.offsetx||0,d.offsety||0,d.tiletype}d.handleMovement&&(this.movementgrid=new Grid(this,d)),d.handleSprite&&(this.spritegrid=new Grid(this,d));var i,j,k,l=new Point(0,0);if(d.handleSprite)for(var m=0;m<this.gridSizeX;m++){d.handleMovement&&(b[m]=[]);for(var n=0;n<this.gridSizeY;n++){if(i=g[n*this.gridSizeX+m],j=this.getTile(i,h),l=this.spritegrid.GetMapCoords(m,n),d.handleMovement){{this.spritegrid.projectGrid(m,n)}k=new WalkableTile(this.game,j.tile,j.spritesheet,m,n,l.x,l.y,this.gameRef),b[m][n]=k}else k=new GraphicTile(this.game,j.tile,j.spritesheet,m,n,l.x,l.y,this.gameRef);this.hexagonGroup.add(k)}}if(this.highlightArray=[],d.handleMovement)for(var m=0;m<this.gridSizeX;m++){d.handleSprite||(b[m]=[],this.highlightArray[m]=[]),this.walkableArray[m]=[];for(var n=0;n<this.gridSizeY;n++)this.walkableArray[m][n]=new Walkable(d.walkable[n*this.gridSizeX+m]),d.handleSprite||(l=this.movementgrid.GetMapCoords(m,n),b[m][n]=new SimpleTile(this.gameRef,m,n,l.x,l.y)),b[m][n].walkHandler=this.walkableArray[m][n]}if(d.objects)for(var o=d.objects,m=0;m<o.length;m++)if(o[m].triggers){if(!o[m].destroyed){for(var p=!1,q=!1,n=0;n<o[m].triggers.length;n++){if("combatAttributes"==o[m].triggers[n].type||"CharacterSpawn"==o[m].triggers[n].type){q=!0;break}if("mover"==o[m].triggers[n].type){p=!0;break}}var r;r=q?new MonsterCharacter(this.gameRef,o[m],this):p?new MovingCharacter(this.gameRef,o[m],this):new InteractiveObject(this.gameRef,o[m],this),this.interactiveObjects.push(r),r.posx=o[m].posx,r.posy=o[m].posy}}else{var s=this.getTile(o[m].name,o[m].tilesetid);if(null!=s){l=this.spritegrid.GetMapCoords(o[m].posx,o[m].posy);var t=new SimpleObject(this.game,l.x+this.objectoffset.x,l.y+this.objectoffset.y,s.spritesheet,s.tile+"",o[m]);t.posx=o[m].posx,t.posy=o[m].posy,this.objectGroup.add(t),this.staticObjects.push(t),o[m].maskable&&this.maskableobjects.push(t)}}var u=d.actionSpots;if(u)for(var m=0;m<u.length;m++){var v=b[u[m].x][u[m].y];v&&(v.eventDispatcher||(v.eventDispatcher=new EventDispatcher(this.game,this.gameRef,v)),v.eventDispatcher.receiveData(u[m].triggers))}if(d.paths)for(var w=d.paths,m=0;m<w.length;m++){var x=new Path(this.game,this.gameRef,w[m]);this.paths[x.name]=x}}this.hexHandler.hexagonArray=b,this.highlightHex=new HighlightHex(this.game,this.gameRef,this.hexHandler),this.highlightHex.setup(),this.highlightGroup.add(this.highlightHex);for(var m=0;m<this.interactiveObjects.length;m++)this.interactiveObjects[m]&&this.interactiveObjects[m].dosetup();for(var m=0;m<this.staticObjects.length;m++)this.staticObjects[m]&&this.staticObjects[m].dosetup(this.hexHandler);if(!this.playerCharacter)for(var y=0;1>y;y++)this.playerCharacter=new PlayerCharacter(this.gameRef,this.playerData.Player,this),this.playerCharacter.dosetup(),this.playerCharacters.push(this.playerCharacter);for(var y=0;y<this.playerCharacters.length;y++)this.playerCharacter=this.playerCharacters[y],this.playerCharacter.setLocationByTile(b[this.startpos.x][this.startpos.y+y]),this.game.add.existing(this.playerCharacter),this.objectGroup.add(this.playerCharacter),this.playerCharacter.resetMoving();this.gameRef.pathfinder.setGrid(this.walkableArray,[1]),this.masker=new CheapMasker(this.game,this.gameRef,this.maskableobjects),this.doZoom(this.scaledto),this.hexagonGroup.sort("y",Phaser.Group.SORT_ASCENDING);for(var m=0;m<this.interactiveObjects.length;m++)this.interactiveObjects[m].eventDispatcher&&this.interactiveObjects[m].eventDispatcher.doAction("OnStart",null);this.redoMap=!1},Map.prototype.doZoom=function(a){this.scaledto,this.mapGroup.width,this.mapGroup.height;this.scaledto=a,this.mapGroup.scale.setTo(this.scaledto,this.scaledto)},Map.prototype.update=function(a){if(!this.redoMap){if(this.hexHandler.update(a),!this.game.global.pause)for(var b=0;b<this.playerCharacters.length;b++)this.playerCharacters[b].step(a);for(var c=0;c<this.interactiveObjects.length;c++)this.interactiveObjects[c].step(a);this.objectGroup.customSort(Utilties.customSortIso)}},Map.prototype.getCombatCharacters=function(){for(var a=[],b=0;b<this.interactiveObjects.length;b++)(this.interactiveObjects[b].attackable||this.interactiveObjects[b].hostile||this.interactiveObjects[b].IsPlayer)&&this.interactiveObjects[b].isAlive()&&a.push(this.interactiveObjects[b]);return a},Map.prototype.addLocationTextToTile=function(a,b,c,d,e,f){var g=this.gameRef.add.text(a+c/2-5,b+d/2+3,e+","+f);g.font="arial",g.fontSize=10,this.highlightGroup.add(g)},Map.prototype.flushEntireMap=function(){for(var a=0;a<this.interactiveObjects.length;a++)this.interactiveObjects[a]&&this.interactiveObjects[a].flushAll();this.interactiveObjects=[];for(var b=0;b<this.playerCharacters.length;b++)this.objectGroup.remove(this.playerCharacters[b]);this.hexagonGroup.removeAll(!0),this.highlightGroup.removeAll(!0),this.objectGroup.removeAll(!0),this.paths=[],this.hexHandler.flush()},Map.prototype.getTile=function(a,b){return 0>b||void 0==a||void 0==b||-1==a?null:{tile:this.mapData.tileSets[b][a],spritesheet:this.mapData.tileSets[b].tileset}},Map.prototype.userExit=function(a,b){this.gameRef.gGameMode.change("normal"),this.redoMap=!0,this.startpos.map=b.tmap,this.startpos.x=b.tx,this.startpos.y=b.ty,GlobalEvents.flushEvents(),this.flushEntireMap();var c=this.mapData.maps[this.startpos.map];console.log("build new-- "),this.createMapTiles(c)},Map.prototype.tryMapAgain=function(){this.redoMap=!0,this.mapData.maps[this.startpos.map]=this.clonedCurrent,GlobalEvents.flushEvents(),this.flushEntireMap(),this.createMapTiles(this.clonedCurrent)},Map.prototype.refreshWalkablView=function(){for(var a=0;a<this.gridSizeX;a++)for(var b=0;b<this.gridSizeY;b++){var c=this.hexHandler.hexagonArray[a][b];c.tint="0x"+this.walkableArray[a][b].hex+this.walkableArray[a][b].hex+this.walkableArray[a][b].hex+this.walkableArray[a][b].hex+this.walkableArray[a][b].hex+this.walkableArray[a][b].hex}},Map.prototype.doSight=function(a,b){for(var c=this.hexHandler.doFloodFill(a,b,!1,!1),d=0;d<c.length;d++)for(var e=0;e<c[d].length;e++)c[d][e].adjustVisible(d==c.length-1?.3:1)},Map.prototype.getPath=function(a){return this.paths[a]};var OtherMap=function(a){this.maingame=a,this.game=a.game,this.walkableArray=[],this.interactiveObjectDatas=[]},Path=function(a,b,c){this.game=a,this.gameref=b,this.name=c.name,this.pathData=c.path,this.pathPoints=[];for(var d=0;d<this.pathData.length;d++)this.pathPoints[this.pathData[d].name]=this.pathData[d],this.pathData[d].triggers&&(this.pathData[d].eventDispatcher||(this.pathData[d].eventDispatcher=new EventDispatcher(this.game,this.gameRef,this.pathData[d])),this.pathData[d].eventDispatcher.receiveData(this.pathData[d].triggers))};Path.prototype.initialPath=function(){},Path.prototype.getNextPoint=function(a){return null==a.next?null:this.pathPoints[a.next]},Path.prototype.getPointByName=function(a){return this.pathPoints[a]};var PlayerCamera=function(a,b){this.game=a,this.gameref=b,this.following=null,this.movespeed=1,this.followMapBoundaries=!1};PlayerCamera.prototype.moveTo=function(){},PlayerCamera.prototype.jumpTo=function(a,b){this.gameref.map.mapGroup.x=a,this.gameref.map.mapGroup.y=b},PlayerCamera.prototype.setFollowObject=function(a){this.following=a},PlayerCamera.prototype.stopFollow=function(){this.following=null},PlayerCamera.prototype.adjustPosition=function(a,b){this.gameref.map.mapGroup.x+=a,this.gameref.map.mapGroup.y+=b},PlayerCamera.prototype.step=function(){if(null!=this.following){var a=this.game.world.width/2-this.following.x*this.gameref.map.scaledto,b=this.game.world.height/2-this.following.y*this.gameref.map.scaledto;this.jumpTo(a,b)}},PlayerCamera.prototype.setinit=function(){var a=this.gameref.map.mapGroup,b=this.gameref.map;a.x=this.game.world.width/2-b.objectoffset.x*b.gridSizeX*a.scale.x,a.y=this.game.world.height/2-b.objectoffset.y/2*b.gridSizeY/2*a.scale.y};var SimpleObject=function(a,b,c,d,e,f){"undefined.png"==e&&(e="bushSand.png"),Phaser.Image.call(this,a,b,c,d,e),this.gameref=a,this.posx,this.posy,this.anchor.x=.5,this.anchor.y=1,this.iso=new Vec3(f.x,f.y,f.z),this.isoorder=f.order,this.y+=-50*this.iso.y,Global.doShadows&&this.adjustVisible(0)};SimpleObject.prototype=Object.create(Phaser.Image.prototype),SimpleObject.constructor=SimpleObject,SimpleObject.prototype.adjustVisible=function(a){this.tint=16777215*a},SimpleObject.prototype.dosetup=function(a){var b=a.getTileByCords(this.posx,this.posy);null!=b&&b.staticobjects.push(this)};var Walkable=function(a){var b=Number(a).toString(2);this.l=1e3&b?1:0,this.u=100&b?1:0,this.r=10&b?1:0,this.d=1&b?1:0,this.hex=parseInt(a,10).toString(16),this.walkable=!0,0==this.l&&0==this.u&&0==this.r&&0==this.d&&(this.walkable=!1)};Walkable.prototype.isWalkable=function(a,b,c,d){if(!this.walkable)return 0;if(b%2==1){if(1==c&&-1==d)return this.u;if(1==c&&1==d)return this.r;if(0==c&&1==d)return this.d;if(0==c&&-1==d)return this.l}else{if(0==c&&-1==d)return this.u;if(0==c&&1==d)return this.r;if(-1==c&&1==d)return this.l;if(-1==c&&-1==d)return this.d}return 1};var Grid=function(a,b){this.maingame=a,this.width=b.hexWidth,this.height=b.hexHeight,this.gridSizeY=b.height,this.gridSizeX=b.width,this.offsetx=b.offsetx||0,this.offsety=b.offsety||0,this.type=b.tiletype,this.coords=new Point(0,0)};Grid.prototype.projectIso=function(a,b,c){return{x:Math.floor((a-c)/2),y:Math.abs(a+c)}},Grid.prototype.projectGrid=function(a,b){var c=Math.floor(b/2-a),d=b-c;return c=-1*c,d=-1*Math.abs(d),new Vec3(c,0,d)},Grid.prototype.GetMapCoords=function(a,b){if("Hex"==this.type)this.coords.x=this.width*a,this.coords.x+=this.width/2*(b%2),this.coords.y=this.height/4*3*b;else if("HexIso"==this.type){var c=Math.floor(a/2);this.coords.x=this.width*a+this.width/2*b,this.coords.y=this.height/4*3*b,this.coords.x-=this.width/2*c,this.coords.y-=this.height/4*3*c}else"Iso"==this.type?(this.coords.x=a*this.width+b%2*(this.width/2),this.coords.y=b*(this.height/2)):"HexIsoFallout"==this.type?(this.coords.x=48*a+32*b,this.coords.y=-24*b+12*a,this.coords.y*=-1,this.coords.x+=16,this.coords.y-=4):(this.coords.x=0,this.coords.y=0);return this.coords},Grid.prototype.PosToMap=function(a,b){if(void 0==this.coords&&(this.coords=new Point),"HexIsoFallout"==this.type)a-=16,b+=4,a-=40,b-=16,b*=-1,i=(3*a+4*b)/192,j=(a-4*b)/128,this.coords.x=Math.round(i),this.coords.y=Math.round(j);else if("Iso"==this.type){var c=this.maingame.hexHandler.checkHex(a,b);void 0!=c?(this.coords.x=c.posx,this.coords.y=c.posy):(this.coords.x=-1,this.coords.y=-1)}else this.coords.x=-1,this.coords.y=-1;return this.coords};var SimpleTile=function(a,b,c,d,e){this.maingame=a,this.walkable=!0,this.walkHandler,this.openair=!0,this.x=d,this.y=e,this.posx=b,this.posy=c,this.moverontile=null};SimpleTile.prototype.callFunction=function(a,b){var c=window[a];"function"==typeof c&&c.apply(null,b)},SimpleTile.prototype.changeWalkable=function(a,b){console.log("updatewalkable",this.maingame.updatewalkable),walkHandler.walkable=1==a||"true"==a?1:0,this.moverontile=null!=b?b:null,this.walkable=walkHandler.walkable,this.maingame.updatewalkable=!0},SimpleTile.prototype.fillTile=function(){console.log("updatewalkable fillTile",this.maingame.updatewalkable)},SimpleTile.prototype.enterTile=function(a){this.eventDispatcher&&this.eventDispatcher.doAction("OnEnter",a),this.moverontile=a},SimpleTile.prototype.leaveTile=function(a){this.eventDispatcher&&this.eventDispatcher.doAction("OnLeave",a),this.moverontile=null};var GraphicTile=function(a,b,c,d,e,f,g,h){Phaser.Image.call(this,a,f,g,c,b),this.game=a,this.maingame=h};GraphicTile.prototype=Object.create(Phaser.Image.prototype),GraphicTile.constructor=GraphicTile;var BaseTile=function(a,b,c,d,e,f,g,h){Phaser.Sprite.call(this,a,f,g,c,b),this.game=a,this.maingame=h,this.iso=null,this.isoorder=-1,this.staticobjects=[]};BaseTile.prototype=Object.create(Phaser.Sprite.prototype),BaseTile.constructor=BaseTile,BaseTile.prototype.callFunction=function(a,b){var c=window[a];"function"==typeof c&&c.apply(null,b)},BaseTile.prototype.changeWalkable=function(a,b){this.maingame.map.walkableArray[this.posx][this.posy].walkable=a?!0:!1,this.walkable=a,this.maingame.updatewalkable=!0,this.moverontile=null!=b?b:null},BaseTile.prototype.adjustVisible=function(a){if(this.tint=16777215*a,this.staticobjects.length>0)for(var b=0;b<this.staticobjects.length;b++)this.staticobjects[b]&&this.staticobjects[b].adjustVisible(a)};var WalkableTile=function(a,b,c,d,e,f,g,h){BaseTile.call(this,a,b,c,d,e,f,g,h),this.walkable=!0,this.openair=!0,this.posx=d,this.posy=e,this.eventDispatcher,Global.doShadows&&this.adjustVisible(.2)};WalkableTile.prototype=Object.create(BaseTile.prototype),WalkableTile.constructor=WalkableTile,WalkableTile.prototype.enterTile=function(a){this.eventDispatcher&&this.eventDispatcher.doAction("OnEnter",a),this.moverontile=a},WalkableTile.prototype.leaveTile=function(a){this.eventDispatcher&&this.eventDispatcher.doAction("OnLeave",a),this.moverontile=null};var WaterTile=function(a,b,c,d,e,f,g){Phaser.Sprite.call(this,a,f,g,c,b),this.game=a,this.posx=d,this.posy=e,this.walkable=!1,this.openair=!0,this.starty=g,this.wavemax=-5,this.maxoffsetmax=5,this.maxoffsetmin=0,this.speed=.003,this.direction=1,this.waveSpeed=0,this.y+=this.game.rnd.integerInRange(this.maxoffsetmin,this.maxoffsetmax),this.game.rnd.frac()<.5&&(this.direction=-1),this.level()};WaterTile.prototype=Object.create(Phaser.Sprite.prototype),WaterTile.constructor=WaterTile,WaterTile.prototype.level=function(){var a=this.y;a<this.starty+this.maxoffsetmin&&(this.direction=1),a>this.starty+this.maxoffsetmax&&(this.direction=-1,this.waveSpeed=0)},WaterTile.prototype.step=function(a){this.y+=this.y<this.starty+this.wavemax?this.direction*this.speed*a:this.direction*this.speed*a,this.game.rnd.frac()<.01&&(this.direction*=-1),this.level()},WaterTile.prototype.hitByWave=function(a){this.y+=a,this.starty+this.wavemax>this.tileImage&&(this.y=this.starty+this.wavemax),this.level()};var EasyStarHex=EasyStarHex||{};"function"==typeof define&&define.amd&&define("easystar",[],function(){return EasyStarHex}),"undefined"!=typeof module&&module.exports&&(module.exports=EasyStarHex),EasyStarHex.Node=function(a,b,c,d,e){this.parent=a,this.x=b,this.y=c,this.costSoFar=d,this.simpleDistanceToTarget=e,this.bestGuessDistance=function(){return this.costSoFar+this.simpleDistanceToTarget}},EasyStarHex.Node.OPEN_LIST=0,EasyStarHex.Node.CLOSED_LIST=1,EasyStarHex.PriorityQueue=function(a,b){this.length=0;var c=[],d=!1;if(b==EasyStarHex.PriorityQueue.MAX_HEAP)d=!0;else{if(b!=EasyStarHex.PriorityQueue.MIN_HEAP)throw b+" not supported.";d=!1}this.insert=function(b){if(!b.hasOwnProperty(a))throw"Cannot insert "+b+" because it does not have a property by the name of "+a+".";c.push(b),this.length++,e(this.length-1)},this.getHighestPriorityElement=function(){return c[0]},this.shiftHighestPriorityElement=function(){if(0===this.length)throw"There are no more elements in your priority queue.";if(1===this.length){var a=c[0];return c=[],this.length=0,a}var b=c[0],d=c.pop();return this.length--,c[0]=d,f(0),b};var e=function(a){if(0!==a){var b=i(a);h(a,b)&&(g(a,b),e(b))}},f=function(a){var b=j(a),c=k(a);if(h(b,a))g(a,b),f(b);else if(h(c,a))g(a,c),f(c);else{if(0==a)return;f(0)}},g=function(a,b){var d=c[a];c[a]=c[b],c[b]=d},h=function(b,e){if(void 0===c[e]||void 0===c[b])return!1;var f,g;return"function"==typeof c[b][a]?(f=c[b][a](),g=c[e][a]()):(f=c[b][a],g=c[e][a]),d?f>g?!0:!1:g>f?!0:!1},i=function(a){return Math.floor(a/2)-1},j=function(a){return 2*a+1},k=function(a){return 2*a+2}},EasyStarHex.PriorityQueue.MAX_HEAP=0,EasyStarHex.PriorityQueue.MIN_HEAP=1,EasyStarHex.instance=function(){this.isDoneCalculating=!0,this.pointsToAvoid={},this.startX,this.callback,this.callbackObj,this.startY,this.endX,this.endY,this.nodeHash={},this.openList,this.endwalkable},EasyStarHex.js=function(){var a,b,c,d=10,e={},f={},g=[],h=Number.MAX_VALUE;this.setAcceptableTiles=function(a){a instanceof Array?c=a:!isNaN(parseFloat(a))&&isFinite(a)&&(c=[a])},this.setGrid=function(b){a=b;for(var c=0;c<a[0].length;c++)for(var d=0;d<a.length;d++)f[a[d][c]]||(f[a[d][c]]=1)},this.setTileCost=function(a,b){f[a]=b},this.setIterationsPerCalculation=function(a){h=a},this.avoidAdditionalPoint=function(a,b){e[a+"_"+b]=1},this.stopAvoidingAdditionalPoint=function(a,b){delete e[a+"_"+b]},this.stopAvoidingAllAdditionalPoints=function(){e={}},this.findPath=function(b,e,f,h,i,j){if(void 0===c)throw new Error("You can't set a path without first calling setAcceptableTiles() on EasyStarHex.");if(void 0===a)throw new Error("You can't set a path without first calling setGrid() on EasyStarHex.");if(0>b||0>e||0>f||0>f||b>a.length-1||e>a[0].length-1||f>a.length-1||h>a[0].length-1)throw new Error("Your start or end point is outside the scope of your grid.");if(b===f&&e===h)return void i.apply(j,[[]]);for(var l=a[f][h],m=!1,n=0;n<c.length;n++)if(l===c[n]){m=!0;break}var o=new EasyStarHex.instance;o.openList=new EasyStarHex.PriorityQueue("bestGuessDistance",EasyStarHex.PriorityQueue.MIN_HEAP),o.isDoneCalculating=!1,o.nodeHash={},o.startX=b,o.startY=e,o.endX=f,o.endY=h,o.callback=i,o.callbackObj=j,o.endwalkable=m,o.openList.insert(k(o,o.startX,o.startY,null,d)),g.push(o)},this.calculate=function(){if(0!==g.length&&void 0!==a&&void 0!==c)for(b=0;h>b;b++){if(0===g.length)return;if(0!==g[0].openList.length){var d=g[0].openList.shiftHighestPriorityElement();if(d.list=EasyStarHex.Node.CLOSED_LIST,d.x%2==1){if(i(d,0,-1))continue;if(i(d,-1,0))continue;if(i(d,0,1))continue;if(i(d,1,1))continue;if(i(d,1,0))continue;if(i(d,-1,1))continue}else{if(i(d,-1,-1))continue;if(i(d,-1,0))continue;if(i(d,0,1))continue;if(i(d,1,0))continue;if(i(d,0,-1))continue;if(i(d,1,-1))continue}}else g[0].callback.apply(g[0].callbackObj,[[]]),g.shift()}};var i=function(b,c,e){return b.x+c>-1&&b.x+c<a.length&&b.y+e>-1&&b.y+e<a[0].length&&j(g[0],b,c,e,d*f[a[b.x+c][b.y+e]]),g[0].isDoneCalculating===!0?(g.shift(),!0):!1},j=function(b,d,f,g,h){var i=d.x+f,j=d.y+g;if(void 0===e[i+"_"+j]){if(b.endX===i&&b.endY===j){b.isDoneCalculating=!0;var l=[],m=0;b.endwalkable&&(l[m]={x:i,y:j},m++),l[m]={x:d.x,y:d.y},m++;for(var n=d.parent;null!=n;)l[m]={x:n.x,y:n.y},m++,n=n.parent;l.reverse(),b.callback.apply(b.callbackObj,[l])}for(var o=0;o<c.length;o++)if(a[i][j]===c[o]){var p=k(b,i,j,d,h);void 0===p.list?(p.list=EasyStarHex.Node.OPEN_LIST,b.openList.insert(p)):p.list===EasyStarHex.Node.OPEN_LIST&&d.costSoFar+h<p.costSoFar&&(p.costSoFar=d.costSoFar+h,p.parent=d);break}}},k=function(a,b,c,d,e){if(void 0!==a.nodeHash[b+"_"+c])return a.nodeHash[b+"_"+c];var f=l(b,c,a.endX,a.endY);if(null!==d)var g=d.costSoFar+e;else g=f;var h=new EasyStarHex.Node(d,b,c,g,f);return a.nodeHash[b+"_"+c]=h,h},l=function(a,b,c,e){return Math.sqrt(Math.abs(c-a)*Math.abs(c-a)+Math.abs(e-b)*Math.abs(e-b))*d}},Phaser.Plugin.PathFinderPlugin=function(a){if("object"!=typeof EasyStarHex)throw new Error("Easystar is not defined!");this.parent=a,this._easyStarHex=new EasyStarHex.js,this._grid=null,this._callback=null,this._callbackObj=null,this._prepared=!1,this._walkables=[0]},Phaser.Plugin.PathFinderPlugin.prototype=Object.create(Phaser.Plugin.prototype),Phaser.Plugin.PathFinderPlugin.prototype.constructor=Phaser.Plugin.PathFinderPlugin,Phaser.Plugin.PathFinderPlugin.prototype.setGrid=function(a,b,c){c=c||null,this._grid=[];for(var d=0;d<a.length;d++){this._grid[d]=[];for(var e=0;e<a[d].length;e++)this._grid[d][e]=a[d][e]?a[d][e]:0}for(this._walkables=b,this._easyStarHex.setGrid(this._grid),this._easyStarHex.setAcceptableTiles(this._walkables),d=0;d<b.length;d++)this.setTileCost(b[d],1);null!==c&&this._easyStarHex.setIterationsPerCalculation(c)},Phaser.Plugin.PathFinderPlugin.prototype.setTileCost=function(a,b){this._easyStarHex.setTileCost(a,b)},Phaser.Plugin.PathFinderPlugin.prototype.setCallbackFunction=function(a,b){this._callback=a,this._callbackObj=b},Phaser.Plugin.PathFinderPlugin.prototype.preparePathCalculation=function(a,b){if(null===this._callback||"function"!=typeof this._callback)throw new Error("No Callback set!");var c=a[0],d=a[1],e=b[0],f=b[1];this._easyStarHex.findPath(c,d,e,f,this._callback,this._callbackObj),this._prepared=!0},Phaser.Plugin.PathFinderPlugin.prototype.calculatePath=function(){if(null===this._prepared)throw new Error("no Calculation prepared!");this._easyStarHex.calculate()};var EasyStar=EasyStar||{};"function"==typeof define&&define.amd&&define("easystar",[],function(){return EasyStar}),"undefined"!=typeof module&&module.exports&&(module.exports=EasyStar),EasyStar.Node=function(a,b,c,d,e){this.parent=a,this.x=b,this.y=c,this.costSoFar=d,this.simpleDistanceToTarget=e,this.bestGuessDistance=function(){return this.costSoFar+this.simpleDistanceToTarget}},EasyStar.Node.OPEN_LIST=0,EasyStar.Node.CLOSED_LIST=1,EasyStar.PriorityQueue=function(a,b){this.length=0;var c=[],d=!1;if(b==EasyStar.PriorityQueue.MAX_HEAP)d=!0;else{if(b!=EasyStar.PriorityQueue.MIN_HEAP)throw b+" not supported.";d=!1}this.insert=function(b){if(!b.hasOwnProperty(a))throw"Cannot insert "+b+" because it does not have a property by the name of "+a+".";c.push(b),this.length++,e(this.length-1)},this.getHighestPriorityElement=function(){return c[0]},this.shiftHighestPriorityElement=function(){if(0===this.length)throw"There are no more elements in your priority queue.";if(1===this.length){var a=c[0];return c=[],this.length=0,a}var b=c[0],d=c.pop();return this.length--,c[0]=d,f(0),b};var e=function(a){if(0!==a){var b=i(a);h(a,b)&&(g(a,b),e(b))}},f=function(a){var b=j(a),c=k(a);if(h(b,a))g(a,b),f(b);else if(h(c,a))g(a,c),f(c);else{if(0==a)return;f(0)}},g=function(a,b){var d=c[a];c[a]=c[b],c[b]=d},h=function(b,e){if(void 0===c[e]||void 0===c[b])return!1;var f,g;return"function"==typeof c[b][a]?(f=c[b][a](),g=c[e][a]()):(f=c[b][a],g=c[e][a]),d?f>g?!0:!1:g>f?!0:!1;

},i=function(a){return Math.floor(a/2)-1},j=function(a){return 2*a+1},k=function(a){return 2*a+2}},EasyStar.PriorityQueue.MAX_HEAP=0,EasyStar.PriorityQueue.MIN_HEAP=1,EasyStar.instance=function(){this.isDoneCalculating=!0,this.pointsToAvoid={},this.startX,this.callback,this.startY,this.endX,this.endY,this.nodeHash={},this.openList,this.endwalkable},EasyStar.js=function(){var a,b,c,d=10,e=12,f=!1,g={},h={},i={},j=!0,k=[],l=Number.MAX_VALUE,m=!0;this.setAcceptableTiles=function(a){a instanceof Array?c=a:!isNaN(parseFloat(a))&&isFinite(a)&&(c=[a])},this.enableSync=function(){f=!0},this.disableSync=function(){f=!1},this.enableDiagonals=function(){m=!0},this.disableDiagonals=function(){m=!1},this.setGrid=function(b){a=b;for(var c=0;c<a[0].length;c++)for(var d=0;d<a.length;d++)h[a[d][c]]||(h[a[d][c]]=1)},this.setTileCost=function(a,b){h[a]=b},this.setAdditionalPointCost=function(a,b,c){i[a+"_"+b]=c},this.removeAdditionalPointCost=function(a,b){delete i[a+"_"+b]},this.removeAllAdditionalPointCosts=function(){i={}},this.setIterationsPerCalculation=function(a){l=a},this.avoidAdditionalPoint=function(a,b){g[a+"_"+b]=1},this.stopAvoidingAdditionalPoint=function(a,b){delete g[a+"_"+b]},this.enableCornerCutting=function(){j=!0},this.disableCornerCutting=function(){j=!1},this.stopAvoidingAllAdditionalPoints=function(){g={}},this.findPath=function(b,e,g,h,i,j){this.debug&&console.log("findPath ",b,e,g,h);var l=function(a){f?i.apply(j,[a]):setTimeout(function(){i.apply(j,[a])})};if(void 0===c)throw new Error("You can't set a path without first calling setAcceptableTiles() on EasyStar.");if(void 0===a)throw new Error("You can't set a path without first calling setGrid() on EasyStar.");if(0>b||0>e||0>g||0>g||b>a.length-1||e>a[0].length-1||g>a.length-1||h>a[0].length-1)throw new Error("Your start or end point is outside the scope of your grid.");if(b===g&&e===h)return void l([]);var m=!1,n=a[g][h];n.walkable===!0&&(m=!0);var o=new EasyStar.instance;o.openList=new EasyStar.PriorityQueue("bestGuessDistance",EasyStar.PriorityQueue.MIN_HEAP),o.isDoneCalculating=!1,o.nodeHash={},o.startX=b,o.startY=e,o.endX=g,o.endY=h,o.callback=l,o.endwalkable=m,o.openList.insert(r(o,o.startX,o.startY,null,d)),k=[],k.push(o)},this.calculate=function(){if(this.debug&&console.log("calculate ",k[0]),0!==k.length&&void 0!==a&&void 0!==c)for(b=0;l>b;b++){if(0===k.length)return;if(f&&(b=0),0!==k[0].openList.length){var d=k[0].openList.shiftHighestPriorityElement(),g=[];d.list=EasyStar.Node.CLOSED_LIST,d.y%2==1?(n(d,1,-1,k[0],g),n(d,1,1,k[0],g),n(d,0,1,k[0],g),n(d,0,-1,k[0],g),m&&((j||p(a,c,d.x,d.y-1,0,-1)&&p(a,c,d.x-1,d.y,-1,0))&&n(d,0,-2,k[0],g,e),(j||p(a,c,d.x,d.y+1,0,1)&&p(a,c,d.x+1,d.y,1,0))&&n(d,1,0,k[0],g,e),(j||p(a,c,d.x,d.y-1,0,-1)&&p(a,c,d.x+1,d.y,1,0))&&n(d,0,2,k[0],g,e),(j||p(a,c,d.x,d.y+1,0,1)&&p(a,c,d.x-1,d.y,-1,0))&&n(d,-1,0,k[0],g,e))):(n(d,0,-1,k[0],g),n(d,0,1,k[0],g),n(d,-1,1,k[0],g),n(d,-1,-1,k[0],g),m&&((j||p(a,c,d.x,d.y-1)&&p(a,c,d.x-1,d.y))&&n(d,-1,0,k[0],g,e),(j||p(a,c,d.x,d.y+1)&&p(a,c,d.x+1,d.y))&&n(d,0,2,k[0],g,e),(j||p(a,c,d.x,d.y-1)&&p(a,c,d.x+1,d.y))&&n(d,0,-2,k[0],g,e),(j||p(a,c,d.x,d.y+1)&&p(a,c,d.x-1,d.y))&&n(d,1,0,k[0],g,e))),g.sort(function(a,b){return a.cost<b.cost?-1:a.cost===b.cost?0:1});for(var h=!1,i=0;i<g.length;i++)if(o(g[i].instance,g[i].searchNode,g[i].x,g[i].y,g[i].cost),g[i].instance.isDoneCalculating===!0){h=!0;break}h&&k.shift()}else{var q=k[0];q.callback(null),k.shift()}}};var n=function(b,c,e,f,g,h){h=h||d,b.x+c>-1&&b.x+c<a.length&&b.y+e>-1&&b.y+e<a[0].length&&g.push({instance:f,searchNode:b,x:c,y:e,cost:h*q(b.x+c,b.y+e)})},o=function(b,d,e,f,h){var i=d.x+e,j=d.y+f;if(void 0===g[i+"_"+j]){if(b.endX===i&&b.endY===j){this.debug&&console.log("end adjacent: "+i,j),b.isDoneCalculating=!0;var k=[],l=0;this.debug&&console.log(" endwalkable ",b.endwalkable,p(a,null,d.x,d.y,e,f),d.x,d.y,e,f),b.endwalkable&&p(a,null,d.x,d.y,e,f)&&(k[l]={x:i,y:j},l++),this.debug&&console.log("after"),k[l]={x:d.x,y:d.y},l++;for(var m=d.parent;null!=m;)k[l]={x:m.x,y:m.y},l++,m=m.parent;k.reverse();var n=b,o=k;n.callback(o)}if(p(a,c,i,j,e,f)){var q=r(b,i,j,d,h);void 0===q.list?(q.list=EasyStar.Node.OPEN_LIST,b.openList.insert(q)):q.list===EasyStar.Node.OPEN_LIST&&d.costSoFar+h<q.costSoFar&&(q.costSoFar=d.costSoFar+h,q.parent=d)}}},p=function(a,b,c,d,e,f){if(0>c||c>a.length||0>d||d>a[0].length)return!1;var g=a[c][d].isWalkable(c,d,e,f);return 1==g?!0:!1},q=function(b,c){return i[b+"_"+c]||h[a[b][c]]},r=function(a,b,c,d,e){if(void 0!==a.nodeHash[b+"_"+c])return a.nodeHash[b+"_"+c];var f=s(b,c,a.endX,a.endY);if(null!==d)var g=d.costSoFar+e;else g=f;var h=new EasyStar.Node(d,b,c,g,f);return a.nodeHash[b+"_"+c]=h,h},s=function(a,b,c,d){return Math.sqrt((c-=a)*c+(d-=b)*d)}},Phaser.Plugin.PathFinderPlugin=function(a){if("object"!=typeof EasyStar)throw new Error("Easystar is not defined!");this.parent=a,this._easyStar=new EasyStar.js,this._grid=null,this._callback=null,this._callbackObj=null,this._prepared=!1,this._walkables=[0],this.debug=!1},Phaser.Plugin.PathFinderPlugin.prototype=Object.create(Phaser.Plugin.prototype),Phaser.Plugin.PathFinderPlugin.prototype.constructor=Phaser.Plugin.PathFinderPlugin,Phaser.Plugin.PathFinderPlugin.prototype.setGrid=function(a,b,c){c=c||null,this._grid=[];for(var d=0;d<a.length;d++){this._grid[d]=[];for(var e=0;e<a[d].length;e++)this._grid[d][e]=a[d][e]?a[d][e]:0}for(this._walkables=b,this._easyStar.setGrid(this._grid),this._easyStar.setAcceptableTiles(this._walkables),d=0;d<b.length;d++)this.setTileCost(b[d],1);null!==c&&this._easyStar.setIterationsPerCalculation(c)},Phaser.Plugin.PathFinderPlugin.prototype.setTileCost=function(a,b){this._easyStar.setTileCost(a,b)},Phaser.Plugin.PathFinderPlugin.prototype.setCallbackFunction=function(a,b){this._callback=a,this._callbackObj=b},Phaser.Plugin.PathFinderPlugin.prototype.preparePathCalculation=function(a,b){if(null===this._callback||"function"!=typeof this._callback)throw new Error("No Callback set!");var c=a[0],d=a[1],e=b[0],f=b[1];this._easyStar.findPath(c,d,e,f,this._callback,this._callbackObj),this._prepared=!0},Phaser.Plugin.PathFinderPlugin.prototype.calculatePath=function(){if(null===this._prepared)throw new Error("no Calculation prepared!");this._easyStar.calculate()},BattleExecute=function(){this.topAction=null},BattleExecute.prototype=Object.create(EmptyState.prototype),BattleExecute.constructor=BattleExecute,BattleExecute.prototype.update=function(a){this.topAction,this.topAction.Update(a)},BattleExecute.prototype.render=function(){},BattleExecute.prototype.onEnter=function(a){this.topAction=a,this.topAction&&this.topAction.execute()},BattleExecute.prototype.onExit=function(){this.topAction&&this.topAction.cleanup()},BattleHeroTurnState=function(a,b,c,d,e){this.statemachine=a,this.game=b,this.gameref=c,this.mActions=[],this.mEntities=[],this.actionStates=new StateMachine,this.inputHandler=e,this.actionStates.add("tick",new BattleTick(this.actionStates,this)),this.actionStates.add("execute",new BattleExecute(this.actionStates)),this.iteractor=-1,this.team=[],this.isPlayerTurn=d},BattleHeroTurnState.prototype=Object.create(EmptyState.prototype),BattleHeroTurnState.constructor=BattleHeroTurnState,BattleHeroTurnState.prototype.init=function(){},BattleHeroTurnState.prototype.SortByTime=function(a,b){return a.TimeRemaining()>b.TimeRemaining()},BattleHeroTurnState.prototype.update=function(a){this.game.debug.text("Pause input: "+this.inputHandler.pauseInput,20,25),this.mActions.length>0?this.actionStates.update(a):this.statemachine.nextTeam()},BattleHeroTurnState.prototype.render=function(){this.actionStates.render()},BattleHeroTurnState.prototype.getActiveCombater=function(){this.mEntities[this.iteractor]},BattleHeroTurnState.prototype.NextTick=function(){this.actionStates.change("tick")},BattleHeroTurnState.prototype.onEnter=function(){console.log("BattleTurn"),this.createTeam(),this.isPlayerTurn||(this.inputHandler.pauseInput=!0)},BattleHeroTurnState.prototype.setTeam=function(a){this.mEntities=a},BattleHeroTurnState.prototype.addTeamate=function(a){this.mEntities.push(a)},BattleHeroTurnState.prototype.createTeam=function(){for(var a=0;a<this.mEntities.length;a++)this.mEntities[a].startCombat();this.NextTick(),console.log("num: "+this.mEntities.length),this.createActions()},BattleHeroTurnState.prototype.createActions=function(){for(var a=0;a<this.mEntities.length;a++){var b=this.mEntities[a];if(b.IsPlayer){var c=new PlayerDecide(this.game,this.gameref,b,b.Speed(),this);this.mActions.push(c)}else{var c=new AIDecide(this.game,this.gameref,b,b.Speed(),this);this.mActions.push(c)}}},BattleHeroTurnState.prototype.findDecideByActor=function(a){for(var b=0;b<this.mActions.length;b++)if(this.mActions[b].combater==a)return this.mActions[b];return null},BattleHeroTurnState.prototype.removeAction=function(a){var b=this.mActions.indexOf(a);return console.log("removeAction ",b,this.mActions,a),b>-1?(this.mActions.splice(b,1),!0):!1},BattleHeroTurnState.prototype.placeAtFront=function(a){var b=this.mActions.indexOf(a);b>-1&&this.mActions.splice(b,1),this.mActions.push(a)},BattleHeroTurnState.prototype.placeAtEnd=function(){this.mActions.pop();this.mActions.unshift(val)},BattleHeroTurnState.prototype.removeTopAction=function(){var a=this.mActions.pop();return a},BattleHeroTurnState.prototype.addToActionsRear=function(a){this.mActions.unshift(a),this.NextTick()},BattleHeroTurnState.prototype.addToActionsFront=function(a){this.mActions.push(a),this.NextTick()},BattleHeroTurnState.prototype.moveOn=function(){GlobalEvents.currentAction=GlobalEvents.COMBATSELECT,this.NextTick()},BattleHeroTurnState.prototype.onExit=function(){console.log("On exit."),this.mActions=[],this.inputHandler.cleanUpPlayer()},BattleHeroTurnState.prototype.leaveThisState=function(){return!0},BattleHeroTurnState.prototype.getActions=function(){return this.mActions},BattleState=function(a,b,c){this.statemachine=a,this.game=b,this.gameref=c,this.inputHandler=new InputHandlerBattle(this.game,this.gameref),this.inputHandler.battleState=this,this.enemyRollover=new EnemyTargetRollOver(this.game,this.gameref,this),this.mEntities=[],this.mBattleStates=new StateMachine,this.battleOrder=["Player","AI"],this.currentOrder=-1,this.mBattleStates.add("Player",new BattleHeroTurnState(this,b,c,!0,this.inputHandler)),this.mBattleStates.add("AI",new BattleHeroTurnState(this,b,c,!1,this.inputHandler)),this.activeButtons=new CombatButtons(this.game,this.gameref),this.activeButtons.x=50,this.activeButtons.y=430,this.game.add.existing(this.activeButtons),this.gameref.uiGroup.add(this.activeButtons),this.activeButtons.visible=!1},BattleState.prototype=Object.create(EmptyState.prototype),BattleState.constructor=BattleState,BattleState.prototype.init=function(){},BattleState.prototype.nextTeam=function(){return this.currentOrder++,this.currentOrder>this.battleOrder.length-1&&(this.currentOrder=0),this.mBattleStates.change(this.battleOrder[this.currentOrder]),this.battleOrder[this.currentOrder]},BattleState.prototype.endPlayerTurn=function(){console.log("Endplayer turn."),"Player"==this.battleOrder[this.currentOrder]&&this.nextTeam()},BattleState.prototype.handleOver=function(a){if(!this.gameref.map.playerCharacter.currentSelectedWeapon)return void this.handleOut();if(a.hostile){var b=this.gameref.map.hexHandler.lineOfSite(a.currentTile,this.gameref.map.playerCharacter.currentTile);if(!b)return void this.enemyRollover.showText(a.x,a.y,"NO LOS");var c=this.gameref.map.hexHandler.testRange(a.currentTile,this.gameref.map.playerCharacter.currentTile,!1),d=this.gameref.map.playerCharacter.currentSelectedWeapon.range;if(c>60*d)return void this.enemyRollover.showText(a.x,a.y,"Out of range");var e=this.gameref.map.playerCharacter.currentSelectedWeapon.acc-c/(60*d)/5;e*=100,this.enemyRollover.showText(a.x,a.y,"Chance to hit: "+e.toFixed(0)+"%")}else this.enemyRollover.showText(a.x,a.y,"Civilian.")},BattleState.prototype.handleOut=function(){this.enemyRollover.visible=!1},BattleState.prototype.update=function(a){this.mBattleStates.update(a)},BattleState.prototype.render=function(){this.mBattleStates.render()},BattleState.prototype.onEnter=function(a){this.activeButtons.visible=!0,this.inputHandler.turnOn(),this.mEntities=a.entities;for(var b=0;b<this.mEntities.length;b++)this.mEntities[b].startCombat();this.mEntities=a.entities;for(var b=0;b<this.mEntities.length;b++){var c=this.mEntities[b];if(c.IsPlayer){var d=this.mBattleStates.getByName("Player");d.addTeamate(c)}else{var d=this.mBattleStates.getByName("AI");d.addTeamate(c)}}this.nextTeam()},BattleState.prototype.onExit=function(){console.log("BattleState **  onExit"),this.mActions=[],this.activeButtons.visible=!1,this.inputHandler.turnOff(),this.inputHandler.hideInputAreas();for(var a=0;a<this.mEntities.length;a++)this.mEntities[a].endCombat();GlobalEvents.currentAction==GlobalEvents.COMBATSELECT&&(GlobalEvents.currentAction=GlobalEvents.WALK)},BattleState.prototype.leaveThisState=function(){for(var a=0;a<this.mEntities.length;a++)if(this.mEntities[a].isAlive()&&this.mEntities[a].hostile&&!this.mEntities[a].IsPlayer)return!1;return!0},BattleState.prototype.getActions=function(){return this.mActions},BattleTick=function(a,b){this.mStateMachine=a,this.state=b},BattleTick.prototype=Object.create(EmptyState.prototype),BattleTick.constructor=BattleTick,BattleTick.prototype.update=function(a){var b=this.state.getActions();if(b.length<=0)return void console.log("BattleTick no actions");for(var c=0;c<b.length;c++){var d=b[c];null!=d?d.Update(a):console.log(b)}if(b[b.length-1].isReady){var e=b[b.length-1];this.mStateMachine.change("execute",e)}},BattleTick.prototype.render=function(){},BattleTick.prototype.onEnter=function(){},BattleTick.prototype.onExit=function(){},DeathState=function(a,b,c,d){this.statemachine=a,this.game=b,this.gameref=c,this.uiGroup=d},DeathState.prototype=Object.create(EmptyState.prototype),DeathState.constructor=DeathState,DeathState.prototype.init=function(){},DeathState.prototype.update=function(){},DeathState.prototype.render=function(){},DeathState.prototype.onEnter=function(){this.deathGroup=new DeathScreen(this.tryAgain,this.returnToMenu,this.gameref)},DeathState.prototype.tryAgain=function(){console.log("try again"),this.gameref.gGameMode.change("normal"),this.gameref.map.tryMapAgain()},DeathState.prototype.returnToMenu=function(){this.game.state.start("MainMenu")},DeathState.prototype.onExit=function(){this.gameref.normalUI.show(),this.deathGroup.destroy(!0)},DeathScreen=function(a,b,c){c.normalUI.hide(),c.textUIHandler.showDeadText("Your mortal shell was destroyed.");var d=this.game.add.button(200,400,"ui",a,this,"button_blue_up.png","button_blue_over.png","button_blue_over.png","button_blue_up.png"),e=this.game.add.bitmapText(230,410,"simplefont","Turn Back Time",20);this.addChild(d),this.addChild(e);var d=this.game.add.button(500,400,"ui",b,this,"button_blue_up.png","button_blue_over.png","button_blue_over.png","button_blue_up.png"),e=this.game.add.bitmapText(530,410,"simplefont","Return To Menu",20);this.addChild(d),this.addChild(e)},DeathScreen.prototype=Object.create(Phaser.Group.prototype),DeathScreen.constructor=DeathScreen,DiaglogState=function(a,b,c,d,e){this.statemachine=a,this.game=b,this.gameref=c,this.dialogHandler=d,this.uiGroup=e,this.diagpanel=new DialogPanel(this.game,this.gameref,d,null,this),this.game.add.existing(this.diagpanel),this.uiGroup.add(this.diagpanel),this.diagpanel.setup()},DiaglogState.prototype=Object.create(EmptyState.prototype),DiaglogState.constructor=DiaglogState,DiaglogState.prototype.init=function(){},DiaglogState.prototype.update=function(){},DiaglogState.prototype.render=function(){},DiaglogState.prototype.onEnter=function(){this.gameref.normalUI.hide()},DiaglogState.prototype.onExit=function(){this.gameref.normalUI.show()},DiaglogState.prototype.startDialog=function(a){console.log(this,this.diagpanel),this.diagpanel.startDialog(a)},DiaglogState.prototype.exitDialog=function(){GlobalEvents.reEnableEvents(),this.gameref.gGameMode.change("normal")},NormalState=function(a,b,c){this.statemachine=a,this.game=b,this.gameref=c,this.inputHandler=new InputHandler(this.game,this.gameref)},NormalState.prototype=Object.create(EmptyState.prototype),NormalState.constructor=NormalState,NormalState.prototype.init=function(){},NormalState.prototype.update=function(){},NormalState.prototype.render=function(){},NormalState.prototype.onEnter=function(){this.inputHandler.turnOn()},NormalState.prototype.onExit=function(){this.inputHandler.turnOff()},RealTimeCombatState=function(a,b,c){this.statemachine=a,this.game=b,this.gameref=c,this.inputHandler=new InputHandlerRealTimeBattle(this.game,this.gameref),this.inputHandler.battleState=this,this.enemyRollover=new EnemyTargetRollOver(this.game,this.gameref,this),this.mEntities=[],this.mRealTimeCombatStates=new StateMachine,this.battleOrder=["Player"],this.currentOrder=-1,this.mRealTimeCombatStates.add("Player",new BattleHeroTurnState(this,b,c,!0,this.inputHandler)),this.activeButtons=new CombatButtons(this.game,this.gameref),this.activeButtons.x=50,this.activeButtons.y=430,this.game.add.existing(this.activeButtons),this.gameref.uiGroup.add(this.activeButtons),this.activeButtons.visible=!1},RealTimeCombatState.prototype=Object.create(EmptyState.prototype),RealTimeCombatState.constructor=RealTimeCombatState,RealTimeCombatState.prototype.init=function(){},RealTimeCombatState.prototype.endPlayerTurn=function(){console.log("Endplayer turn."),"Player"==this.battleOrder[this.currentOrder]&&this.nextTeam()},RealTimeCombatState.prototype.handleOver=function(a){if(!this.gameref.map.playerCharacter.currentSelectedWeapon)return void this.handleOut();if(a.hostile){var b=this.gameref.map.hexHandler.lineOfSite(a.currentTile,this.gameref.map.playerCharacter.currentTile);if(!b)return void this.enemyRollover.showText(a.x,a.y,"NO LOS");var c=this.gameref.map.hexHandler.testRange(a.currentTile,this.gameref.map.playerCharacter.currentTile,!1),d=this.gameref.map.playerCharacter.currentSelectedWeapon.range;if(c>60*d)return void this.enemyRollover.showText(a.x,a.y,"Out of range");var e=this.gameref.map.playerCharacter.currentSelectedWeapon.acc-c/(60*d)/5;e*=100,this.enemyRollover.showText(a.x,a.y,"Chance to hit: "+e.toFixed(0)+"%")}else this.enemyRollover.showText(a.x,a.y,"Civilian.")},RealTimeCombatState.prototype.handleOut=function(){this.enemyRollover.visible=!1},RealTimeCombatState.prototype.update=function(a){this.mRealTimeCombatStates.update(a)},RealTimeCombatState.prototype.render=function(){this.mRealTimeCombatStates.render()},RealTimeCombatState.prototype.onEnter=function(){this.activeButtons.visible=!0,this.inputHandler.turnOn()},RealTimeCombatState.prototype.onExit=function(){console.log("RealTimeCombatState **  onExit"),this.mActions=[]},RealTimeCombatState.prototype.leaveThisState=function(){for(var a=0;a<this.mEntities.length;a++)if(this.mEntities[a].isAlive()&&this.mEntities[a].hostile&&!this.mEntities[a].IsPlayer)return!1;return!0},RealTimeCombatState.prototype.getActions=function(){return this.mActions},StateMachine=function(){this.mStates=[],this.mCurrentState=null,this.currentState=null,this.changeState=new Phaser.Signal},StateMachine.prototype.update=function(a){void 0!=this.mCurrentState&&this.mCurrentState.update(a)},StateMachine.prototype.render=function(){void 0!=this.mCurrentState&&this.mCurrentState.render()},StateMachine.prototype.change=function(a,b){var c=this.mStates[a];null!=c&&(void 0!=this.mCurrentState&&this.mCurrentState.onExit(),this.mCurrentState=c,this.mCurrentState.onEnter(b),this.currentState=a,this.changeState.dispatch(this,this.currentState,this.mCurrentState))},StateMachine.prototype.add=function(a,b){this.mStates[a]=b},StateMachine.prototype.getByName=function(a){return this.mStates[a]},StateStack=function(){this.mStates=[],this.mStack=[]},StateStack.prototype.update=function(a){var b=this.mStack[this.mStack.length-1];b.update(a)},StateStack.prototype.render=function(){var a=this.mStack[mStack.length-1];a.render()},StateStack.prototype.push=function(a){var b=this.mStates[a];this.mStack.Push(b)},StateStack.prototype.pop=function(){return this.mStack.Pop()},BasicObjectPool=function(a){this.openArray=[],this.allObjectsArray=[],this.handler=a||null},BasicObjectPool.prototype.getObject=function(){if(this.openArray.length>0)return this.openArray.pop();var a=this.handler.createItem();return this.openArray.push(a),this.allObjectsArray.push(a),a},BasicObjectPool.prototype.addObject=function(a){this.openArray.push(a),this.allObjectsArray.push(a)},BasicObjectPool.prototype.returnObject=function(a){a.reset(),this.openArray.push(a)},BasicObjectPool.prototype.destroyself=function(){this.allObjectsArray=[],this.openArray=[]};var CheapMasker=function(a,b,c){this.game=a,this.maingame=b,this.maskableobjects=c};CheapMasker.prototype.updateMasks=function(a,b,c,d){if(this.maskableobjects)for(var e,f=!1,g=0;g<this.maskableobjects.length;g++)e=this.maskableobjects[g],null!=e&&(e.left<=a&&a<e.right&&e.top<=b&&b<e.bottom&&(f=!0,e.posy==d?e.posx<c?f=!0:e.posx>c&&(f=!1):e.posy>d?f=!0:e.posy<d&&(f=!1)),f?e.alpha=.5:1!=e.alpha&&(e.alpha=1)),f=!1};var Optimized={easeLinear:function(a){return a},easeInQuad:function(a){return a*a},easeInCubic:function(a){return a*a*a},easeInQuart:function(a){return a*a*a*a},easeInQuint:function(a){return a*a*a*a*a},easeInSextic:function(a){return a*a*a*a*a*a},easeInSeptic:function(a){return a*a*a*a*a*a*a},easeInOctic:function(a){return a*a*a*a*a*a*a*a},easeOutQuad:function(a){var b=a-1;return 1-b*b},easeOutCubic:function(a){var b=a-1;return 1+b*b*b},easeOutQuart:function(a){var b=a-1;return 1-b*b*b*b},easeOutQuint:function(a){var b=a-1;return 1+b*b*b*b*b},easeOutSextic:function(a){var b=a-1;return 1-b*b*b*b*b*b},easeOutSeptic:function(a){var b=a-1;return 1+b*b*b*b*b*b*b},easeOutOctic:function(a){var b=a-1;return 1-b*b*b*b*b*b*b*b},easeInOutQuad:function(a){var b=a-1,c=2*a;return 1>c?a*c:1-b*b*2},easeInOutCubic:function(a){var b=a-1,c=2*a;return 1>c?a*c*c:1+b*b*b*4},easeInOutQuart:function(a){var b=a-1,c=2*a;return 1>c?a*c*c*c:1-b*b*b*b*8},easeInOutQuint:function(a){var b=a-1,c=2*a;return 1>c?a*c*c*c*c:1+b*b*b*b*b*16},easeInOutSextic:function(a){var b=a-1,c=2*a;return 1>c?a*c*c*c*c*c:1-b*b*b*b*b*b*32},easeInOutSeptic:function(a){var b=a-1,c=2*a;return 1>c?a*c*c*c*c*c*c:1+b*b*b*b*b*b*b*64},easeInOutOctic:function(a){var b=a-1,c=2*a;return 1>c?a*c*c*c*c*c*c*c:1-b*b*b*b*b*b*b*b*128},easeInBack:function(a){var b=1.70158;return a*a*(a*(b+1)-b)},easeInOutBack:function(a){var b=a-1,c=2*a,d=2.5949095;return.5>a?a*c*(c*(d+1)-d):1+2*b*b*(2*b*(d+1)+d)},easeOutBack:function(a){var b=a-1,c=1.70158;return 1+b*b*(b*(c+1)+c)},easeInBounce:function(a){return 1-this.easeOutBounce(1-a)},easeInOutBounce:function(a){var b=2*a;return 1>b?.5-.5*this.easeOutBounce(1-b):.5+.5*this.easeOutBounce(b-1)},easeOutBounce:function(a){var b,c=1/2.75,d=1*c,e=2*c,f=1.5*c,g=2.5*c,h=2.25*c,i=2.625*c,j=7.5625;return d>a?j*a*a:e>a?(b=a-f,j*b*b+.75):g>a?(b=a-h,j*b*b+.9375):(b=a-i,j*b*b+.984375)},easeInCirc:function(a){return 1-Math.sqrt(1-a*a)},easeInOutCirc:function(a){var b=a-1,c=2*a;return 1>c?.5*(1-Math.sqrt(1-c*c)):.5*(Math.sqrt(1-4*b*b)+1)},easeOutCirc:function(a){var b=a-1;return Math.sqrt(1-b*b)},easeInElastic:function(a){var b=a-1;return 0>=a?0:a>=1?1:-Math.pow(2,10*b)*Math.sin((40*b-3)*Math.PI/6)},easeOutElastic:function(a){return 0>=a?0:a>=1?1:1+Math.pow(2,10*-a)*Math.sin((40*-a-3)*Math.PI/6)},easeInOutElastic:function(a){if(0>=a)return 0;if(a>=1)return 1;var b=2*a-1,c=(80*b-9)*Math.PI/18;return 0>b?-.5*Math.pow(2,10*b)*Math.sin(c):1+.5*Math.pow(2,-10*b)*Math.sin(c)},easeInExpo:function(a){return 0>=a?0:Math.pow(2,10*(a-1))},easeOutExpo:function(a){return a>=1?1:1-Math.pow(2,-10*a)},easeInOutExpo:function(a){return 0>=a?0:a>=1?1:.5>a?Math.pow(2,10*(2*a-1)-1):1-Math.pow(2,-10*(2*a-1)-1)},easeInSine:function(a){return 1-Math.cos(a*Math.PI*.5)},easeInOutSine:function(a){return.5*(1-Math.cos(a*Math.PI))},easeOutSine:function(a){return Math.sin(a*Math.PI*.5)}},Masker=function(a,b,c){this.game=a,this.maingame=b,this.maskedobjects=[],this.maskDistance=2e3,this.maskableobjects=c};Masker.prototype.createCircleMask=function(a){var b=this.game.add.graphics(0,0);return b.beginFill(4294967057),b.drawCircle(0,0,a),this.maingame.objectGroup.add(b),b},Masker.prototype.createRectMask=function(a,b,c,d){var e=this.game.add.graphics(0,0);return e.beginFill(0),e.drawRect(a,b,c/2,d),this.maingame.objectGroup.add(e),e},Masker.prototype.cleanUp=function(){},Masker.prototype.updateMasks=function(a,b){if(this.maskableobjects)for(var c,d=0;d<this.maskableobjects.length;d++)if(c=this.maskableobjects[d],null!=c)if(c.left<=a&&a<c.right&&c.top<=b&&b<c.bottom){if(null==this.maskedobjects[d]){var e=new MaskedObject,f=this.game.make.bitmapData(c.width,c.height),g=this.game.make.bitmapData(c.width,c.height);g.ctx.beginPath(),g.ctx.rect(0,0,c.width,c.height),g.ctx.fillStyle="#ffff00",g.ctx.fill(),g.draw(this.mask);var h=c.x,i=c.y;c.x=0,c.y=0,c.anchor.x=0,c.anchor.y=0,f.alphaMask(c,g),c.anchor.x=.5,c.anchor.y=1,e.thebitmapdata=f,e.object=c,e.image=new Phaser.Image(this.game,h,i,f),this.game.add.existing(e.image),e.image.anchor.x=.5,e.image.anchor.y=1,this.maingame.objectGroup.add(e.image),this.maskedobjects[d]=e,c.visible=!1,c.x=c.x,c.y=c.y}}else null!=this.maskedobjects[d]},Masker.prototype.fasterDistance=function(a,b,c,d){var e=a-c,f=b-d;return e*e+f*f};var MaskedObject=function(){this.thebitmapdata,this.object,this.image};MaskedObject.prototype.cleanup=function(){this.image&&(this.image.destroy(),this.thebitmapdata=null,this.object=null,this.image=null)},Utilties=function(){},Utilties.customSortIso=function(a,b){if(b.IsPlayer||a.IsPlayer,null!=a.iso&&null!=b.iso){if(a.IsPlayer,a.iso.x<b.iso.x)return 1;if(a.iso.x>b.iso.x)return-1;if(a.iso.z<b.iso.z)return 1;if(a.iso.z>b.iso.z)return-1;if(a.iso.y<b.iso.y)return-1;if(a.iso.y>b.iso.y)return 1;if(a.isoorder<b.isoorder)return-1;if(a.isoorder>b.isoorder)return 1}return Utilties.doNormal(a,b)},Utilties.byPos=function(a,b){if(a.y==b.y){if(a.x<b.x)return 1;if(a.x>b.y)return-1}else{if(a.y<b.y)return-1;if(a.y>b.y)return 1}return 0},Utilties.doNormal=function(a,b){if(a.posy==b.posy){if(a.posx<b.posx)return 1;if(a.posx>b.posx)return-1;if(a.y<b.y)return-1;if(a.y>b.y)return 1}else{if(a.posy<b.posy)return 1;if(a.posy>b.posy)return-1}return 0},Utilties.doReverse=function(a,b){if(a.posy==b.posy){if(a.posx>b.posx)return 1;if(a.posx<b.posx)return-1;if(a.y>b.y)return-1;if(a.y<b.y)return 1}else{if(a.posy>b.posy)return-1;if(a.posy<b.posy)return 1}return 0},Utilties.customSortHexOffsetIso=function(a,b){if(b.IsPlayer||a.IsPlayer,a.posy==b.posy){if(a.posx<b.posx)return 1;if(a.posx>b.posx)return-1;if(a.y<b.y)return-1;if(a.y>b.y)return 1}else{if(a.posy<b.posy)return-1;if(a.posy>b.posy)return 1}return 0};var Global=function(){this.mute=!1,this.pause=!1,this.fastLoad=!0,this.showmovetile=!1,this.loadMap=0,this.language="en",this.uilocation="assets/basicUI/",this.assetsLocation="assets/simpletown/",this.actionspeed=1,this.doShadows=!1};BasicGame.Game=function(){this.pathfinder,this.graphics,this.uiGroup,this.mapData,this.globalHandler,this.inventory,this.updatewalkable=!1,this.fps,this.gGameMode=null,this.map=null,this.textUIHandler=null,this.dialoghandler,this.bulletHandler},BasicGame.Game.prototype={preload:function(){},create:function(){this.game.stage.disableVisibilityChange=!0,this.game.time.advancedTiming=!0,this.stage.backgroundColor="#444444",this.pathfinder=this.game.plugins.add(Phaser.Plugin.PathFinderPlugin),this.uiGroup=this.add.group(),this.textUIHandler=new TextUIHandler(this.game,0,0,this,null),this.gameData=this.game.cache.getJSON("gameData"),this.gameDataPlayer=this.game.cache.getJSON("playergamedata"),this.mapData=this.game.cache.getJSON("map"),this.globalHandler=new GlobalHandler(this.game,this,this.mapData.data.Actors,this.mapData.data.Variables,null,this.mapData.data.Items),this.dialoghandler=new DialogHandler(this.game,this,this.mapData.data.Conversations,this.mapData.data.Actors),this.textUIHandler.setup(this.mapData,this.uiGroup,this.dialoghandler),this.camera=new PlayerCamera(this.game,this),null==this.map&&(this.map=new Map(this.game,this)),this.map.initialMap(this.mapData,this.gameData,this.game.cache.getJSON("player"),this.gameDataPlayer),this.bulletHandler=new BulletHandler(this.game,this,this.map.objectGroup,"gameplayinterface","combat_actionpoints0002.png"),this.gGameMode=new StateMachine,this.gGameMode.add("normal",new NormalState(this.gGameMode,this.game,this)),this.gGameMode.add("combat",new BattleState(this.gGameMode,this.game,this)),this.gGameMode.add("dialog",new DiaglogState(this.gGameMode,this.game,this,this.dialoghandler,this.uiGroup)),this.gGameMode.add("playerDead",new DeathState(this.gGameMode,this.game,this)),this.gGameMode.change("normal"),this.uiGroup.parent.bringToTop(this.uiGroup),this.inventory=new InventoryGraphics(this.game,this.gameref,this.globalHandler),this.game.add.existing(this.inventory),this.uiGroup.add(this.inventory),this.inventory.y=this.game.world.height-110,this.inventory.visible=!1,this.normalUI=new NormalUI(this.game,this,this.globalHandler,this.uiGroup),this.graphics=this.game.add.graphics(0,0),this.uiGroup.add(this.graphics),this.updatewalkable=!0,this.camera.setinit()},update:function(){var a=this.game.time.elapsed;this.map.update(a),this.bulletHandler.step(a),this.updatewalkable&&(this.pathfinder.setGrid(this.map.walkableArray,[1]),this.updatewalkable=!1,this.game.global.showmovetile&&this.map.refreshWalkablView()),this.gGameMode.update(a),this.gGameMode.render(),this.textUIHandler.update(a),this.camera.step(a)},getGameData:function(a,b){return this.gameData[a]&&this.gameData[a][b]?this.gameData[a][b]:this.gameDataPlayer[a]&&this.gameDataPlayer[a][b]?this.gameDataPlayer[a][b]:null},zoomIn:function(a,b){b.active=!1;var c=this.map.scaledto-.05;0>c&&(c=.01),this.map.doZoom(c)},zoomOut:function(a,b){b.active=!1;var c=this.map.scaledto+.05;this.map.doZoom(c)},toggleCombat:function(){if("combat"==this.gGameMode.currentState&&this.gGameMode.mCurrentState.leaveThisState())this.gGameMode.change("normal");else if("normal"==this.gGameMode.currentState){for(var a=this.map.getCombatCharacters(),b=0;b<this.map.playerCharacters.length;b++)a.push(this.map.playerCharacters[b]);this.gGameMode.change("combat",{entities:a})}},showDialog:function(a){"combat"!=this.gGameMode.currentState&&(this.gGameMode.change("dialog"),this.gGameMode.mCurrentState.startDialog(a),GlobalEvents.tempDisableEvents())},pauseGame:function(){this.game.global.pause||(this.game.global.pause=!0)},unpauseGame:function(){this.game.global.pause&&(this.game.global.pause=!1,GlobalEvents.reEnableEvents())},quitGame:function(){this.state.start("MainMenu")},render:function(){this.game.debug.text(this.game.time.fps||"--",2,40,"#00ff00")},shutdown:function(){this.map.flushEntireMap()},callFunction:function(a,b){var c=this[a];b=b.split(","),"function"==typeof c&&c.apply(this,b)},addNewPlayer:function(a,b,c){Game.playerMap[a]=game.add.sprite(b,c,"sprite")}};var Point=function(a,b){this.x=a,this.y=b},Vec3=function(a,b,c){this.x=a,this.y=b,this.z=c};BasicGame.Boot=function(){},BasicGame.Boot.prototype={init:function(){this.input.maxPointers=1,this.stage.disableVisibilityChange=!0,this.game.canvas.oncontextmenu=function(a){a.preventDefault()},this.game.scale.windowConstraints.bottom="visual",this.game.device.desktop?(this.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL,this.scale.setMinMax(100,30,1024,768),this.scale.pageAlignHorizontally=!0,this.scale.pageAlignVertically=!0):(this.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL,this.scale.setMinMax(100,30,1024,768),this.scale.pageAlignHorizontally=!0,this.scale.pageAlignVertically=!0,this.scale.setResizeCallback(this.gameResized,this))},preload:function(){this.load.atlasJSONHash("loadingScreen",this.game.global.uilocation+"loading.png",this.game.global.uilocation+"loading.json")},create:function(){this.state.start("Preloader")}},BasicGame.Instructions=function(){
this.music=null,this.playButton=null},BasicGame.Instructions.prototype={create:function(){this.add.sprite(0,0,"instructions"),this.playButton=this.add.button(177,529,"ui",this.returnToMain,this,"OK Button0001.png","OK Button0002.png","OK Button0002.png","OK Button0001.png")},update:function(){},returnToMain:function(){this.state.start("MainMenu")}},BasicGame.LoadMap=function(){},BasicGame.LoadMap.prototype={preload:function(){this.background=this.add.sprite(0,0,"loadingScreen","bg.png"),this.preloadBar=this.add.sprite(0,273,"loadingScreen","loading_barfront.png");var a=this.game.cache.getJSON("levels").Levels,b=a[this.game.global.loadMap];null!=b?(console.log("Load map: ",b.gameData,b.map),this.load.json("gameData",this.game.global.assetsLocation+"maps/"+b.gameData+".json"),this.load.json("map",this.game.global.assetsLocation+"maps/"+b.map+".json")):console.error("Map Not exists.")},updateProgress:function(a){var b=a/100;this.preloadBar.width=this.barwidth*b},create:function(){this.secondLoader=new Phaser.Loader(this);var a=this.game.cache.getJSON("map").tileSets;for(var b in a){var c=a[b];console.log("assets/"+c.tileset+".png","assets/"+c.tileset+".json"),this.secondLoader.atlasJSONHash(c.tileset,this.game.global.assetsLocation+"assets/"+c.tileset+".png",this.game.global.assetsLocation+"assets/"+c.tileset+".json")}this.secondLoader.atlasJSONHash("standardimages",this.game.global.assetsLocation+"assets/standardimages.png",this.game.global.assetsLocation+"assets/standardimages.json"),this.secondLoader.atlasJSONHash("gameplayinterface",this.game.global.assetsLocation+"assets/paradoxinterface.png",this.game.global.assetsLocation+"assets/paradoxinterface.json"),this.barwidth=this.preloadBar.width,this.preloadBar.width=0,this.secondLoader.onFileComplete.add(this.updateProgress,this),this.secondLoader.onLoadComplete.add(this.loadComplete,this),this.secondLoader.start()},testSpriteSheet:function(){},loadComplete:function(){this.secondLoader.reset(!1,!0),this.secondLoader=null,this.state.start("Game",!0,!1)},update:function(){}},BasicGame.MainMenu=function(){this.music=null,this.playButton=null},BasicGame.MainMenu.prototype={create:function(){this.add.sprite(0,0,"mainmenu"),this.playButton=this.add.button(376,425,"ui",this.startGame,this,"Play Button0001.png","Play Button0002.png","Play Button0002.png","Play Button0001.png"),this.state.start("MapSelect")},update:function(){},startGame:function(){this.state.start("MapSelect")},gotoInstructions:function(){this.state.start("Instructions")}},BasicGame.MapSelect=function(){this.music=null,this.playButton=null},BasicGame.MapSelect.prototype={create:function(){this.add.sprite(0,0,"mapselect"),this.back=this.add.button(10,530,"ui",this.returnToMain,this,"menu0001.png","menu0002.png","menu0002.png","menu0001.png");for(var a=this.game.cache.getJSON("levels").Levels,b=0;b<a.length;b++)this.displayLevel(a[b].name,b)},displayLevel:function(a,b){var c=this.add.button(120,200+60*b,"ui",this.clickMap,this,"button_blue_up.png","button_blue_over.png","button_blue_over.png","button_blue_up.png");c.level=b,this.setupText(140,215+60*b,"simplefont",a,20)},clickMap:function(a,b){console.log(a.level,b),this.game.global.loadMap=a.level,this.state.start("LoadMap")},update:function(){},returnToMain:function(){this.state.start("MainMenu")}},BasicGame.MapSelect.prototype.setupText=function(a,b,c,d,e){var f=this.game.add.bitmapText(a,b,c,d,e);return f},BasicGame.Preloader=function(){this.background=null,this.preloadBar=null,this.ready=!1},BasicGame.Preloader.prototype={preload:function(){this.background=this.add.sprite(0,0,"loadingScreen","bg.png"),this.preloadBar=this.add.sprite(0,273,"loadingScreen","loading_barfront.png"),this.load.atlasJSONHash("ui",this.game.global.uilocation+"simpleui.png",this.game.global.uilocation+"simpleui.json"),this.load.image("loading",this.game.global.uilocation+"loading.png"),this.game.global.fastLoad||(this.load.image("mainmenu",this.game.global.uilocation+"mainmenu.png"),this.load.image("mapselect",this.game.global.uilocation+"mapselect.png"),this.load.image("winscreen",this.game.global.uilocation+"winscreen.png"),this.load.image("instructions",this.game.global.uilocation+"instructions.png")),this.load.bitmapFont("simplefont",this.game.global.uilocation+"fonts/badabb.png",this.game.global.uilocation+"fonts/badabb.fnt"),this.load.json("player",this.game.global.assetsLocation+"maps/playerdata.json"),this.load.json("playergamedata",this.game.global.assetsLocation+"maps/playergamedata.json"),this.load.json("levels","assets/levels.json"),this.barwidth=this.preloadBar.width,this.preloadBar.width=0,this.load.onFileComplete.add(this.updateProgress,this)},updateProgress:function(a){var b=a/100;this.preloadBar.width=this.barwidth*b},create:function(){this.preloadBar.cropEnabled=!1,this.state.start(this.game.global.fastLoad?"LoadMap":"MainMenu")}},CombatButtons=function(a,b,c){if(Phaser.Group.call(this,a,c),this.gameref=b,this.currentActive,this.activeToggle,this.buttons=[],this.player=this.gameref.map.playerCharacter,this.players=this.gameref.map.playerCharacters,this.range=null,this.melee=null,this.buffs=null,this.powerRollerOver=new PowerRollOver(this.game,this.gameref,this),this.player.weaponCatagories){this.range=this.player.weaponCatagories.Range,this.buffs=this.player.weaponCatagories.Buffs,this.bargroups=[],this.bargrouppowers=[];var d=60,e=100,f=50;this.bargroups.Range=this.game.add.group(),this.addChild(this.bargroups.Range),this.bargrouppowers.Range=[];for(var g=0;4>g;g++)if(void 0==this.range[g]){var h=this.game.make.sprite(e+g*d,f,"gameplayinterface","combat_power_empty.png");this.bargroups.Range.addChild(h)}else this.bargrouppowers.Range[g]={up:null,active:null,power:this.range[g],ui:this},this.setButton(e+g*d,f,"combat_power_attack.png","combat_power_buff.png",this.bargrouppowers.Range[g],this.doPower,this.bargroups.Range,this.handlePowerOver,this.handlePowerOut),this.setupText(e+g*d+3,f+15,"simplefont",this.range[g].weaponname,10)}var i=this.game.add.button(900-3*d,f,"gameplayinterface",this.endTurnPress,this,"actionButtonSqr0001.png","actionButtonSqr0003.png","actionButtonSqr0003.png","actionButtonSqr0001.png");this.addChild(i),this.setupText(900-3*d+15,f+10,"simplefont","End Turn",20)},CombatButtons.prototype=Object.create(Phaser.Group.prototype),CombatButtons.constructor=CombatButtons,CombatButtons.prototype.setupText=function(a,b,c,d,e){var f=this.game.make.bitmapText(a,b,c,d,e);return this.add(f),f},CombatButtons.prototype.setButton=function(a,b,c,d,e,f,g,h,i){e.up=this.game.make.sprite(a,b,"gameplayinterface",c),e.up.inputEnabled=!0,e.up.useHandCursor=!0,e.up.input.priorityID=10,g.add(e.up),e.up.events.onInputDown.add(f,e),void 0!=h&&e.up.events.onInputOver.add(h,e),void 0!=i&&e.up.events.onInputOut.add(i,e),this.buttons[e.up.x+""]=e,e.imageup=c,e.imageactive=d},CombatButtons.prototype.endTurnPress=function(){this.gameref.gGameMode.mCurrentState.inputHandler.playerDecide&&this.gameref.gGameMode.mCurrentState.endPlayerTurn()},CombatButtons.prototype.handlePowerOver=function(a){this.ui.powerRollerOver.setText(a.x,a.y,this.power)},CombatButtons.prototype.handlePowerOut=function(){this.ui.powerRollerOver.hide()},CombatButtons.prototype.doPower=function(a){console.log(this.ui);for(var b=0;b<this.ui.players.length;b++)this.ui.players[b].currentSelectedWeapon=this.power;this.ui.disableButton(this.ui.currentActive),this.ui.currentActive=this.ui.buttons[a.x+""],this.ui.enableButton(this.ui.currentActive),GlobalEvents.currentAction=GlobalEvents.COMBATSELECT},CombatButtons.prototype.dowalk=function(a,b){void 0!=b&&(b.active=!1),this.disableButton(this.currentActive),this.currentActive=this.buttons[a],this.enableButton(this.currentActive),GlobalEvents.currentAction=GlobalEvents.COMBATSELECT},CombatButtons.prototype.checkRefresh=function(){GlobalEvents.currentAction!=GlobalEvents.COMBATSELECT&&this.disableAll()},CombatButtons.prototype.enableButton=function(a){null!=a&&(a.up.frameName=a.imageactive)},CombatButtons.prototype.disableButton=function(a){null!=a&&(a.up.frameName=a.imageup)},PowerRollOver=function(a,b,c){Phaser.Group.call(this,a,c);var d=15,e=18,f=this.game.make.sprite(0,0,"gameplayinterface","dialog_portrait1.png");f.width=120,f.height=6*e,this.add(f),this.name=this.setupText(d,0*e,"simplefont","Text goes here.",15),this.acc=this.setupText(d,1*e,"simplefont","Text goes here.",15),this.dmg=this.setupText(d,2*e,"simplefont","Text goes here.",15),this.range=this.setupText(d,3*e,"simplefont","Text goes here.",15),this.type=this.setupText(d,4*e,"simplefont","Text goes here.",15),this.desc=this.setupText(d,5*e,"simplefont","Text goes here.",15),this.visible=!1},PowerRollOver.prototype=Object.create(Phaser.Group.prototype),PowerRollOver.constructor=PowerRollOver,PowerRollOver.prototype.setupText=function(a,b,c,d,e){var f=this.game.make.bitmapText(a,b,c,d,e);return this.add(f),f},PowerRollOver.prototype.setText=function(a,b,c){this.visible=!0,this.x=a-20,this.y=b-140,this.name.text=c.weaponname,this.dmg.text="Damage: "+c.dmg,this.acc.text="ACC: "+c.acc,this.range.text="Range: "+c.range,this.type.text="Type: "+c.powerType,this.desc.text=c.description},PowerRollOver.prototype.hide=function(){this.visible=!1},EnemyTargetRollOver=function(a){Phaser.Group.call(this,a);var b=15,c=18;this.acc=this.setupText(b,0*c,"simplefont","Text goes here.",20),this.visible=!1},EnemyTargetRollOver.prototype=Object.create(Phaser.Group.prototype),EnemyTargetRollOver.constructor=EnemyTargetRollOver,EnemyTargetRollOver.prototype.showText=function(a,b,c){this.visible=!0,this.x=a-20,this.y=b,this.acc.text=c},EnemyTargetRollOver.prototype.setupText=function(a,b,c,d,e){var f=this.game.make.bitmapText(a,b,c,d,e);return this.add(f),f},EnemyTargetRollOver.prototype.setButton=function(){},BarkTextHandler=function(a,b){Phaser.Group.call(this,a),this.pool=new BasicObjectPool(this),this.game=a,this.maingame=b},BarkTextHandler.prototype=Object.create(Phaser.Group.prototype),BarkTextHandler.constructor=BarkTextHandler,BarkTextHandler.prototype.barkOverTile=function(){},BarkTextHandler.prototype.createItem=function(){var a=new BarkText(this.game,this);return this.add(a),a},BarkTextHandler.prototype.barkOverObject=function(a,b){for(var c=this.pool.allObjectsArray,d=0;d<c.length;d++)c[d].over==a&&null!=c[d].over&&c[d].killSelf();var e=this.pool.getObject();e.getReady(a,b),e.x=a.x,e.y=a.y,e.over=a,e.visible=!0},BarkTextHandler.prototype.returnBarkToPool=function(a){this.pool.returnObject(a)},BarkTextHandler.prototype.cleanupAllBarks=function(){for(var a=this.pool.allObjectsArray,b=0;b<a.length;b++)a[b].killSelf()},BarkTextHandler.prototype.step=function(a){for(var b=this.pool.allObjectsArray,c=0;c<b.length;c++)b[c].inUse&&b[c].step(a)},BarkText=function(a,b){Phaser.BitmapText.call(this,a,0,0,"simplefont","Text goes here.",25),this.time,this.over,this.inUse=!1,this.handler=b,this.anchor.x=.5},BarkText.prototype=Object.create(Phaser.BitmapText.prototype),BarkText.constructor=BarkText,BarkText.prototype.step=function(a){this.time-=a,this.time<=0&&this.killSelf()},BarkText.prototype.killSelf=function(){this.handler.returnBarkToPool(this)},BarkText.prototype.getReady=function(a,b){this.text=b,this.time=3e3,this.over=a,this.inUse=!0,this.visible=!0},BarkText.prototype.reset=function(){this.time=-1,this.over=null,this.inUse=!1,this.visible=!1};var DialogPanel=function(a,b,c,d,e){Phaser.Group.call(this,a),this.state=e,this.overTint=16733440,this.maingame=b,this.dialogEngine=c};DialogPanel.prototype=Object.create(Phaser.Group.prototype),DialogPanel.constructor=DialogPanel,DialogPanel.prototype.setup=function(){var a=this.game.make.sprite(0,0,"gameplayinterface","dropshadow_btn.png");this.add(a),a.width=900,a.height=600,a.x=-200,a.y=-100;var b=69.6,c=50,d=200;this.btnPlay1=this.setupButton(c,d+0*b,"gameplayinterface",this.play1,"dialong_choice0002.png","dialong_choice0001.png","dialong_choice0001.png","dialong_choice0002.png"),this.btnPlay2=this.setupButton(c,d+1*b,"gameplayinterface",this.play2,"dialong_choice0002.png","dialong_choice0001.png","dialong_choice0001.png","dialog_20002.png"),this.btnPlay3=this.setupButton(c,d+2*b,"gameplayinterface",this.play3,"dialong_choice_end0002.png","dialong_choice_end0001.png","dialong_choice_end0001.png","dialong_choice_end0002.png"),this.textMain=this.setupText(c,0,"simplefont","Text goes here.",25),this.btnPlay1.textRef=this.setupText(10+c,d+0*b,"simplefont","1. ",25),this.btnPlay2.textRef=this.setupText(10+c,d+1*b,"simplefont","2. ",25),this.btnPlay3.textRef=this.setupText(10+c,d+2*b,"simplefont","3. ",25),this.portrait1=null,this.portrait2=null,this.y=-1e3},DialogPanel.prototype.setupPortrait=function(a,b,c,d){var e=this.game.make.sprite(a,b,c,d);return e.scale.setTo(2,2),this.add(e),e},DialogPanel.prototype.setupBG=function(a,b){var c=this.game.make.image(0,0,a,b);this.add(c)},DialogPanel.prototype.setupButton=function(a,b,c,d,e,f,g,h){var i=this.game.make.button(a,b,c,d,this,e,f,g,h);return this.add(i),i.events.onInputOver.add(this.buttonOver,this),i.events.onInputOut.add(this.buttonOut,this),i.forceOut=!0,i.input.useHandCursor=!0,i},DialogPanel.prototype.setupText=function(a,b,c,d,e){var f=this.game.make.bitmapText(a,b,c,d,e);return this.add(f),f},DialogPanel.prototype.buttonOver=function(a){a.textRef.tint=this.overTint},DialogPanel.prototype.buttonOut=function(a){a.textRef.tint=16777215},DialogPanel.prototype.play1=function(){this.dialogData=this.dialogData.links[0],this.nextDialog()},DialogPanel.prototype.play2=function(){this.dialogData=this.dialogData.links[1],this.nextDialog()},DialogPanel.prototype.play3=function(){this.dialogData=this.dialogData.links[2],this.nextDialog()},DialogPanel.prototype.justDoNext=function(){null==this.dialogData?this.endDialog():0==this.dialogData.links.length?(this.dialogData=null,this.endDialog()):(this.dialogData=this.dialogData.links[0],this.nextDialog())},DialogPanel.prototype.nextDialog=function(){this.dialogData=this.dialogEngine.getNextDialog(this.dialogData),null==this.dialogData?this.endDialog():this.setupDialog()},DialogPanel.prototype.setupDialog=function(){if(null==this.dialogData)return void console.log("dialog data not set");if(this.textMain.text=this.dialogData.actor.json.Name+": "+this.dialogData.current.DialogueText,null==this.portrait1?this.portrait1=this.setupPortrait(-100,0,"actors2",this.dialogData.actor.json.Pictures+".png"):this.portrait1.frameName!=this.dialogData.actor.json.Pictures&&(this.portrait1.frameName=this.dialogData.actor.json.Pictures+".png"),this.dialogData.links.length>1&&this.dialogData.links[0].Actor==this.dialogEngine.playerActor.id){var a=this.maingame.globalHandler.getActorByID(this.dialogData.links[0].Actor);null==this.portrait2?this.portrait2=this.setupPortrait(-100,200,"actors2",a.json.Pictures+".png"):this.portrait2.frameName!=a.json.Pictures&&(this.portrait2.visible=!0,this.portrait2.frameName=a.json.Pictures+".png");for(var b=0;3>b;b++)null!=this.dialogData.links[b]&&this.dialogData.links[b].Actor==this.dialogEngine.playerActor.id?(this["btnPlay"+(b+1)].visible=!0,this["btnPlay"+(b+1)].textRef.visible=!0,this["btnPlay"+(b+1)].textRef.text=b+1+". "+this.dialogData.links[b].DialogueText,this["btnPlay"+(b+1)].textRef.tint=16777215):(this["btnPlay"+(b+1)].visible=!1,this["btnPlay"+(b+1)].textRef.visible=!1,this["btnPlay"+(b+1)].textRef.text="",this["btnPlay"+(b+1)].textRef.tint=16777215);this.game.input.onDown.remove(this.justDoNext,this)}else this.portrait2&&(this.portrait2.visible=!1),this.hideButtons(),this.game.input.onDown.add(this.justDoNext,this)},DialogPanel.prototype.hideButtons=function(){for(var a=0;3>a;a++)this["btnPlay"+(a+1)].visible=!1,this["btnPlay"+(a+1)].textRef.visible=!1,this["btnPlay"+(a+1)].textRef.text="",this["btnPlay"+(a+1)].textRef.tint=16777215},DialogPanel.prototype.startDialog=function(a){this.dialogData=this.dialogEngine.startConvo(a),console.log("start Dialog",a),this.dialogData?(this.visible=!0,this.y=100,this.x=200,this.setupDialog()):console.log("dialog data not found")},DialogPanel.prototype.endDialog=function(){this.state.exitDialog(),this.visible=!1,this.y=-1e3},JustTextPopup=function(a,b,c,d){Phaser.Group.call(this,a,d);var e=this.game.make.sprite(0,0,"gameplayinterface","dropshadow_btn.png");this.add(e),e.width=900,e.height=600,this.maingame=b,this.textMain=this.game.make.bitmapText(10,10,"simplefont","Text goes here.",35),this.textMain.wordWrap=!0,this.textMain.wordWrapWidth=300,this.add(this.textMain),this.visible=!1},JustTextPopup.prototype=Object.create(Phaser.Group.prototype),JustTextPopup.constructor=JustTextPopup,JustTextPopup.prototype.showText=function(a,b){this.textMain.text=a,this.textMain.tint=b?b:16777215,this.textMain.x=this.game.width/2-this.textMain.width/2,this.textMain.y=this.game.height/2-this.textMain.height/2,this.visible=!0,this.game.input.onDown.add(this.closePopup,this)},JustTextPopup.prototype.closePopup=function(){this.visible=!1,this.game.input.onDown.remove(this.closePopup,this),this.maingame.unpauseGame()};var TextUIHandler=function(a,b,c,d){this.gameref=d,this.game=a,this.justTextPopup,this.barkHandler,this.activeButtons,this.rollovertext,this.mapData};TextUIHandler.prototype.setup=function(a,b){this.mapData=a,this.uiGroup=b,this.justTextPopup=new JustTextPopup(this.game,this.gameref,this.dialoghandler),this.game.add.existing(this.justTextPopup),this.uiGroup.add(this.justTextPopup),this.barkHandler=new BarkTextHandler(this.game,this.gameref),this.game.add.existing(this.barkHandler),this.uiGroup.add(this.barkHandler),this.rollovertext=this.game.make.bitmapText(0,0,"simplefont","Text goes here.",25),this.rollovertext.visible=!1,this.game.add.existing(this.rollovertext),this.uiGroup.add(this.rollovertext)},TextUIHandler.prototype.showDeadText=function(a){this.justTextPopup.showText(a,16711680)},TextUIHandler.prototype.showJustText=function(a){this.justTextPopup.showText(a),GlobalEvents.tempDisableEvents(),this.gameref.pauseGame()},TextUIHandler.prototype.showBark=function(a,b){this.barkHandler.barkOverObject(a,b)},TextUIHandler.prototype.showRollover=function(a,b,c){this.rollovertext&&(this.rollovertext.text=a,this.rollovertext.anchor.x=.5,this.rollovertext.visible=!0,this.rollovertext.x=(b+this.gameref.map.mapGroup.x)*this.gameref.map.scaledto,this.rollovertext.y=(c+this.gameref.map.mapGroup.y)*this.gameref.map.scaledto,this.rollovertext.y<0&&(this.rollovertext.y=c+this.gameref.map.mapGroup.y),this.rollovertext.tint=10066431)},TextUIHandler.prototype.hideRollover=function(){this.rollovertext.visible=!1},TextUIHandler.prototype.update=function(a){this.barkHandler.step(a)},ActionButtons=function(a,b,c){Phaser.Group.call(this,a,c),this.gameref=b,this.currentActive;var d=90,e=this.game.make.sprite(0,0,"gameplayinterface","dropshadow_btn.png");e.x=-20,e.y=20,this.talk={up:null,active:null},this.setButton(3*d,0,"actionButton0001.png","actionButton0003.png",this.talk,this.dotalk,"actionbuttonIcons0005.png"),this.look={up:null,active:null},this.setButton(2*d,0,"actionButton0001.png","actionButton0003.png",this.look,this.dolook,"actionbuttonIcons0007.png"),this.use={up:null,active:null},this.setButton(1*d,0,"actionButton0001.png","actionButton0003.png",this.use,this.douse,"actionbuttonIcons0006.png"),this.walk={up:null,active:null},this.setButton(0*d,0,"actionButton0001.png","actionButton0003.png",this.walk,this.dowalk,"actionbuttonIcons0001.png");var f=35;d=94.7,this.zoomIn={up:null,active:null},this.setButton(this.game.world.width-1*d-f,-50,"actionButtonSqr_end0001.png","actionButtonSqr_end0003.png",this.zoomIn,this.doZoomIn,void 0,!1,"+"),this.zoomIn={up:null,active:null},this.setButton(this.game.world.width-2*d-f,-50,"actionButtonSqr_end0001.png","actionButtonSqr_end0003.png",this.zoomIn,this.doZoomOut,void 0,!1,"-"),this.settings={up:null,active:null},this.setButton(this.game.world.width-1*d-f,0,"actionButtonSqr_end0001.png","actionButtonSqr_end0003.png",this.settings,this.returnToMenu,"actionbuttonIcons0003.png",!0),this.settings={up:null,active:null},this.setButton(this.game.world.width-1*d-f,0,"actionButtonSqr_end0001.png","actionButtonSqr_end0003.png",this.settings,this.returnToMenu,"actionbuttonIcons0003.png",!0),this.combat={up:null,active:null},this.setButton(this.game.world.width-2*d-f,0,"actionButtonSqr0001.png","actionButtonSqr0003.png",this.combat,this.pressedCombat,"actionbuttonIcons0002.png",!0),this.gameref.gGameMode.changeState.add(this.checkCombat,this),this.inv={up:null,active:null},this.setButton(this.game.world.width-3*d-f,0,"actionButtonSqr0001.png","actionButtonSqr0003.png",this.inv,this.doInv,"actionbuttonIcons0004.png",!0),this.gameref.inventory.changeState.add(this.checkInv,this),this.gameref.inventory.invSelected.add(this.invSelected,this),GlobalEvents.SendRefresh.add(this.checkRefresh,this),this.dowalk()},ActionButtons.prototype=Object.create(Phaser.Group.prototype),ActionButtons.constructor=ActionButtons,ActionButtons.prototype.returnToMenu=function(){this.game.state.start("MainMenu")},ActionButtons.prototype.setButton=function(a,b,c,d,e,f,g,h,i){if(e.up=this.game.make.sprite(a,b,"gameplayinterface",c),this.add(e.up),e.up.inputEnabled=!0,e.up.input.priorityID=10,e.up.events.onInputDown.add(f,this),e.active=this.game.make.sprite(a,b,"gameplayinterface",d),e.active.visible=!1,this.add(e.active),h&&(e.active.events.onInputDown.add(f,this),e.active.inputEnabled=!0,e.active.input.priorityID=10),void 0!=g){var j=this.game.make.sprite(a+20,b+10,"gameplayinterface",g);this.add(j)}if(void 0!=i){var k=this.gameref.add.text(a+40,b+10,i);k.font="arial",k.fontSize=20,k.color=16777215,this.add(k)}},ActionButtons.prototype.doInv=function(a,b){b.active=!1,this.gameref.inventory.toggle()},ActionButtons.prototype.checkInv=function(a){a?this.enableButton(this.inv):this.disableButton(this.inv)},ActionButtons.prototype.invSelected=function(){this.clearActive()},ActionButtons.prototype.doZoomIn=function(a,b){this.gameref.zoomIn(a,b)},ActionButtons.prototype.doZoomOut=function(a,b){this.gameref.zoomOut(a,b)},ActionButtons.prototype.doSettings=function(a,b){b.active=!1},ActionButtons.prototype.doCombat=function(a,b){b.active=!1,this.gameref.toggleCombat()},ActionButtons.prototype.checkCombat=function(a,b){"combat"==b?this.enableButton(this.combat):this.disableButton(this.combat)},ActionButtons.prototype.pressedCombat=function(){this.gameref.toggleCombat()},ActionButtons.prototype.doLog=function(a,b){b.active=!1},ActionButtons.prototype.clearActive=function(){this.disableButton(this.currentActive),this.currentActive=null},ActionButtons.prototype.dowalk=function(a,b){b&&(b.active=!1),this.disableButton(this.currentActive),GlobalEvents.currentAction=GlobalEvents.WALK},ActionButtons.prototype.douse=function(a,b){b.active=!1,this.disableButton(this.currentActive),GlobalEvents.currentAction=GlobalEvents.TOUCH},ActionButtons.prototype.dolook=function(a,b){b.active=!1,this.disableButton(this.currentActive),GlobalEvents.currentAction=GlobalEvents.LOOK},ActionButtons.prototype.dotalk=function(a,b){b.active=!1,this.disableButton(this.currentActive),GlobalEvents.currentAction=GlobalEvents.TALK},ActionButtons.prototype.disableAll=function(){this.disableButton(this.currentActive),this.currentActive=null},ActionButtons.prototype.checkRefresh=function(){GlobalEvents.currentAction==GlobalEvents.ITEM&&this.disableAll(),this.currentActive&&this.disableButton(this.currentActive),GlobalEvents.currentAction==GlobalEvents.TALK?(this.currentActive=this.talk,this.enableButton(this.currentActive)):GlobalEvents.currentAction==GlobalEvents.LOOK?(this.currentActive=this.look,this.enableButton(this.currentActive)):GlobalEvents.currentAction==GlobalEvents.WALK?(this.currentActive=this.walk,this.enableButton(this.currentActive)):GlobalEvents.currentAction==GlobalEvents.TOUCH&&(this.currentActive=this.use,this.enableButton(this.currentActive))},ActionButtons.prototype.enableButton=function(a){null!=a&&(a.up.visible=!1,a.active.visible=!0)},ActionButtons.prototype.disableButton=function(a){null!=a&&(a.up.visible=!0,a.active.visible=!1)};var InventoryGraphics=function(a,b,c){Phaser.Group.call(this,a,null),this.startx=0,this.starty=0,this.iwidth=250,this.iheight=40,this.numrows=1,this.numcolumns=5,this.game=a,this.maingame=b,this.globalhandler=c,this.currentitems=[];for(var d=60,e=10,f=0;e>f;f++){var g=this.game.make.sprite(d*f,0,"gameplayinterface","inventoryItem0001.png");g.scale.setTo(.5,.5),g.anchor.setTo(.5,.5),this.addChild(g)}this.selectedBG=this.game.make.sprite(0,-50,"gameplayinterface","inventoryItem0002.png"),this.selectedBG.scale.setTo(.5,.5),this.selectedBG.anchor.setTo(.5,.5),this.selectedBG.visible=!1,this.addChild(this.selectedBG);var h=this.globalhandler.items;if(h)for(var i=0;i<h.length;i++){var j=h[i];null!=j&&(j.OnChangeSignal.add(this.makeReturn(j),this),j.getValue("Inventory")&&this.addInventoryGraphic(j))}this.x=this.game.world.centerX-d*e/2,this.changeState=new Phaser.Signal,this.invSelected=new Phaser.Signal,GlobalEvents.SendRefresh.add(this.checkRefresh,this)};InventoryGraphics.prototype=Object.create(Phaser.Group.prototype),InventoryGraphics.constructor=InventoryGraphics,InventoryGraphics.prototype.makeReturn=function(a){return function(){this.itemChanged(a)}},InventoryGraphics.prototype.toggle=function(){this.visible?this.closeThis():(this.visible=!0,this.changeState.dispatch(!0,this))},InventoryGraphics.prototype.closeThis=function(){this.visible=!1,this.changeState.dispatch(!1,this),console.log("close",GlobalEvents.currentAction),GlobalEvents.currentAction==GlobalEvents.ITEM&&GlobalEvents.gotoLastAction()},InventoryGraphics.prototype.itemChanged=function(a){if(null!=a){var b=a.getValue("Inventory"),c=this.findItem(a);b&&-1==c?this.addInventoryGraphic(a):!b&&c>-1&&(this.destroyGraphicItem(this.currentitems[c]),this.currentitems.splice(c,1),this.resuffle(),this.selectedBG.visible=!1)}},InventoryGraphics.prototype.findItem=function(a){for(var b=0;b<this.currentitems.length;b++)if(this.currentitems[b].item.id==a.id)return b;return-1},InventoryGraphics.prototype.updateSelf=function(){console.log("do graphics")},InventoryGraphics.prototype.destroyGraphicItem=function(a){null!=a&&a.destroy()},InventoryGraphics.prototype.addInventoryGraphic=function(a){var b=new InventoryObject(this.game,this,"inventory",a.getValue("InventoryGraphicName")+".png",a);console.log(a.getValue("InventoryGraphicName")),b.anchor.setTo(.5,.5),this.add(b),this.currentitems.push(b),this.resuffle()},InventoryGraphics.prototype.highlight=function(a){this.selectedBG.visible=!0,this.selectedBG.x=a.x,this.selectedBG.y=a.y},InventoryGraphics.prototype.resuffle=function(){for(var a=(this.iwidth-this.startx)/this.numcolumns,b=0;b<this.currentitems.length;b++)this.currentitems[b].x=this.startx+b*a,this.currentitems[b].y=this.starty},InventoryGraphics.prototype.checkRefresh=function(){GlobalEvents.currentAction!=GlobalEvents.ITEM&&(this.selectedBG.visible=!1)};var NormalUI=function(a,b,c,d){this.game=a,this.gameref=b,this.globalHandler=c,this.uiGroup=d,this.activeButtons=new ActionButtons(this.game,this.gameref),this.activeButtons.x=20,this.activeButtons.y=this.game.world.height-70,this.game.add.existing(this.activeButtons),this.uiGroup.add(this.activeButtons)};NormalUI.prototype.hide=function(){this.activeButtons.visible=!1},NormalUI.prototype.show=function(){this.activeButtons.visible=!0};var InventoryObject=function(a,b,c,d,e){Phaser.Image.call(this,a,0,0,c,d),this.inventory=b,this.item=e,this.events.onInputDown.add(this.handleClick,this),this.inputEnabled=!0};InventoryObject.prototype=Object.create(Phaser.Image.prototype),InventoryObject.constructor=InventoryObject,InventoryObject.prototype.handleClick=function(){GlobalEvents.currentAction=GlobalEvents.ITEM,GlobalEvents.selectedItem=this.item,this.inventory.highlight(this),this.inventory.invSelected.dispatch(this.item,this,this.inventory)};