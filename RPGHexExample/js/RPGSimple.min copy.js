function saveState(a){window.localStorage.setItem("gameState",JSON.stringify(a))}function restoreState(){var a=window.localStorage.getItem("gameState");return a?JSON.parse(a):null}ActionButtons=function(a,b,c){Phaser.Group.call(this,a,c),this.currentActive,this.walk={up:null,active:null},this.setButton(0,0,"walkBtn0001.png","walkBtn0002.png",this.walk,this.dowalk),this.use={up:null,active:null},this.setButton(71,0,"useBtn0001.png","useBtn0002.png",this.use,this.douse),this.look={up:null,active:null},this.setButton(142,0,"lookBtn0001.png","lookBtn0002.png",this.look,this.dolook),this.talk={up:null,active:null},this.setButton(212,0,"talkBtn0001.png","talkBtn0002.png",this.talk,this.dotalk),GlobalEvents.SendRefresh.add(this.checkRefresh,this),this.dowalk()},ActionButtons.prototype=Object.create(Phaser.Group.prototype),ActionButtons.constructor=ActionButtons,ActionButtons.prototype.setButton=function(a,b,c,d,e,f){e.up=this.game.make.sprite(a,b,"dialogui",c),this.add(e.up),e.up.inputEnabled=!0,e.up.events.onInputDown.add(f,this),e.active=this.game.make.sprite(a,b,"dialogui",d),e.active.visible=!1,this.add(e.active)},ActionButtons.prototype.dowalk=function(){this.disableButton(this.currentActive),GlobalEvents.currentacion=GlobalEvents.WALK,this.currentActive=this.walk,this.enableButton(this.currentActive)},ActionButtons.prototype.douse=function(){this.disableButton(this.currentActive),GlobalEvents.currentacion=GlobalEvents.TOUCH,this.currentActive=this.use,this.enableButton(this.currentActive)},ActionButtons.prototype.dolook=function(){this.disableButton(this.currentActive),GlobalEvents.currentacion=GlobalEvents.LOOK,this.currentActive=this.look,this.enableButton(this.currentActive)},ActionButtons.prototype.dotalk=function(){this.disableButton(this.currentActive),GlobalEvents.currentacion=GlobalEvents.TALK,this.currentActive=this.talk,this.enableButton(this.currentActive)},ActionButtons.prototype.disableAll=function(){this.disableButton(this.currentActive),this.currentActive=null},ActionButtons.prototype.checkRefresh=function(){GlobalEvents.currentacion==GlobalEvents.ITEM&&this.disableAll()},ActionButtons.prototype.enableButton=function(a){null!=a&&(a.up.visible=!1,a.active.visible=!0)},ActionButtons.prototype.disableButton=function(a){null!=a&&(a.up.visible=!0,a.active.visible=!1)},BasicObjectPool=function(a){this.openArray=[],this.allObjectsArray=[],this.handler=a||null},BasicObjectPool.prototype.getObject=function(){if(this.openArray.length>0)return this.openArray.pop();var a=this.handler.createItem();return this.openArray.push(a),this.allObjectsArray.push(a),a},BasicObjectPool.prototype.addObject=function(a){this.openArray.push(a),this.allObjectsArray.push(a)},BasicObjectPool.prototype.returnObject=function(a){a.reset(),this.openArray.push(a)},BasicObjectPool.prototype.destroyself=function(){this.allObjectsArray=[],this.openArray=[]};var CheapMasker=function(a,b,c){this.game=a,this.maingame=b,this.maskableobjects=c};CheapMasker.prototype.updateMasks=function(a,b,c,d){if(this.maskableobjects)for(var e,f=!1,g=0;g<this.maskableobjects.length;g++)e=this.maskableobjects[g],null!=e&&(e.left<=a&&a<e.right&&e.top<=b&&b<e.bottom&&(f=!0,e.posy==d?e.posx<c?f=!0:e.posx>c&&(f=!1):e.posy>d?f=!0:e.posy<d&&(f=!1)),f?e.alpha=.5:1!=e.alpha&&(e.alpha=1)),f=!1};var DialogHandler=function(a,b,c,d){this.game=a,this.maingame=b,this.conversations=c,this.actors=d,this.currentConvo,this.playerActor=this.maingame.globalHandler.getPlayerActor(),this.eventDispatcher=new EventDispatcher(a,b,null)};DialogHandler.prototype.startConvo=function(a){if(this.currentConvo=this.getConversationsByID(a),null!=this.currentConvo){var b=this.buildDialogByID(0);if(null!=b)return b}return null},DialogHandler.prototype.doActions=function(a){if(a.actions&&a.actions.length>0){var b=[];this.eventDispatcher.helpSetActions(b,a.actions,!1,null),b.length>0&&this.eventDispatcher.completeAction(b)}},DialogHandler.prototype.getNextDialog=function(a){return null==a?null:(this.doActions(a),this.buildDialogWithDiag(a))},DialogHandler.prototype.buildDialogWithDiag=function(a){if(null==a)return null;for(var b,c=[],d=a.links.length,e=0;d>e;e++){var b=this.getDialogByID(a.links[e].DestID);if(null!=b){var f={logic:"Any",list:[]};this.eventDispatcher.applyConditions(f,b.conditions),this.eventDispatcher.testConditions(f)&&c.push(b)}}var g=this.maingame.globalHandler.getActorByID(a.Actor),h={current:a,links:c,actor:g};return h},DialogHandler.prototype.buildDialogByID=function(a){var b=this.getDialogByID(a);return null==b?null:this.buildDialogWithDiag(b)},DialogHandler.prototype.getDialogByID=function(a){for(var b=this.currentConvo.DialogueEntries.length,c=0;b>c;c++)if(this.currentConvo.DialogueEntries[c].ID==a)return this.currentConvo.DialogueEntries[c];return null},DialogHandler.prototype.getConversationsByID=function(a){for(var b=this.conversations.length,c=0;b>c;c++)if(this.conversations[c].id==a)return this.conversations[c];return null};var EventDispatcher=function(a,b,c){this.game=a,this.maingame=b,this.object=c,null!=c&&GlobalEvents.allEventDispatchers.push(this)};EventDispatcher.prototype.receiveData=function(a){this.onTouchAction,this.onLookAction,this.onTalkAction,this.onItemAction,this.onEnterAction,this.onStartAction,this.onActivateAction,this.init(a)},EventDispatcher.prototype.testAction=function(){this.object&&(this.object.inputEnabled=this.shouldBeActive())},EventDispatcher.prototype.shouldBeActive=function(){return GlobalEvents.currentacion==GlobalEvents.WALK?!1:GlobalEvents.currentacion==GlobalEvents.TOUCH&&this.onTouchAction?!0:GlobalEvents.currentacion==GlobalEvents.LOOK&&this.onLookAction?!0:GlobalEvents.currentacion==GlobalEvents.TALK&&this.onTalkAction?!0:GlobalEvents.currentacion==GlobalEvents.ITEM&&this.onItemAction?!0:!1},EventDispatcher.prototype.init=function(a){for(var b,c,d,e,f,g=0;g<a.length;g++)if(b=a[g],d=b.trigger,f=null,b.conditions&&(f={logic:"Any",list:[]},"OnUseItem"==d&&f.list.push({special:!0,func:GlobalEvents.checkSelectItem,para:[b.itemid],callee:this}),b.conditions.conditions&&this.applyConditions(f,b.conditions)),b.actions)for(var h=0;h<b.actions.length;h++)c=b.actions[h],e=this.getEventType(d),this.setActions(e,c,b.once,f,b.walkto||!1)},EventDispatcher.prototype.helpSetActions=function(a,b,c,d){if(null!=b)for(var e=0;e<b.length;e++)null!=b[e]&&this.setActions(a,b[e],c,d,!1)},EventDispatcher.prototype.setActions=function(a,b,c,d,e){"ChangeMap"==b.type?a.push({func:this.maingame.userExit,para:[b],removeself:c,callee:this.maingame,con:d,walkto:e}):"CONVERSATION"==b.type?a.push({func:this.maingame.showDialog,para:[b.id],removeself:c,callee:this.maingame,con:d,walkto:e}):"SIMPLE"==b.type?a.push({func:this.maingame.showJustText,para:[b.text],removeself:c,callee:this.maingame,con:d,walkto:e}):"BARK"==b.type?a.push({func:this.maingame.showBark,para:[this.object,b.text],removeself:c,callee:this.maingame,con:d,walkto:e}):"THIS"==b.type?a.push({func:this.object.callFunction,para:[b["function"],b.parameters],removeself:!1,callee:this.object,con:d,walkto:e}):"Item"==b.type?a.push({func:this.maingame.globalHandler.updateItem,para:[b.name,b.mode,b.variable,b.value],removeself:!1,callee:this.maingame.globalHandler,con:d,walkto:e}):"Actor"==b.type?a.push({func:this.maingame.globalHandler.updateActor,para:[b.name,b.mode,b.variable,b.value],removeself:!1,callee:this.maingame.globalHandler,con:d,walkto:e}):"Variable"==b.type?a.push({func:this.maingame.globalHandler.updateVariableByID,para:[b.name,b.mode,b.value],removeself:!1,callee:this.maingame.globalHandler,con:d,walkto:e}):"Quest"==b.type},con={logic:"Any",list:[]},EventDispatcher.prototype.applyConditions=function(a,b){for(var c=b.conditions,d=b.logic,e=a.list,f=0;f<c.length;f++)condition=c[f],"Item"==condition.type?e.push({func:this.maingame.globalHandler.compareItemValue,para:[condition.name,condition.variable,condition.compare,condition.value],callee:this.maingame.globalHandler}):"Actor"==condition.type?e.push({func:this.maingame.globalHandler.compareActorValue,para:[condition.name,condition.variable,condition.compare,condition.value],callee:this.maingame.globalHandler}):"Variable"==condition.type?e.push({func:this.maingame.globalHandler.compareVariableValue,para:[condition.name,condition.compare,condition.value],callee:this.maingame.globalHandler}):"Quest"==condition.type?e.push({func:this.maingame.globalHandler.compareQuestValue,para:[condition.name,condition.compare,condition.value],callee:this.maingame.globalHandler}):"THIS"==condition.type?e.push({func:this.object.testTHISValues,para:[condition.variable,condition.compare,condition.value],callee:this.object}):console("Apply conditions unknown",condition.type,condition);return a.logic=d,a.list=e,a},EventDispatcher.prototype.testConditions=function(a){if(!a.list)return!0;if(a.list.length<=0)return!0;for(var b,c=a.list,d=a.logic,e=!1,f=0;f<c.length;f++){if(b=c[f].func.apply(c[f].callee,c[f].para),c[f].special&&0==b)return!1;if("All"==d){if(0==b)return!1;e=!0}else if(1==b)return!0}return e},EventDispatcher.prototype.doAction=function(a){var b=this.getEventType(a);this.completeAction(b,!1)},EventDispatcher.prototype.completeAction=function(a,b){var c,d=!1,e=[],f=[];if(a.length>0){for(var g=0;g<a.length;g++)if(null!=a[g]){if(a[g].con&&(a[g].con!=c&&(d=this.testConditions(a[g].con),c=a[g].con),!d))continue;if(a[g].walkto){var h=this.maingame.hexHandler.areTilesNeighbors(this.object.currentTile,this.maingame.playerCharacter.currentTile);if(!h||!b){f.push(a[g]);continue}}e.push(a[g])}f.length>0&&this.maingame.moveToAction(this.object,this.object.currentTile,f),this.dogivenactions(e)}},EventDispatcher.prototype.dogivenactions=function(a){for(var b=0;b<a.length;b++)a[b]&&a[b].func.apply(a[b].callee,a[b].para),a[b].removeself&&(a[b]=null)},EventDispatcher.prototype.getEventType=function(a){return"OnEnter"==a?(this.onEnterAction=this.onEnterAction||[],this.onEnterAction):"OnStart"==a?(this.onStartAction=this.onStartAction||[],this.onStartAction):"OnTouch"==a?(this.onTouchAction=this.onTouchAction||[],this.onTouchAction):"OnTalk"==a?(this.onTalkAction=this.onTalkAction||[],this.onTalkAction):"OnLook"==a?(this.onLookAction=this.onLookAction||[],this.onLookAction):"OnActivate"==a?(this.onActivateAction=this.onActivateAction||[],this.onActivateAction):"OnUseItem"==a?(this.onItemAction=this.onItemAction||[],this.onItemAction):void 0},EventDispatcher.prototype.destroy=function(){this.onTouchAction=null,this.onLookAction=null,this.onTalkAction=null,this.onItemAction=null,this.onEnterAction=null,this.onStartAction=null,this.onActivateAction=null};var EventConv=function(){};EventConv.prototype.removeSelf=function(){},EventConv.prototype.activateEvent=function(){this.maingame.showDialog(this.convid),this.once};var EventnText=function(){},GlobalHandler=function(a,b,c,d,e,f){this.game=a,this.maingame=b,this.actors=[],this.playerActor;for(var g=0;g<c.length;g++)this.actors[c[g].id.toString()]=new ActorObject(c[g]),"Player"==c[g].Name&&(this.playerActor=this.actors[c[g].id.toString()]);this.variables=[];for(var g=0;g<d.length;g++)this.variables[d[g].id.toString()]=new VariableObject(d[g]);this.items=[],this.quests=[];for(var g=0;g<f.length;g++)f[g]["Is Item"]?this.items[f[g].id.toString()]=new ItemObject(f[g]):this.quests[f[g].id.toString()]=new QuestObject(f[g]);this.maps=[]};GlobalHandler.prototype.SaveGame=function(){},GlobalHandler.prototype.compareQuestValue=function(a,b,c){return this.quests[a]?this.doCompare(b,this.quests[a].State,c):!1},GlobalHandler.prototype.updateQuestByID=function(a,b,c){return this.quests[a]?("Add"==b?this.quests[a].value+=parseFloat(c):this.quests[a].value=c,!0):!1},GlobalHandler.prototype.compareVariableValue=function(a,b,c){return this.variables[a]?this.doCompare(b,this.variables[a].value,c):!1},GlobalHandler.prototype.getVariableValue=function(a){return this.variables[a]?this.variables[a].value:null},GlobalHandler.prototype.updateVariableByID=function(a,b,c){return this.variables[a]?("Add"==b?this.variables[a].value+=parseFloat(c):this.variables[a].value=c,!0):!1},GlobalHandler.prototype.doCompare=function(a,b,c){return"Is"==a?b==c:"IsNot"==a?b!=c:"Less"==a?c>b:"Greater"==a?b>c:"LessEqual"==a?c>=b:"GreaterEqual"==a?b>=c:void 0},GlobalHandler.prototype.compareItemValue=function(a,b,c,d){return this.items[a]?null==this.items[a].json[b]?!1:this.doCompare(c,this.items[a].json[b],d):!1},GlobalHandler.prototype.getItemValue=function(a,b){return this.items[a]?this.items[a].json[b]:null},GlobalHandler.prototype.getItemByID=function(a){return this.items[a]?this.items[a]:null},GlobalHandler.prototype.updateItem=function(a,b,c,d){var e=this.getItemByID(a);e?"Add"==b?e.addValue(c,d):e.updateValue(c,d):console.log(a,"not found")},GlobalHandler.prototype.compareActorValue=function(a,b,c,d){return this.actors[a]&&this.actors[a].json[b]?this.doCompare(c,this.actors[a].json[b],d):!1},GlobalHandler.prototype.getActorValue=function(a,b){return this.actors[a]?this.actors[a].json[b]:null},GlobalHandler.prototype.getPlayerActor=function(){return this.playerActor},GlobalHandler.prototype.getActorByID=function(a){return this.actors[a]?this.actors[a]:null},GlobalHandler.prototype.updateActor=function(a,b,c,d){var e=this.getActorByID(a);e?"Add"==b?e.addValue(c,d):e.updateValue(c,d):console.log(a,"not found")},GlobalHandler.prototype.setActor=function(a,b){this.actors[a]&&this.actors[i].bind.push(b)};var BaseObject=function(a){this.OnChangeSignal=new Phaser.Signal,this.json=a,this.id=a.id};BaseObject.prototype.updateValue=function(a,b){this.json[a]=b,this.OnChangeSignal.dispatch([this])},BaseObject.prototype.addValue=function(a,b){null!=this.json[a]&&(this.json[a]+=b),this.OnChangeSignal.dispatch([this])},BaseObject.prototype.getValue=function(a){return null!=this.json&&null!=this.json[a]?this.json[a]:null};var ItemObject=function(a){BaseObject.call(this,a),this.id=a.id};ItemObject.prototype=Object.create(BaseObject.prototype),ItemObject.constructor=ItemObject;var ActorObject=function(a){BaseObject.call(this,a),this.bind=[]};ActorObject.prototype=Object.create(BaseObject.prototype),ActorObject.constructor=ActorObject;var QuestObject=function(a){BaseObject.call(this,a)};QuestObject.prototype=Object.create(BaseObject.prototype),QuestObject.constructor=QuestObject,Object.defineProperty(QuestObject,"value",{get:function(){return this._value},set:function(a){this._value=a,this.OnChangeSignal.dispatch([this])}});var VariableObject=function(a){BaseObject.call(this,a),this.id=a.id,this.name=a.Name,this._value=a["Initial Value"],this.description=a.Description};VariableObject.prototype=Object.create(BaseObject.prototype),VariableObject.constructor=VariableObject,Object.defineProperty(VariableObject,"value",{get:function(){return this._value},set:function(a){this._value=a,this.OnChangeSignal.dispatch([this])}});var GlobalEvents=function(){};GlobalEvents.allEventDispatchers=[],GlobalEvents.SendRefresh=new Phaser.Signal,GlobalEvents.DISABLE=-1,GlobalEvents.WALK=0,GlobalEvents.LOOK=1,GlobalEvents.TOUCH=2,GlobalEvents.TALK=3,GlobalEvents.ITEM=4,GlobalEvents.lastAction=GlobalEvents.DISABLE,GlobalEvents._currentacion=GlobalEvents.WALK,GlobalEvents.selectedItem=null,Object.defineProperty(GlobalEvents,"currentacion",{get:function(){return GlobalEvents._currentacion},set:function(a){GlobalEvents._currentacion==GlobalEvents.DISABLE&&a!=GlobalEvents.DISABLE?GlobalEvents.lastAction=a:(GlobalEvents.lastAction=GlobalEvents._currentacion,GlobalEvents._currentacion=a,GlobalEvents.refreshEvents())}}),GlobalEvents.tempDisableEvents=function(){GlobalEvents.currentacion=GlobalEvents.DISABLE},GlobalEvents.reEnableEvents=function(){GlobalEvents._currentacion==GlobalEvents.DISABLE&&(GlobalEvents._currentacion=GlobalEvents.lastAction,GlobalEvents.refreshEvents())},GlobalEvents.checkSelectItem=function(a){return null==GlobalEvents.selectedItem?!1:GlobalEvents.selectedItem.id==a},GlobalEvents.flushEvents=function(){GlobalEvents.allEventDispatchers=[]},GlobalEvents.refreshEvents=function(){for(var a=GlobalEvents.allEventDispatchers,b=0;b<a.length;b++)a[b].testAction();GlobalEvents.SendRefresh.dispatch([this])};var HexHandler=function(a,b,c,d){this.maingame=a,this.game=b,this.debug=!0,this.visited=[],this.fringes=[],this.hexagonArray=[],this.waterTilesArray=[],this.hexagonWidth=c||32,this.hexagonHeight=d||16,this.sectorWidth=this.hexagonWidth,this.sectorHeight=this.hexagonHeight/4*3,this.halfHex=this.hexagonWidth/2,this.halfHexHeight=this.hexagonHeight/2,this.gradient=this.hexagonHeight/4/(this.hexagonWidth/2);var e=new Phaser.Image(b,0,0,"tiles2","hextiletouchmap.png");this.touchmap=new Phaser.BitmapData(b,"touchmap",56,16),this.touchmap.draw(e,0,0),this.touchmap.update()};HexHandler.prototype.update=function(a){if(this.waterTilesArray)for(var b=this.waterTilesArray.length,c=0;b>c;c++)this.waterTilesArray[c].step(a)},HexHandler.prototype.checkHex=function(a,b){if(this.hexagonArray){var c=a%this.sectorWidth,d=b%this.sectorHeight,e=Math.floor(a/this.sectorWidth),f=Math.floor(b/this.sectorHeight);if(f%2==0?(d<this.hexagonHeight/4-c*this.gradient&&(e--,f--),d<-this.hexagonHeight/4+c*this.gradient&&f--):c>=this.hexagonWidth/2?d<this.hexagonHeight/2-c*this.gradient&&f--:d<c*this.gradient?f--:e--,this.maingame.gridSizeY%2==0&&f%2==1&&0>e&&(e=0),!(0>e||0>f||f>=this.maingame.gridSizeY||e>=this.maingame.gridSizeX))return this.hexagonArray[e][f]}},HexHandler.prototype.getTileByCords=function(a,b){return this.hexagonArray[a]&&this.hexagonArray[a][b]?this.hexagonArray[a][b]:null},HexHandler.prototype.lineTest=function(a,b){var c=new Point(a.x+this.halfHex,a.y+this.halfHexHeight),d=new Point(b.x+this.halfHex,b.y+this.halfHexHeight),e=this.game.math.distance(c.x,c.y,d.x,d.y),f=this.hexagonWidth;this.hexagonWidth>this.hexagonHeight&&(f=this.hexagonHeight),e=this.game.math.ceil(e/this.cut)+1;for(var g=[],h=0;e>=h;h++){var i=0==e?0:h/e;g.push(this.lerp_point(c,d,i))}for(var j=0;j<g.length;j++){var k=this.checkHex(g[j].x,g[j].y);if(null==k)return null;if(!k.walkable)return k}return b},HexHandler.prototype.dolines=function(a,b,c,d){if(null!=a&&null!=b){var e=new Point(a.x+this.halfHex,a.y+this.halfHexHeight),f=new Point(b.x+this.halfHex,b.y+this.halfHexHeight);this.debug&&(this.maingame.graphics.clear(),this.maingame.graphics.lineStyle(10,16767232,1));var g=this.game.math.distance(e.x,e.y,f.x,f.y),h=this.hexagonWidth;this.hexagonWidth>this.hexagonHeight&&(h=this.hexagonHeight),g=this.game.math.ceil(g/h)+1;for(var i=[],j=0;g>=j;j++){var k=0==g?0:j/g;i.push(this.lerp_point(e,f,k))}var l=[];this.debug&&(this.maingame.graphics.lineStyle(0),this.maingame.graphics.beginFill(65291,.5));d&&d.cleanuptiles();for(var m=0;m<i.length;m++){var n=this.checkHex(i[m].x,i[m].y);if(this.debug&&this.maingame.graphics.drawCircle(i[m].x+this.maingame.mapGroup.x,i[m].y+this.maingame.mapGroup.y,10),null!=n){if(!n.walkable&&!c)break;l.push(n),d&&d.highlighttilebytile(m,n)}}return this.debug&&this.maingame.graphics.endFill(),l}},HexHandler.prototype.getlinepath=function(a,b,c){if(null!=a&&null!=b){var d=new Point(a.x+this.halfHex,a.y+this.halfHexHeight),e=new Point(b.x+this.halfHex,b.y+this.halfHexHeight),f=this.game.math.distance(d.x,d.y,e.x,e.y),g=this.hexagonWidth;this.hexagonWidth>this.hexagonHeight&&(g=this.hexagonHeight),f=this.game.math.ceil(f/g)+1;for(var h=[],i=0;f>=i;i++){var j=0==f?0:i/f;h.push(this.lerp_point(d,e,j))}for(var k=[],l=0;l<h.length;l++){var m=this.checkHex(h[l].x,h[l].y);if(null!=m){if(!m.walkable&&!c)break;k.push(m)}}return k}},HexHandler.prototype.round_point=function(a){return new Point(Math.round(a.x),Math.round(a.y))},HexHandler.prototype.lerp=function(a,b,c){return a+c*(b-a)},HexHandler.prototype.lerp_point=function(a,b,c){return new Point(this.lerp(a.x,b.x,c),this.lerp(a.y,b.y,c))},HexHandler.prototype.doFloodFill=function(a,b){if(null!=a){this.visited=[],this.visited.push(a),this.fringes=[],this.fringes.push([a]);for(var c=1;b>=c;c++){this.fringes.push([]);for(var d=0;d<this.fringes[c-1].length;d++){var e=this.fringes[c-1][d];e.posx%2==1?(this.addNeighbor(e,0,-1,c),this.addNeighbor(e,-1,0,c),this.addNeighbor(e,0,1,c),this.addNeighbor(e,1,1,c),this.addNeighbor(e,1,0,c),this.addNeighbor(e,-1,1,c)):(this.addNeighbor(e,-1,-1,c),this.addNeighbor(e,-1,0,c),this.addNeighbor(e,0,1,c),this.addNeighbor(e,1,0,c),this.addNeighbor(e,0,-1,c),this.addNeighbor(e,1,-1,c))}}return this.fringes}},HexHandler.prototype.addNeighbor=function(a,b,c,d){b=a.posx+b,c=a.posy+c;var e=this.getTileByCords(b,c);null!=e&&e.walkable&&-1==this.visited.indexOf(e)&&(this.visited.push(e),this.fringes[d].push(e))},HexHandler.prototype.getFrigesAsArray=function(){for(var a=[],b=0;b<fridges.length;b++)for(var c=0;c<fridges[b].length;c++)a.push(fridges[b][c]);return a},HexHandler.prototype.areTilesNeighbors=function(a,b){var c=a.x-b.x,d=a.y-b.y;if(a.x%2==1){if(0==c&&-1==d)return!0;if(-1==c&&0==d)return!0;if(0==c&&1==d)return!0;if(1==c&&1==d)return!0;if(1==c&&0==d)return!0;if(-1==c&&1==d)return!0}else{if(-1==c&&-1==d)return!0;if(-1==c&&0==d)return!0;if(0==c&&1==d)return!0;if(1==c&&0==d)return!0;if(0==c&&-1==d)return!0;if(1==c&&-1==d)return!0}return!1},HexHandler.prototype.findClosesInPath=function(a,b,c){for(var d=-1,e=-1,f=c.length;f>0;f--)for(var g=0;g<b.length;g++)c[f]===b[g]&&(e=f,d=g);return-1!=e?(c=c.splice(e,c.length-e),b[g]):a},HexHandler.prototype.pathCoordsToTiles=function(a){newpath=[];for(var b=0;b<a.length;b++){var c=this.getTileByCords(a[b].x,a[b].y);null!=c&&newpath.push(c)}return newpath},HexHandler.prototype.flush=function(){this.hexagonArray=[],this.waterTilesArray=[]};var DiamondHexHandler=function(a,b,c,d){HexHandler.call(this,a,b,c,d)};DiamondHexHandler.prototype=Object.create(HexHandler.prototype),DiamondHexHandler.constructor=DiamondHexHandler,DiamondHexHandler.prototype.isInsideTriangle=function(a,b,c,d){var e=(a.x-d.x)*(b.y-d.y)-(b.x-d.x)*(a.y-d.y),f=(b.x-d.x)*(c.y-d.y)-(c.x-d.x)*(b.y-d.y),g=(c.x-d.x)*(a.y-d.y)-(a.x-d.x)*(c.y-d.y);return this.sign(e)==this.sign(f)&&this.sign(f)==this.sign(g)},DiamondHexHandler.prototype.sign=function(a){return Math.abs(a)/a},DiamondHexHandler.prototype.checkHex=function(a,b){if(this.hexagonArray){var c=this.hexagonWidth,d=this.hexagonHeight/4*3,e=a/c-b/(2*d),f=b/d+Math.floor(e/2);if(e=Math.floor(e),f=Math.floor(f),!(0>e||0>f||f>=this.maingame.movementgrid.gridSizeY||e>=this.maingame.movementgrid.gridSizeX)){var g=this.hexagonArray[e][f];if(null!=g){var h=this.touchmap.getPixel32(a-g.x,b-g.y),i=255&h,j=h>>8&255,k=h>>16&255;if(i>0&&j>0&&k>0||0==i&&0==j&&0==k)return g;if(0==i&&j>0&&k>0?e%2==0?e++:(e++,f++):i>0&&0==j&&0==k?f--:i>0&&j>0&&0==k?e%2==0?(e++,f--):e++:0==i&&j>0&&0==k?e%2==0?e--:(e--,f--):0==i&&0==j&&k>0&&f++,!(0>e||0>f||f>=this.maingame.movementgrid.gridSizeY||e>=this.maingame.movementgrid.gridSizeX))return g=this.hexagonArray[e][f]}}}},DiamondHexHandler.prototype.areTilesNeighbors=function(a,b){if(null==a||null==b)return!1;var c=a.posx-b.posx,d=a.posy-b.posy;if(a==b)return!0;if(a.x%2==1){if(0==c&&-1==d)return!0;if(-1==c&&0==d)return!0;if(0==c&&1==d)return!0;if(1==c&&1==d)return!0;if(1==c&&0==d)return!0;if(-1==c&&1==d)return!0}else{if(-1==c&&-1==d)return!0;if(-1==c&&0==d)return!0;if(0==c&&1==d)return!0;if(1==c&&0==d)return!0;if(0==c&&-1==d)return!0;if(1==c&&-1==d)return!0}return!1},DiamondHexHandler.prototype.doFloodFill=function(a,b){if(null!=a){this.visited=[],this.visited.push(a),this.fringes=[],this.fringes.push([a]);for(var c=1;b>=c;c++){this.fringes.push([]);for(var d=0;d<this.fringes[c-1].length;d++){var e=this.fringes[c-1][d];e.posx%2==1?(this.addNeighbor(e,0,-1,c),this.addNeighbor(e,-1,0,c),this.addNeighbor(e,0,1,c),this.addNeighbor(e,1,1,c),this.addNeighbor(e,1,0,c),this.addNeighbor(e,-1,1,c)):(this.addNeighbor(e,-1,-1,c),this.addNeighbor(e,-1,0,c),this.addNeighbor(e,0,1,c),this.addNeighbor(e,1,0,c),this.addNeighbor(e,0,-1,c),this.addNeighbor(e,1,-1,c))}}return this.fringes}};var HighlightHex=function(a,b,c){Phaser.Group.call(this,a,null),this.game=a,this.maingame=b,this.hexhandler=c,this.showNumbers=!0,this.neighborLights=[],this.showPath=!0};HighlightHex.prototype=Object.create(Phaser.Group.prototype),HighlightHex.constructor=HighlightHex,HighlightHex.prototype.setup=function(){this.neighborLights=[];for(var a=0;40>a;a++){var b=this.add(new Phaser.Group(this.game,null)),c=this.add(new Phaser.Sprite(this.game,0,0,"tiles2","tile_highlight0005.png"));this.neighborLights.push(b),b.add(c),this.add(b),this.showNumbers,b.x=-1e3,b.visible=!1}},HighlightHex.prototype.drawFringes=function(a){if(null!=a){this.cleanuptiles();for(var b=[],c=0;c<a.length;c++)for(var d=0;d<a[c].length;d++)b.push(a[c][d]);for(var c=0;c<b.length;c++)this.highlighttilebytile(c,b[c])}},HighlightHex.prototype.doShowPath=function(a,b,c){null!=c&&b&&(this.showPath=!0,a.setCallbackFunction(this.showPathCallback,this),a.preparePathCalculation([b.posx,b.posy],[c.posx,c.posy]),a.calculatePath())},HighlightHex.prototype.showPathCallback=function(a){if(this.showPath){this.cleanuptiles();for(var b=0;b<a.length;b++){var c=this.hexhandler.getTileByCords(a[b].x,a[b].y);null!=c&&this.highlighttilebytile(b,c)}}},HighlightHex.prototype.hidePath=function(){this.showPath=!1},HighlightHex.prototype.drawDebugLine=function(a,b){moveIndex&&b&&this.hexHandler.dolines(a,b,!1,this)},HighlightHex.prototype.highilightneighbors=function(a){null!=a&&(a.posx%2==1?(this.highlighttileoffset(0,0,-1,a),this.highlighttileoffset(1,-1,0,a),this.highlighttileoffset(2,0,1,a),this.highlighttileoffset(3,1,1,a),this.highlighttileoffset(4,1,0,a),this.highlighttileoffset(5,-1,1,a)):(this.highlighttileoffset(0,-1,-1,a),this.highlighttileoffset(1,-1,0,a),this.highlighttileoffset(2,0,1,a),this.highlighttileoffset(3,1,0,a),this.highlighttileoffset(4,0,-1,a),this.highlighttileoffset(5,1,-1,a)))},HighlightHex.prototype.highlighttileoffset=function(a,b,c,d){var e=this.hexhandler.getTileByCords(d.posx+b,d.posy+c);null!=e&&(this.neighborLights[a].visible=!0,this.neighborLights[a].x=e.x,this.neighborLights[a].y=e.y)},HighlightHex.prototype.cleanuptiles=function(){for(var a=0;a<this.neighborLights.length;a++)this.neighborLights[a].x=-1e3,this.neighborLights[a].visible=!1},HighlightHex.prototype.highlighttilebytile=function(a,b){null!=this.neighborLights[a]&&(null!=b?(this.neighborLights[a].visible=!0,this.neighborLights[a].x=b.x,this.neighborLights[a].y=b.y):(this.neighborLights[a].x=-1e3,this.neighborLights[a].y=0))};var InteractiveObject=function(a,b){this.maingame=a,this.game=a.game,this.jsondata=b,this.posx,this.posy,this.currentTile,this.hasstates=!1,this.eventDispatcher=new EventDispatcher(this.game,this.maingame,this)};InteractiveObject.prototype=Object.create(Phaser.Sprite.prototype),InteractiveObject.constructor=InteractiveObject,InteractiveObject.prototype.dosetup=function(){this.eventDispatcher.init(this.jsondata.triggers),this.setupArt(this.jsondata),this.footprint,this.setupReactToAction(),this.inputEnabled=!0;for(var a=this.jsondata.triggers,b=0;b<a.length;b++){if("actorset"==a[b].type&&(this.actor=this.maingame.globalHandler.getActorByID(a[b].id)),"walkTiles"==a[b].type){this.footprint=[];for(var c=0;c<a[b].tiles.length;c++)this.footprint.push(this.maingame.hexHandler.getTileByCords(a[b].tiles[c].posx,a[b].tiles[c].posy))}if("animations"==a[b].type){var d,e=a[b].animations;this.hasstates=!0;for(var c=0;c<e.length;c++)d=0==e[c].start&&0==e[c].stop?this.animations.add(e[c].id,[e[c].name+".png"],1,e[c].loop,!1):this.animations.add(e[c].id,Phaser.Animation.generateFrameNames(e[c].name,e[c].start,e[c].stop,".png",4),12,e[c].loop,!1),e[c].onComplete&&d.onComplete.add(function(){this.caller.callFunction(e[this.stateNum].onComplete,e[this.stateNum].onCompleteParams)},{stateNum:c,caller:this})}}this.changeState(this.actor&&""!=this.actor.getValue("state")?this.actor.getValue("state"):this.jsondata.state),this.eventDispatcher&&this.eventDispatcher.doAction("OnActivate"),this.currentTile=this.maingame.hexHandler.checkHex(this.x,this.y)},InteractiveObject.prototype.finalSetup=function(){},InteractiveObject.prototype.changeState=function(a){if(this.hasstates){var b=this.animations.getAnimation(a);b?(this.animations.play(a),this.actor&&this.actor.updateValue("state",a),this.jsondata.state=a):console.log(this,a,"state doesn't exist.")}else this.jsondata.state=a},InteractiveObject.prototype.testTHISValues=function(a,b,c){var d=this[a];return(null==d||void 0==d)&&(d=this.jsondata[a]),"Is"==b?d==c:"IsNot"==b?d!=c:"Less"==b?c>d:"Greater"==b?d>c:"LessEqual"==b?c>=d:"GreaterEqual"==b?d>=c:!1},InteractiveObject.prototype.callFunction=function(a,b){var c=this[a];b=b.split(","),"function"==typeof c&&c.apply(this,b)},InteractiveObject.prototype.moveto=function(a,b){if(null!=a)var c=this.maingame.hexHandler.getTileByCords(a,b);if(c){var d=this.maingame.hexHandler.checkHex(this.x,this.y);d.changeWalkable(!0),this.x=c.x,this.y=c.y,c.changeWalkable(!1),this.updateLocation(c)}this.handleOut()},InteractiveObject.prototype.areWeNeighbours=function(a){if(this.footprint)for(var b=0;b<this.footprint.length;b++){if(a==this.footprint[b])return!0;if(this.maingame.hexHandler.areTilesNeighbors(this.footprint[b],a))return!0}return a==this.currentTile?!0:this.maingame.hexHandler.areTilesNeighbors(this.currentTile,a)?!0:!1},InteractiveObject.prototype.updateLocation=function(a){this.jsondata.x=a.posx,this.jsondata.y=a.posy},InteractiveObject.prototype.destroySelf=function(){this.jsondata.destroyed=!0,this.eventDispatcher.destroy(),this.events.onInputUp.remove(this.handleClick,this),this.events.onInputOver.remove(this.handleOver,this),this.events.onInputOut.remove(this.handleOut,this),this.destroy()},InteractiveObject.prototype.handleOver=function(){this.tint=65535,""!=this.jsondata.displayName&&this.maingame.showRollover(this)},InteractiveObject.prototype.handleOut=function(){this.tint=16777215,this.maingame.rollovertext&&(this.maingame.rollovertext.visible=!1)},InteractiveObject.prototype.setWalkable=function(a){if(this.footprint)for(var b=0;b<this.footprint.length;b++)this.footprint[b].changeWalkable(a);else this.currentTile.changeWalkable(a)},InteractiveObject.prototype.step=function(){},InteractiveObject.prototype.setupReactToAction=function(){this.events.onInputUp.add(this.handleClick,this),this.events.onInputOver.add(this.handleOver,this),this.events.onInputOut.add(this.handleOut,this)},InteractiveObject.prototype.handleClick=function(){GlobalEvents.currentacion!=GlobalEvents.WALK&&(GlobalEvents.currentacion==GlobalEvents.TOUCH?this.eventDispatcher.doAction("OnTouch"):GlobalEvents.currentacion==GlobalEvents.LOOK?this.eventDispatcher.doAction("OnLook"):GlobalEvents.currentacion==GlobalEvents.TALK?this.eventDispatcher.doAction("OnTalk"):GlobalEvents.currentacion==GlobalEvents.ITEM&&this.eventDispatcher.doAction("OnUseItem"),this.handleOut())},InteractiveObject.prototype.setupArt=function(){{var a=this.maingame.getTile(this.jsondata.name,this.jsondata.tilesetid),b=this.jsondata.x||0,c=this.jsondata.y||0;this.jsondata.offsetx||.5,this.jsondata.offsetx||.5,this.maingame.hexHandler.getTileByCords(b,c)}Phaser.Sprite.call(this,this.game,b+16,-1*c+16,a.spritesheet,a.tile+".png"),this.maingame.objectGroup.add(this),this.anchor.x=.5,this.anchor.y=1};var InventoryGraphics=function(a,b,c){Phaser.Group.call(this,a,null),this.startx=0,this.starty=0,this.iwidth=250,this.iheight=40,this.numrows=1,this.numcolumns=5,this.game=a,this.maingame=b,this.globalhandler=c;var d=this.game.make.sprite(0,0,"dialogui","inventory_bg.png");this.add(d),this.currentitems=[];var e=this.globalhandler.items;if(e)for(var f=0;f<e.length;f++){var g=e[f];null!=g&&(g.OnChangeSignal.add(this.makeReturn(g),this),g.getValue("Inventory")&&this.addInventoryGraphic(g))}};InventoryGraphics.prototype=Object.create(Phaser.Group.prototype),InventoryGraphics.constructor=InventoryGraphics,InventoryGraphics.prototype.makeReturn=function(a){return function(){this.itemChanged(a)}},InventoryGraphics.prototype.itemChanged=function(a){if(null!=a){var b=a.getValue("Inventory"),c=this.findItem(a);b&&-1==c?this.addInventoryGraphic(a):!b&&c>-1&&(this.destroyGraphicItem(this.currentitems[c]),
this.currentitems.splice(c,1),this.resuffle())}},InventoryGraphics.prototype.findItem=function(a){for(var b=0;b<this.currentitems.length;b++)if(this.currentitems[b].item.id==a.id)return b;return-1},InventoryGraphics.prototype.updateSelf=function(){console.log("do graphics")},InventoryGraphics.prototype.destroyGraphicItem=function(a){null!=a&&a.destroy()},InventoryGraphics.prototype.addInventoryGraphic=function(a){var b=new InventoryObject(this.game,"dialogui",a.getValue("InventoryGraphicName")+".png",a);this.add(b),this.currentitems.push(b),this.resuffle()},InventoryGraphics.prototype.resuffle=function(){for(var a=(this.iwidth-this.startx)/this.numcolumns,b=0;b<this.currentitems.length;b++)this.currentitems[b].x=this.startx+b*a,this.currentitems[b].y=this.starty};var InventoryObject=function(a,b,c,d){Phaser.Image.call(this,a,0,0,b,c),this.item=d,this.events.onInputDown.add(this.handleClick,this),this.inputEnabled=!0};InventoryObject.prototype=Object.create(Phaser.Image.prototype),InventoryObject.constructor=InventoryObject,InventoryObject.prototype.handleClick=function(){GlobalEvents.currentacion=GlobalEvents.ITEM,GlobalEvents.selectedItem=this.item},BasicGame.Game=function(){this.playerCharacter,this.playerHex,this.diagpanel,this.justTextPopup,this.barkHandler,this.activeButtons,this.neighborLights=[],this.hexHandler,this.highlightHex,this.pathfinder,this.graphics,this.mapGroup,this.uiGroup,this.objectGroup,this.highlightGroup,this.hexagonGroup,this.interactiveObjects=[],this.startpos,this.mapData,this.globalHandler,this.inventory,this.walkableArray,this.maskableobjects,this.updatewalkable=!1,this.fps,this.tiletest,this.masker,this.movementgrid,this.spritegrid,this.rollovertext,this.highlightArray,this.dragScreen=!1,this.dragPoint=new Point(0,0)},BasicGame.Game.prototype={preload:function(){this.load.json("map","assets/forestmap.json")},create:function(){this.stage.backgroundColor="#444444",this.pathfinder=this.game.plugins.add(Phaser.Plugin.PathFinderPlugin),this.interactiveObjects=[],this.uiGroup=this.add.group(),this.mapData=this.game.cache.getJSON("map"),this.globalHandler=new GlobalHandler(this.game,this,this.mapData.data.Actors,this.mapData.data.Variables,null,this.mapData.data.Items),this.startpos=this.mapData.startPos;var a=this.mapData.maps[this.startpos.map];this.createMapTiles(a),this.dialoghandler=new DialogHandler(this.game,this,this.mapData.data.Conversations,this.mapData.data.Actors),this.diagpanel=new DialogPanel(this.game,this,this.dialoghandler),this.game.add.existing(this.diagpanel),this.uiGroup.add(this.diagpanel),this.diagpanel.setup(),this.justTextPopup=new JustTextPopup(this.game,this,this.dialoghandler),this.game.add.existing(this.justTextPopup),this.uiGroup.add(this.justTextPopup),this.barkHandler=new BarkTextHandler(this.game,this),this.game.add.existing(this.barkHandler),this.uiGroup.add(this.barkHandler),this.rollovertext=this.game.make.bitmapText(0,0,"badabb","Text goes here.",25),this.rollovertext.visible=!1,this.game.add.existing(this.rollovertext),this.uiGroup.add(this.rollovertext),this.inventory=new InventoryGraphics(this.game,this,this.globalHandler),this.game.add.existing(this.inventory),this.uiGroup.add(this.inventory),this.inventory.x=350,this.inventory.y=400,this.input.addMoveCallback(this.onMove,this),this.input.onDown.add(this.doDragScreen,this),this.input.onUp.add(this.clickedHex,this),this.activeButtons=new ActionButtons(this.game,this),this.activeButtons.y=400,this.game.add.existing(this.activeButtons),this.uiGroup.add(this.activeButtons),this.graphics=this.game.add.graphics(0,0),this.uiGroup.add(this.graphics)},createMapTiles:function(a){var b=[],c=[];this.interactiveObjects=[],this.objectGroup=this.add.group(),this.highlightGroup=this.add.group(),this.hexagonGroup=this.add.group(),this.mapGroup=this.add.group(),this.mapGroup.add(this.hexagonGroup),this.mapGroup.add(this.highlightGroup),this.mapGroup.add(this.objectGroup),this.uiGroup.parent.bringToTop(this.uiGroup),this.maskableobjects=[],this.walkableArray=[];for(var d=0;d<a.length;d++){var e=a[d];e.handleMovement&&(this.hexHandler=new DiamondHexHandler(this,this.game,e.hexWidth,e.hexHeight));{var f=e.hexWidth,g=e.hexHeight,h=e.height,i=e.width,j=e.data,k=e.tilesetid;e.offsetx||0,e.offsety||0}e.handleMovement&&(this.movementgrid=new Grid(e)),e.handleSprite&&(this.spritegrid=new Grid(e));var l,m,n,o=new Point(0,0);if(e.handleSprite)for(var p=0;i>p;p++){e.handleMovement&&(b[p]=[]);for(var q=0;h>q;q++)l=j[q*i+p],m=this.getTile(l,k),o=this.spritegrid.GetMapCoords(p,q),e.handleMovement?(n=new WalkableTile(this,m.tile+".png",m.spritesheet,p,q,o.x,o.y,this),b[p][q]=n):n=new GraphicTile(this,m.tile+".png",m.spritesheet,p,q,o.x,o.y,this),this.hexagonGroup.add(n)}if(highlightArray=[],e.handleMovement)for(var p=0;i>p;p++){e.handleSprite||(b[p]=[],highlightArray[p]=[]),this.walkableArray[p]=[];for(var q=0;h>q;q++){if(this.walkableArray[p][q]=e.walkable[q*i+p],!e.handleSprite&&(o=this.movementgrid.GetMapCoords(p,q),b[p][q]=new SimpleTile(this,p,q,o.x,o.y),this.game.global.showmovetile)){var r=new GraphicTile(this,"tile_highlight0002.png","tiles2",p,q,o.x,o.y,this);0==this.walkableArray[p][q]&&(r.tint=16711680),highlightArray[p][q]=r,this.highlightGroup.add(r),this.addLocationTextToTile(o.x,o.y,f,g,p,q)}0==this.walkableArray[p][q]&&(b[p][q].walkable=!1)}}if(e.objects)for(var s,t,u=e.objects,p=0;p<u.length;p++)if(u[p].triggers){if(!u[p].destroyed){var v=new InteractiveObject(this,u[p]);this.interactiveObjects.push(v),v.posx=u[p].posx,v.posy=u[p].posy}}else{var w=this.getTile(u[p].name,u[p].tilesetid);s=u[p].x,t=u[p].y;var x=new SimpleObject(this.game,u[p].x+16,-1*u[p].y+16,w.spritesheet,w.tile+".png");x.posx=u[p].posx,x.posy=u[p].posy,this.objectGroup.add(x),x.anchor.x=.5,x.anchor.y=1,u[p].maskable&&this.maskableobjects.push(x)}var y=e.actionSpots;if(y)for(var p=0;p<y.length;p++){var z=b[y[p].x][y[p].y];z&&(z.eventDispatcher||(z.eventDispatcher=new EventDispatcher(this.game,this,z)),z.eventDispatcher.receiveData(y[p].triggers))}}this.hexHandler.hexagonArray=b,this.hexHandler.waterTilesArray=c,this.mapGroup.y=(440-g*Math.ceil(h/2))/2,this.mapGroup.x=0,this.highlightHex=new HighlightHex(this.game,this,this.hexHandler),this.highlightHex.setup(),this.highlightGroup.add(this.highlightHex);for(var p=0;p<this.interactiveObjects.length;p++)this.interactiveObjects[p]&&this.interactiveObjects[p].dosetup();this.playerCharacter||(this.playerCharacter=new PlayerCharacter(this,this.mapData.Player),this.game.add.existing(this.playerCharacter),this.playerCharacter.setLocationByTile(b[this.startpos.x][this.startpos.y])),this.objectGroup.add(this.playerCharacter),this.pathfinder.setGrid(this.walkableArray,[1]),this.masker=new CheapMasker(this.game,this,this.maskableobjects),this.hexagonGroup.sort("y",Phaser.Group.SORT_ASCENDING)},customSortHexOffsetIso:function(a,b){if(b.IsPlayer||a.IsPlayer,a.posy==b.posy){if(a.posx<b.posx)return 1;if(a.posx>b.posx)return-1;if(a.y<b.y)return-1;if(a.y>b.y)return 1}else{if(a.posy<b.posy)return-1;if(a.posy>b.posy)return 1}return 0},addLocationTextToTile:function(a,b,c,d,e,f){var g=this.add.text(a+c/4,b+3,e+","+f);g.font="arial",g.fontSize=8,this.highlightGroup.add(g)},setChangeMapTile:function(a){var b=this.game.make.sprite(0,0,"tiles","mapexit.png");a.addChild(b)},userExit:function(a){this.startpos.map=a.tmap,this.startpos.x=a.tx,this.startpos.y=a.ty,this.flushEntireMap();var b=this.mapData.maps[this.startpos.map];GlobalEvents.flushEvents(),this.createMapTiles(b)},flushEntireMap:function(){this.interactiveObjects=[],this.hexagonGroup.removeAll(!0),this.highlightGroup.removeAll(!0),this.objectGroup.removeAll(!0),this.playerCharacter=null,this.hexHandler.flush()},update:function(){var a=this.game.time.elapsed;this.hexHandler.update(a),this.game.global.pause||this.playerCharacter.step(a),this.objectGroup.customSort(this.customSortHexOffsetIso),this.updatewalkable&&(this.pathfinder.setGrid(this.walkableArray,[1]),this.updatewalkable=!1,this.game.global.showmovetile&&this.refreshWalkablView()),this.barkHandler.step(a),this.masker.updateMasks(this.input.worldX-this.mapGroup.x,this.input.worldY-this.mapGroup.y)},showDialog:function(a){this.diagpanel.startDialog(a),GlobalEvents.tempDisableEvents(),this.pauseGame()},showJustText:function(a){this.justTextPopup.showText(a),GlobalEvents.tempDisableEvents(),this.pauseGame()},showBark:function(a,b){this.barkHandler.barkOverObject(a,b)},showRollover:function(a){this.rollovertext&&(this.rollovertext.text=a.jsondata.displayName,this.rollovertext.anchor.x=.5,this.rollovertext.x=a.x,this.rollovertext.y=a.y,this.rollovertext.visible=!0,this.rollovertext.y=a.y+a.height,this.rollovertext.tint=10066431)},moveToAction:function(a,b,c){this.playerCharacter.moveToObject(a,b,c)},pauseGame:function(){this.game.global.pause||(this.game.global.pause=!0)},unpauseGame:function(){this.game.global.pause&&(this.game.global.pause=!1,GlobalEvents.reEnableEvents())},quitGame:function(){this.state.start("MainMenu")},onMove:function(a,b,c){if(this.dragScreen){var d=this.dragPoint.x-b,e=this.dragPoint.y-c;return this.dragPoint.x=b,this.dragPoint.y=c,this.mapGroup.x-=d,void(this.mapGroup.y-=e)}if(GlobalEvents.currentacion==GlobalEvents.WALK&&!this.game.global.pause){var f=this.hexHandler.checkHex(this.input.worldX-this.mapGroup.x,this.input.worldY-this.mapGroup.y);this.highlightHex.highlighttilebytile(0,f)}},doDragScreen:function(a){this.dragScreen=!0,this.dragPoint.x=a.x,this.dragPoint.y=a.y},clickedHex:function(a){this.dragScreen=!1;var b=this.dragPoint.x-a.x,c=this.dragPoint.y-a.y;if(0==b&&0==c&&GlobalEvents.currentacion==GlobalEvents.WALK&&!this.game.global.pause){var d=this.hexHandler.checkHex(this.input.worldX-this.mapGroup.x,this.input.worldY-this.mapGroup.y);null!=d&&this.game.currentacion==this.game.WALK&&this.playerCharacter.moveto(d)}},getTile:function(a,b){return{tile:this.mapData.tileSets[b][a],spritesheet:this.mapData.tileSets[b].tileset}},refreshWalkablView:function(){for(var a=0;a<this.movementgrid.gridSizeX;a++)for(var b=0;b<this.movementgrid.gridSizeY;b++){var c=highlightArray[a][b];c.tint=0==this.walkableArray[a][b]?16711935:16777215}}};var Point=function(a,b){this.x=a,this.y=b},Map=function(a){this.maingame=a,this.game=a.game,this.walkableArray=[],this.interactiveObjectDatas=[]},Masker=function(a,b,c){this.game=a,this.maingame=b,this.maskedobjects=[],this.maskDistance=2e3,this.maskableobjects=c,this.mask=new Phaser.Image(a,0,0,"tiles2","box/seethrough.png")};Masker.prototype.createCircleMask=function(a){var b=this.game.add.graphics(0,0);return b.beginFill(4294967057),b.drawCircle(0,0,a),this.maingame.objectGroup.add(b),b},Masker.prototype.createRectMask=function(a,b,c,d){var e=this.game.add.graphics(0,0);return e.beginFill(0),e.drawRect(a,b,c/2,d),this.maingame.objectGroup.add(e),e},Masker.prototype.cleanUp=function(){},Masker.prototype.updateMasks=function(a,b){if(this.maskableobjects)for(var c,d=0;d<this.maskableobjects.length;d++)if(c=this.maskableobjects[d],null!=c)if(c.left<=a&&a<c.right&&c.top<=b&&b<c.bottom){if(null==this.maskedobjects[d]){var e=new MaskedObject,f=this.game.make.bitmapData(c.width,c.height),g=this.game.make.bitmapData(c.width,c.height);g.ctx.beginPath(),g.ctx.rect(0,0,c.width,c.height),g.ctx.fillStyle="#ffff00",g.ctx.fill(),g.draw(this.mask);var h=c.x,i=c.y;c.x=0,c.y=0,c.anchor.x=0,c.anchor.y=0,f.alphaMask(c,g),c.anchor.x=.5,c.anchor.y=1,e.thebitmapdata=f,e.object=c,e.image=new Phaser.Image(this.game,h,i,f),this.game.add.existing(e.image),e.image.anchor.x=.5,e.image.anchor.y=1,this.maingame.objectGroup.add(e.image),this.maskedobjects[d]=e,c.visible=!1,c.x=c.x,c.y=c.y}}else null!=this.maskedobjects[d]},Masker.prototype.fasterDistance=function(a,b,c,d){var e=a-c,f=b-d;return e*e+f*f};var MaskedObject=function(){this.thebitmapdata,this.object,this.image};MaskedObject.prototype.cleanup=function(){this.image&&(this.image.destroy(),this.thebitmapdata=null,this.object=null,this.image=null)};var MovingCharacter=function(a,b){InteractiveObject.call(this,a,b),this.oldTile=null,this.path=null,this.pathlocation=0,this.nextTile,this.prevx,this.prevy,this.dir=new Phaser.Point,this.walkspeed=.1875;var c=this.jsondata.triggers;this.actionsaftermove,this.objectmovingto,this.movingtotile=null;for(var d=0;d<c.length;d++)"mover"==c[d].type&&(this.walkspeed=c[d].walkSpeed)};MovingCharacter.prototype=Object.create(InteractiveObject.prototype),MovingCharacter.constructor=MovingCharacter,MovingCharacter.prototype.isMoving=function(){return 0==this.dir.x&&0==this.dir.y?!1:!0},MovingCharacter.prototype.setLocation=function(a,b){this.x=a,this.y=b},MovingCharacter.prototype.setLocationByTile=function(a){this.x=a.x+this.maingame.hexHandler.halfHex,this.y=a.y+this.maingame.hexHandler.halfHexHeight,this.oldTile=a,this.currentTile=a,this.updateLocation(a),this.findtile(),this.currentTile.changeWalkable(!1)},MovingCharacter.prototype.gotoAnotherMap=function(){},MovingCharacter.prototype.setDirection=function(){this.dir.x=this.nextTile.x+this.maingame.hexHandler.halfHex-this.x,this.dir.y=this.nextTile.y+this.maingame.hexHandler.halfHexHeight-this.y,this.dir.normalize()},MovingCharacter.prototype.setPath=function(a){a&&(a.length<=0||(null!=this.objectmovingto&&null!=this.objectmovingto.footprint&&(this.movingtotile=this.maingame.hexHandler.findClosesInPath(this.objectmovingto.currentTile,this.objectmovingto.footprint,a)),this.path=a,this.pathlocation=0,this.nextTile=a[this.pathlocation],this.setDirection(),this.animations.play("walk")))},MovingCharacter.prototype.moveToObject=function(a,b,c){this.objectmovingto=a,this.actionsaftermove=c,this.objectmovingto=a,this.moveto(b),this.actionsaftermove=c,this.objectmovingto=a},MovingCharacter.prototype.moveto=function(a){null!=a&&(null!=this.objectmovingto&&this.objectmovingto.areWeNeighbours(this.currentTile)?this.atTargetTile():(this.maingame.pathfinder.setCallbackFunction(this.movercallback,this),this.maingame.pathfinder.preparePathCalculation([this.currentTile.posx,this.currentTile.posy],[a.posx,a.posy]),this.maingame.pathfinder.calculatePath(),this.clearTargetTile(),this.movingtotile=a))},MovingCharacter.prototype.movercallback=function(a){a=a||[],a=this.maingame.hexHandler.pathCoordsToTiles(a),this.setPath(a)},MovingCharacter.prototype.atTargetTile=function(){this.actionsaftermove&&this.changeState("use")},MovingCharacter.prototype.clearTargetTile=function(){this.actionsaftermove=null,this.movingtotile=null,this.objectmovingto=null},MovingCharacter.prototype.findtile=function(){var a=this.maingame.spritegrid.PosToMap(this.x,this.y);this.posx=a.x,this.posy=a.y},MovingCharacter.prototype.doUse=function(){this.actionsaftermove&&this.eventDispatcher.completeAction(this.actionsaftermove,!0),this.clearTargetTile(),this.changeState("idle")},MovingCharacter.prototype.step=function(a){if(null==this.currentTile&&(this.currentTile=this.maingame.hexHandler.checkHex(this.x,this.y)),null==this.oldTile&&this.finalSetup(),null!=this.path&&this.path.length>0&&(this.currentTile=this.maingame.hexHandler.checkHex(this.x,this.y),this.oldTile!=this.currentTile&&(this.oldTile.changeWalkable(!0),this.oldTile=this.currentTile,this.currentTile.changeWalkable(!1)),null==this.currentTile,this.currentTile.posx==this.nextTile.posx&&this.currentTile.posy==this.nextTile.posy)){if(this.pathlocation++,this.pathlocation>=this.path.length){this.pathlocation=this.path.length;var b=this.currentTile.x+this.maingame.hexHandler.halfHex,c=this.currentTile.y+this.maingame.hexHandler.halfHexHeight,d=3;b-d<this.x&&b+d>this.x&&c-d<this.y&&c+d>this.y&&(this.x=b,this.y=c,this.path=null,this.dir.x=0,this.dir.y=0,this.currentTile.enterTile(),this.animations.play("idle"),null!=this.objectmovingto&&null!=this.currentTile&&this.objectmovingto.areWeNeighbours(this.currentTile)&&this.atTargetTile()),this.setDirection()}else this.nextTile=this.path[this.pathlocation],this.setDirection();this.updateLocation(this.currentTile)}var e=this.x+this.dir.x*this.walkspeed*a,f=this.y+this.dir.y*this.walkspeed*a;(this.prevx!=e||this.prevy!=f)&&(this.x=e,this.y=f,this.findtile(),this.prevx=this.x,this.prevy=this.y),this.dir.x<0?this.scale.x=-1:this.dir.x>0&&(this.scale.x=1)};var PlayerCharacter=function(a,b){MovingCharacter.call(this,a,b),this.IsPlayer=!0,this.dosetup()};PlayerCharacter.prototype=Object.create(MovingCharacter.prototype),PlayerCharacter.constructor=PlayerCharacter;var BasicGame={};BasicGame.Boot=function(){},BasicGame.Boot.prototype={init:function(){this.input.maxPointers=1,this.stage.disableVisibilityChange=!0,this.game.device.desktop?(this.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL,this.scale.setMinMax(480,260,1024,768),this.scale.pageAlignHorizontally=!0,this.scale.pageAlignVertically=!0):(this.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL,this.scale.setMinMax(480,260,1024,768),this.scale.pageAlignHorizontally=!0,this.scale.pageAlignVertically=!0,this.scale.forceOrientation(!0,!1),this.scale.setResizeCallback(this.gameResized,this))},preload:function(){this.load.atlasJSONHash("loadingScreen","assets/loading.png","assets/loading.json")},create:function(){this.state.start("Preloader")}},BasicGame.Instructions=function(){this.music=null,this.playButton=null},BasicGame.Instructions.prototype={create:function(){this.add.sprite(0,0,"instructions"),this.playButton=this.add.button(177,529,"ui",this.returnToMain,this,"OK Button0001.png","OK Button0002.png","OK Button0002.png","OK Button0001.png")},update:function(){},returnToMain:function(){this.state.start("MainMenu")}},BasicGame.MainMenu=function(){this.music=null,this.playButton=null},BasicGame.MainMenu.prototype={create:function(){this.add.sprite(0,0,"mainmenu"),this.playButton=this.add.button(376,425,"ui",this.startGame,this,"Play Button0001.png","Play Button0002.png","Play Button0002.png","Play Button0001.png"),this.playButton=this.add.button(376,487,"ui",this.gotoInstructions,this,"Instructions Button0001.png","Instructions Button0002.png","Instructions Button0002.png","Instructions Button0001.png")},update:function(){},startGame:function(){this.state.start("Game")},gotoInstructions:function(){this.state.start("Instructions")}},BasicGame.Preloader=function(){this.background=null,this.preloadBar=null,this.ready=!1},BasicGame.Preloader.prototype={preload:function(){this.background=this.add.sprite(0,0,"loadingScreen","bg.png"),this.preloadBar=this.add.sprite(0,278,"loadingScreen","loading_barfront.png"),this.load.atlasJSONHash("ui","assets/simpleui.png","assets/simpleui.json"),this.load.atlasJSONHash("tiles2","assets/tiles2.png","assets/tiles2.json"),this.load.atlasJSONHash("actors","assets/actors.png","assets/actors.json"),this.load.atlasJSONHash("dialogui","assets/dialogui.png","assets/dialogui.json"),this.load.image("loading","assets/loading.png"),this.load.image("mainmenu","assets/mainmenu.png"),this.load.image("mapselect","assets/mapselect.png"),this.load.image("winscreen","assets/winscreen.png"),this.load.image("instructions","assets/instructions.png"),this.load.bitmapFont("badabb","assets/fonts/badabb.png","assets/fonts/badabb.fnt")},create:function(){this.preloadBar.cropEnabled=!1,this.state.start("Game")}},BarkTextHandler=function(a,b){Phaser.Group.call(this,a),this.pool=new BasicObjectPool(this),this.game=a,this.maingame=b},BarkTextHandler.prototype=Object.create(Phaser.Group.prototype),BarkTextHandler.constructor=BarkTextHandler,BarkTextHandler.prototype.barkOverTile=function(){},BarkTextHandler.prototype.createItem=function(){var a=new BarkText(this.game,this);return this.add(a),a},BarkTextHandler.prototype.barkOverObject=function(a,b){for(var c=this.pool.allObjectsArray,d=0;d<c.length;d++)c[d].over==a&&null!=c[d].over&&c[d].killSelf();var e=this.pool.getObject();e.getReady(a,b),e.x=a.x,e.y=a.y,e.over=a,e.visible=!0},BarkTextHandler.prototype.returnBarkToPool=function(a){this.pool.returnObject(a)},BarkTextHandler.prototype.cleanupAllBarks=function(){for(var a=this.pool.allObjectsArray,b=0;b<a.length;b++)a[b].killSelf()},BarkTextHandler.prototype.step=function(a){for(var b=this.pool.allObjectsArray,c=0;c<b.length;c++)b[c].inUse&&b[c].step(a)},BarkText=function(a,b){Phaser.BitmapText.call(this,a,0,0,"badabb","Text goes here.",25),this.time,this.over,this.inUse=!1,this.handler=b,this.anchor.x=.5},BarkText.prototype=Object.create(Phaser.BitmapText.prototype),BarkText.constructor=BarkText,BarkText.prototype.step=function(a){this.time-=a,this.time<=0&&this.killSelf()},BarkText.prototype.killSelf=function(){this.handler.returnBarkToPool(this)},BarkText.prototype.getReady=function(a,b){this.text=b,this.time=3e3,this.over=a,this.inUse=!0,this.visible=!0},BarkText.prototype.reset=function(){this.time=-1,this.over=null,this.inUse=!1,this.visible=!1};var DialogPanel=function(a,b,c,d){Phaser.Group.call(this,a,d),this.overTint=16733440,this.maingame=b,this.dialogEngine=c};DialogPanel.prototype=Object.create(Phaser.Group.prototype),DialogPanel.constructor=DialogPanel,DialogPanel.prototype.setup=function(){this.setupBG("dialogui","dialog_main.png"),this.btnPlay1=this.setupButton(36.95,-22.4,"dialogui",this.play1,"dialog_10002.png","dialog_10001.png","dialog_10001.png","dialog_10002.png"),this.btnPlay2=this.setupButton(37.4,25.25,"dialogui",this.play2,"dialog_20002.png","dialog_20001.png","dialog_20001.png","dialog_20002.png"),this.btnPlay3=this.setupButton(35.95,45.8,"dialogui",this.play3,"dialog_30002.png","dialog_30001.png","dialog_30001.png","dialog_30002.png"),this.textMain=this.setupText(0,-60,"badabb","Text goes here.",25),this.btnPlay1.textRef=this.setupText(95,-10,"badabb","1. ",25),this.btnPlay2.textRef=this.setupText(95,35,"badabb","2. ",25),this.btnPlay3.textRef=this.setupText(95,82,"badabb","3. ",25),this.portrait1=null,this.portrait2=null,this.x=300,this.y=-1e3},DialogPanel.prototype.setupPortrait=function(a,b,c,d){var e=this.game.make.sprite(0,0,c,d);return this.add(e),e},DialogPanel.prototype.setupBG=function(a,b){var c=this.game.make.image(0,0,a,b);this.add(c)},DialogPanel.prototype.setupButton=function(a,b,c,d,e,f,g,h){var i=this.game.make.button(a,b,c,d,this,e,f,g,h);return this.add(i),i.events.onInputOver.add(this.buttonOver,this),i.events.onInputOut.add(this.buttonOut,this),i.input.useHandCursor=!0,i},DialogPanel.prototype.setupText=function(a,b,c,d,e){var f=this.game.make.bitmapText(a,b,c,d,e);return this.add(f),f},DialogPanel.prototype.buttonOver=function(a){a.textRef.tint=this.overTint},DialogPanel.prototype.buttonOut=function(a){a.textRef.tint=16777215},DialogPanel.prototype.play1=function(){this.dialogData=this.dialogData.links[0],this.nextDialog()},DialogPanel.prototype.play2=function(){this.dialogData=this.dialogData.links[1],this.nextDialog()},DialogPanel.prototype.play3=function(){this.dialogData=this.dialogData.links[2],this.nextDialog()},DialogPanel.prototype.justDoNext=function(){null==this.dialogData?this.endDialog():0==this.dialogData.links.length?(this.dialogData=null,this.endDialog()):(this.dialogData=this.dialogData.links[0],this.nextDialog())},DialogPanel.prototype.nextDialog=function(){this.dialogData=this.dialogEngine.getNextDialog(this.dialogData),null==this.dialogData?this.endDialog():this.setupDialog()},DialogPanel.prototype.setupDialog=function(){if(null==this.dialogData)return void console.log("dialog data not set");if(this.textMain.text=this.dialogData.actor.json.Name+": "+this.dialogData.current.DialogueText,null==this.portrait1?this.portrait1=this.setupPortrait(0,0,"actors",this.dialogData.actor.json.Pictures+".png"):this.portrait1.frameName!=this.dialogData.actor.json.Pictures&&(this.portrait1.frameName=this.dialogData.actor.json.Pictures+".png"),this.dialogData.links.length>1&&this.dialogData.links[0].Actor==this.dialogEngine.playerActor.id){for(var a=0;3>a;a++)null!=this.dialogData.links[a]&&this.dialogData.links[a].Actor==this.dialogEngine.playerActor.id?(this["btnPlay"+(a+1)].visible=!0,this["btnPlay"+(a+1)].textRef.visible=!0,this["btnPlay"+(a+1)].textRef.text=a+1+". "+this.dialogData.links[a].DialogueText,this["btnPlay"+(a+1)].textRef.tint=16777215):(this["btnPlay"+(a+1)].visible=!1,this["btnPlay"+(a+1)].textRef.visible=!1,this["btnPlay"+(a+1)].textRef.text="",this["btnPlay"+(a+1)].textRef.tint=16777215);this.game.input.onDown.remove(this.justDoNext,this)}else this.hideButtons(),this.game.input.onDown.add(this.justDoNext,this)},DialogPanel.prototype.hideButtons=function(){for(var a=0;3>a;a++)this["btnPlay"+(a+1)].visible=!1,this["btnPlay"+(a+1)].textRef.visible=!1,this["btnPlay"+(a+1)].textRef.text="",this["btnPlay"+(a+1)].textRef.tint=16777215},DialogPanel.prototype.startDialog=function(a){this.dialogData=this.dialogEngine.startConvo(a),console.log("start Dialog",a),this.dialogData&&(this.visible=!0,this.y=250,this.setupDialog())},DialogPanel.prototype.endDialog=function(){this.maingame.unpauseGame(),this.visible=!1,this.y=-1e3},JustTextPopup=function(a,b,c,d){Phaser.Group.call(this,a,d),this.bg=this.game.make.image(0,0,"actors","textBox.png"),this.add(this.bg),this.maingame=b,this.textMain=this.game.make.bitmapText(10,10,"badabb","Text goes here.",25),this.textMain.tint=65535,this.textMain.wordWrap=!0,this.textMain.wordWrapWidth=300,this.add(this.textMain),this.visible=!1},JustTextPopup.prototype=Object.create(Phaser.Group.prototype),JustTextPopup.constructor=JustTextPopup,JustTextPopup.prototype.showText=function(a){this.x=this.game.width/2-this.width/2,this.y=this.game.height/2-this.height/2,this.textMain.text=a,this.visible=!0,this.game.input.onDown.add(this.closePopup,this)},JustTextPopup.prototype.closePopup=function(){this.visible=!1,this.game.input.onDown.remove(this.closePopup,this),this.maingame.unpauseGame()};var EasyStar=EasyStar||{};"function"==typeof define&&define.amd&&define("easystar",[],function(){return EasyStar}),"undefined"!=typeof module&&module.exports&&(module.exports=EasyStar),EasyStar.Node=function(a,b,c,d,e){this.parent=a,this.x=b,this.y=c,this.costSoFar=d,this.simpleDistanceToTarget=e,this.bestGuessDistance=function(){return this.costSoFar+this.simpleDistanceToTarget}},EasyStar.Node.OPEN_LIST=0,EasyStar.Node.CLOSED_LIST=1,EasyStar.PriorityQueue=function(a,b){this.length=0;var c=[],d=!1;if(b==EasyStar.PriorityQueue.MAX_HEAP)d=!0;else{if(b!=EasyStar.PriorityQueue.MIN_HEAP)throw b+" not supported.";d=!1}this.insert=function(b){if(!b.hasOwnProperty(a))throw"Cannot insert "+b+" because it does not have a property by the name of "+a+".";c.push(b),this.length++,e(this.length-1)},this.getHighestPriorityElement=function(){return c[0]},this.shiftHighestPriorityElement=function(){if(0===this.length)throw"There are no more elements in your priority queue.";if(1===this.length){var a=c[0];return c=[],this.length=0,a}var b=c[0],d=c.pop();return this.length--,c[0]=d,f(0),b};var e=function(a){if(0!==a){var b=i(a);h(a,b)&&(g(a,b),e(b))}},f=function(a){var b=j(a),c=k(a);if(h(b,a))g(a,b),f(b);else if(h(c,a))g(a,c),f(c);else{if(0==a)return;f(0)}},g=function(a,b){var d=c[a];c[a]=c[b],c[b]=d},h=function(b,e){if(void 0===c[e]||void 0===c[b])return!1;var f,g;return"function"==typeof c[b][a]?(f=c[b][a](),g=c[e][a]()):(f=c[b][a],g=c[e][a]),d?f>g?!0:!1:g>f?!0:!1},i=function(a){return Math.floor(a/2)-1},j=function(a){return 2*a+1},k=function(a){return 2*a+2}},EasyStar.PriorityQueue.MAX_HEAP=0,EasyStar.PriorityQueue.MIN_HEAP=1,EasyStar.instance=function(){this.isDoneCalculating=!0,this.pointsToAvoid={},this.startX,this.callback,this.callbackObj,this.startY,this.endX,this.endY,this.nodeHash={},this.openList,this.endwalkable},EasyStar.js=function(){var a,b,c,d=10,e={},f={},g=[],h=Number.MAX_VALUE;this.setAcceptableTiles=function(a){a instanceof Array?c=a:!isNaN(parseFloat(a))&&isFinite(a)&&(c=[a])},this.setGrid=function(b){a=b;for(var c=0;c<a[0].length;c++)for(var d=0;d<a.length;d++)f[a[d][c]]||(f[a[d][c]]=1)},this.setTileCost=function(a,b){f[a]=b},this.setIterationsPerCalculation=function(a){h=a},this.avoidAdditionalPoint=function(a,b){e[a+"_"+b]=1},this.stopAvoidingAdditionalPoint=function(a,b){delete e[a+"_"+b]},this.stopAvoidingAllAdditionalPoints=function(){e={}},this.findPath=function(b,e,f,h,i,j){if(void 0===c)throw new Error("You can't set a path without first calling setAcceptableTiles() on EasyStar.");if(void 0===a)throw new Error("You can't set a path without first calling setGrid() on EasyStar.");if(0>b||0>e||0>f||0>f||b>a.length-1||e>a[0].length-1||f>a.length-1||h>a[0].length-1)throw new Error("Your start or end point is outside the scope of your grid.");if(b===f&&e===h)return void i.apply(j,[[]]);for(var l=a[f][h],m=!1,n=0;n<c.length;n++)if(l===c[n]){m=!0;break}var o=new EasyStar.instance;o.openList=new EasyStar.PriorityQueue("bestGuessDistance",EasyStar.PriorityQueue.MIN_HEAP),o.isDoneCalculating=!1,o.nodeHash={},o.startX=b,o.startY=e,o.endX=f,o.endY=h,o.callback=i,o.callbackObj=j,o.endwalkable=m,o.openList.insert(k(o,o.startX,o.startY,null,d)),g.push(o)},this.calculate=function(){if(0!==g.length&&void 0!==a&&void 0!==c)for(b=0;h>b;b++){if(0===g.length)return;if(0!==g[0].openList.length){var d=g[0].openList.shiftHighestPriorityElement();if(d.list=EasyStar.Node.CLOSED_LIST,d.x%2==1){if(i(d,0,-1))continue;if(i(d,-1,0))continue;if(i(d,0,1))continue;if(i(d,1,1))continue;if(i(d,1,0))continue;if(i(d,-1,1))continue}else{if(i(d,-1,-1))continue;if(i(d,-1,0))continue;if(i(d,0,1))continue;if(i(d,1,0))continue;if(i(d,0,-1))continue;if(i(d,1,-1))continue}}else g[0].callback.apply(g[0].callbackObj,[[]]),g.shift()}};var i=function(b,c,e){return b.x+c>-1&&b.x+c<a.length&&b.y+e>-1&&b.y+e<a[0].length&&j(g[0],b,c,e,d*f[a[b.x+c][b.y+e]]),g[0].isDoneCalculating===!0?(g.shift(),!0):!1},j=function(b,d,f,g,h){var i=d.x+f,j=d.y+g;if(void 0===e[i+"_"+j]){if(b.endX===i&&b.endY===j){b.isDoneCalculating=!0;var l=[],m=0;b.endwalkable&&(l[m]={x:i,y:j},m++),l[m]={x:d.x,y:d.y},m++;for(var n=d.parent;null!=n;)l[m]={x:n.x,y:n.y},m++,n=n.parent;l.reverse(),b.callback.apply(b.callbackObj,[l])}for(var o=0;o<c.length;o++)if(a[i][j]===c[o]){var p=k(b,i,j,d,h);void 0===p.list?(p.list=EasyStar.Node.OPEN_LIST,b.openList.insert(p)):p.list===EasyStar.Node.OPEN_LIST&&d.costSoFar+h<p.costSoFar&&(p.costSoFar=d.costSoFar+h,p.parent=d);break}}},k=function(a,b,c,d,e){if(void 0!==a.nodeHash[b+"_"+c])return a.nodeHash[b+"_"+c];var f=l(b,c,a.endX,a.endY);if(null!==d)var g=d.costSoFar+e;else g=f;var h=new EasyStar.Node(d,b,c,g,f);return a.nodeHash[b+"_"+c]=h,h},l=function(a,b,c,e){return Math.sqrt(Math.abs(c-a)*Math.abs(c-a)+Math.abs(e-b)*Math.abs(e-b))*d}},Phaser.Plugin.PathFinderPlugin=function(a){if("object"!=typeof EasyStar)throw new Error("Easystar is not defined!");this.parent=a,this._easyStar=new EasyStar.js,this._grid=null,this._callback=null,this._callbackObj=null,this._prepared=!1,this._walkables=[0]},Phaser.Plugin.PathFinderPlugin.prototype=Object.create(Phaser.Plugin.prototype),Phaser.Plugin.PathFinderPlugin.prototype.constructor=Phaser.Plugin.PathFinderPlugin,Phaser.Plugin.PathFinderPlugin.prototype.setGrid=function(a,b,c){c=c||null,this._grid=[];for(var d=0;d<a.length;d++){this._grid[d]=[];for(var e=0;e<a[d].length;e++)this._grid[d][e]=a[d][e]?a[d][e]:0}for(this._walkables=b,this._easyStar.setGrid(this._grid),this._easyStar.setAcceptableTiles(this._walkables),d=0;d<b.length;d++)this.setTileCost(b[d],1);null!==c&&this._easyStar.setIterationsPerCalculation(c)},Phaser.Plugin.PathFinderPlugin.prototype.setTileCost=function(a,b){this._easyStar.setTileCost(a,b)},Phaser.Plugin.PathFinderPlugin.prototype.setCallbackFunction=function(a,b){this._callback=a,this._callbackObj=b},Phaser.Plugin.PathFinderPlugin.prototype.preparePathCalculation=function(a,b){if(null===this._callback||"function"!=typeof this._callback)throw new Error("No Callback set!");var c=a[0],d=a[1],e=b[0],f=b[1];this._easyStar.findPath(c,d,e,f,this._callback,this._callbackObj),this._prepared=!0},Phaser.Plugin.PathFinderPlugin.prototype.calculatePath=function(){if(null===this._prepared)throw new Error("no Calculation prepared!");this._easyStar.calculate()};var SimpleObject=function(a,b,c,d,e){Phaser.Image.call(this,a,b,c,d,e),this.posx,this.posy;

};SimpleObject.prototype=Object.create(Phaser.Image.prototype),SimpleObject.constructor=SimpleObject;var Grid=function(a){this.width=a.hexWidth,this.height=a.hexHeight,this.gridSizeY=a.height,this.gridSizeX=a.width,this.offsetx=a.offsetx||0,this.offsety=a.offsety||0,this.type=a.tiletype,this.coords=new Point(0,0)};Grid.prototype.GetMapCoords=function(a,b){if("Hex"==this.type)this.coords.x=this.width*a,this.coords.x+=this.width/2*(b%2),this.coords.y=this.height/4*3*b;else if("HexIso"==this.type){var c=Math.floor(a/2);this.coords.x=this.width*a+this.width/2*b,this.coords.y=this.height/4*3*b,this.coords.x-=this.width/2*c,this.coords.y-=this.height/4*3*c}else"HexIsoFallout"==this.type?(this.coords.x=48*a+32*b,this.coords.y=-24*b+12*a,this.coords.y*=-1,this.coords.x+=16,this.coords.y-=4):(this.coords.x=0,this.coords.y=0);return this.coords},Grid.prototype.PosToMap=function(a,b){return"HexIsoFallout"==this.type?(a-=16,b+=4,a-=40,b-=16,b*=-1,i=(3*a+4*b)/192,j=(a-4*b)/128,this.coords.x=Math.round(i),this.coords.y=Math.round(j)):(this.coords.x=-1,this.coords.y=-1),this.coords};var SimpleTile=function(a,b,c,d,e){this.maingame=a,this.walkable=!0,this.openair=!0,this.x=d,this.y=e,this.posx=b,this.posy=c};SimpleTile.prototype.callFunction=function(a,b){var c=window[a];"function"==typeof c&&c.apply(null,b)},SimpleTile.prototype.changeWalkable=function(a){this.maingame.walkableArray[this.posx][this.posy]=1==a||"true"==a?1:0,this.walkable=a,this.maingame.updatewalkable=!0},SimpleTile.prototype.enterTile=function(){this.eventDispatcher&&this.eventDispatcher.doAction("OnEnter")};var GraphicTile=function(a,b,c,d,e,f,g,h){Phaser.Image.call(this,a,f,g,c,b),this.game=a,this.maingame=h};GraphicTile.prototype=Object.create(Phaser.Image.prototype),GraphicTile.constructor=GraphicTile;var BaseTile=function(a,b,c,d,e,f,g,h){Phaser.Sprite.call(this,a,f,g,c,b),this.game=a,this.maingame=h};BaseTile.prototype=Object.create(Phaser.Sprite.prototype),BaseTile.constructor=BaseTile,BaseTile.prototype.callFunction=function(a,b){var c=window[a];"function"==typeof c&&c.apply(null,b)},BaseTile.prototype.changeWalkable=function(a){this.maingame.walkableArray[this.posx][this.posy]=a?1:0,this.walkable=a,this.maingame.updatewalkable=!0};var WalkableTile=function(a,b,c,d,e,f,g,h){BaseTile.call(this,a,b,c,d,e,f,g,h),this.walkable=!0,this.openair=!0,this.posx=d,this.posy=e,this.eventDispatcher};WalkableTile.prototype=Object.create(BaseTile.prototype),WalkableTile.constructor=WalkableTile,WalkableTile.prototype.enterTile=function(){this.eventDispatcher&&this.eventDispatcher.doAction("OnEnter")};var WaterTile=function(a,b,c,d,e,f,g){Phaser.Sprite.call(this,a,f,g,c,b),this.game=a,this.posx=d,this.posy=e,this.walkable=!1,this.openair=!0,this.starty=g,this.wavemax=-5,this.maxoffsetmax=5,this.maxoffsetmin=0,this.speed=.003,this.direction=1,this.waveSpeed=0,this.y+=this.game.rnd.integerInRange(this.maxoffsetmin,this.maxoffsetmax),this.game.rnd.frac()<.5&&(this.direction=-1),this.level()};WaterTile.prototype=Object.create(Phaser.Sprite.prototype),WaterTile.constructor=WaterTile,WaterTile.prototype.level=function(){var a=this.y;a<this.starty+this.maxoffsetmin&&(this.direction=1),a>this.starty+this.maxoffsetmax&&(this.direction=-1,this.waveSpeed=0)},WaterTile.prototype.step=function(a){this.y+=this.y<this.starty+this.wavemax?this.direction*this.speed*a:this.direction*this.speed*a,this.game.rnd.frac()<.01&&(this.direction*=-1),this.level()},WaterTile.prototype.hitByWave=function(a){this.y+=a,this.starty+this.wavemax>this.tileImage&&(this.y=this.starty+this.wavemax),this.level()};